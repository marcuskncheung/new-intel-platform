{% extends "base.html" %}
{% block content %}
<style>
  body { background: #f5f8fa; }
  .analytics-pro-card {
    background: #fff;
    border-radius: 1.25rem;
    box-shadow: 0 4px 24px rgba(46,139,250,0.07);
    padding: 2.5rem 2.5rem 2rem 2.5rem;
    margin-top: 2.5rem;
    margin-bottom: 2.5rem;
    max-width: 950px;
    margin-left: auto;
    margin-right: auto;
  }
  .analytics-section-title {
    font-weight: 700;
    color: #1669d2;
    margin-bottom: 1.5rem;
    letter-spacing: 0.01em;
    font-size: 1.5rem;
  }
  .analytics-filters-row {
    margin-bottom: 1.5rem;
    align-items: end;
  }
  .analytics-filter-label {
    font-weight: 600;
    color: #0a2540;
    margin-right: 0.8rem;
  }
  .analytics-badge {
    display: inline-block;
    background: #e9f3ff;
    color: #1669d2;
    font-weight: 600;
    border-radius: 2rem;
    padding: 0.3em 1.1em;
    margin-right: 0.5em;
    margin-bottom: 0.5em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
  }
  .analytics-badge input[type=checkbox] {
    accent-color: #1669d2;
    margin-right: 0.5em;
  }
  .analytics-badge:hover {
    background: #d0eaff;
  }
  .analytics-card-chart {
    background: #fff;
    border-radius: 1.1rem;
    box-shadow: 0 2px 12px rgba(46,139,250,0.08);
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    margin-bottom: 1.5rem;
  }
  .analytics-label {
    font-weight: 600;
    color: #2e8bfa;
    margin-bottom: 0.3em;
  }
  @media (max-width: 700px) {
    .analytics-pro-card { padding: 1.2rem 0.7rem; }
    .analytics-card-chart { padding: 1rem 0.4rem; }
    .analytics-section-title { font-size: 1.1rem; }
  }
</style>
<div class="analytics-pro-card">
  <div class="analytics-section-title">Statistical Analysis (Analytics)</div>
  <form class="mb-3">
    <div class="row analytics-filters-row">
      <div class="col-md-6 mb-2">
        <span class="analytics-filter-label">Show Data Sources:</span>
        <label class="analytics-badge"><input type="checkbox" class="form-check-input me-1" id="filter-inbox" checked>Inbox</label>
        <label class="analytics-badge"><input type="checkbox" class="form-check-input me-1" id="filter-whatsapp" checked>WhatsApp</label>
        <label class="analytics-badge"><input type="checkbox" class="form-check-input me-1" id="filter-patrol" checked>Online Patrol</label>
        <label class="analytics-badge"><input type="checkbox" class="form-check-input me-1" id="filter-surveillance" checked>Surveillance</label>
      </div>
      <div class="col-md-3 mb-2">
        <label for="start-date" class="analytics-label">Start Date</label>
        <input type="date" id="start-date" class="form-control form-control-sm" />
      </div>
      <div class="col-md-3 mb-2">
        <label for="end-date" class="analytics-label">End Date</label>
        <input type="date" id="end-date" class="form-control form-control-sm" />
      </div>
    </div>
    <div class="row mb-2">
      <div class="col-md-3">
        <label for="chart-type" class="analytics-label">Chart Type</label>
        <select id="chart-type" class="form-select form-select-sm">
          <option value="bar">Bar</option>
          <option value="pie">Pie</option>
          <option value="doughnut">Doughnut</option>
        </select>
      </div>
    </div>
  </form>
  <div class="analytics-card-chart">
    <canvas id="analyticsChart" height="80"></canvas>
  </div>
  <div class="text-end text-muted" style="font-size:0.95em;">
    Last updated: <span id="analytics-last-updated"></span>
  </div>
  <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>
  <script>
const colorMap = ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1', '#ff9da7'];
const sourceMap = [
  {id: 'filter-inbox', label: 'Inbox', key: 'inbox_count'},
  {id: 'filter-whatsapp', label: 'WhatsApp', key: 'whatsapp_count'},
  {id: 'filter-patrol', label: 'Online Patrol', key: 'patrol_count'},
  {id: 'filter-surveillance', label: 'Surveillance', key: 'surveillance_count'}
];

function getSelectedSources() {
  return sourceMap.filter(src => document.getElementById(src.id).checked).map(src => src.key.replace('_count',''));
}
function getDateValue(id) {
  const val = document.getElementById(id).value;
  return val ? val : '';
}
function getChartType() {
  return document.getElementById('chart-type').value;
}

let analyticsChart = null;

async function fetchAndRenderAnalytics() {
  const sources = getSelectedSources();
  const start_date = getDateValue('start-date');
  const end_date = getDateValue('end-date');
  const chartType = getChartType();
  const params = new URLSearchParams({
    sources: sources.join(','),
    start_date,
    end_date
  });
  const resp = await fetch(`/api/analytics-data?${params.toString()}`);
  const data = await resp.json();
  let chartData, chartOptions;

  if (sources.length === 1 && sources[0] === 'whatsapp') {
    // WhatsApp breakdown by type
    const types = Object.keys(data.whatsapp_types || {});
    const counts = types.map(t => data.whatsapp_types[t]);
    chartData = {
      labels: types,
      datasets: [{
        label: 'WhatsApp Alleged Type',
        data: counts,
        backgroundColor: colorMap.slice(0, types.length)
      }]
    };
    chartOptions = {
      responsive: true,
      plugins: {
        legend: { display: true },
        title: {
          display: true,
          text: 'WhatsApp Alleged Types'
        }
      }
    };
  } else {
    // Show counts for selected sources
    const labels = sources.map(s => sourceMap.find(src => src.key.replace('_count','') === s).label);
    const counts = sources.map(s => data[`${s}_count`] || 0);
    chartData = {
      labels: labels,
      datasets: [{
        label: 'Entries',
        data: counts,
        backgroundColor: colorMap.slice(0, counts.length)
      }]
    };
    chartOptions = {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Entries by Source (Live Data)'
        }
      }
    };
  }
  // Destroy and re-create chart for type switch
  if (analyticsChart) analyticsChart.destroy();
  const ctx = document.getElementById('analyticsChart').getContext('2d');
  analyticsChart = new Chart(ctx, {
    type: getChartType(),
    data: chartData,
    options: chartOptions
  });
}

// Attach event listeners
['filter-inbox','filter-whatsapp','filter-patrol','filter-surveillance','start-date','end-date','chart-type'].forEach(id => {
  document.getElementById(id).addEventListener('change', fetchAndRenderAnalytics);
});
// Initial render
fetchAndRenderAnalytics();
// Update last updated time
document.getElementById('analytics-last-updated').textContent = new Date().toLocaleString();
</script>
</div>
{% endblock %}
