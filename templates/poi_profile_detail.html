{% extends "base.html" %}
{% block content %}
<style>
/* POI Profile Page - Clean Light Mode Only */
.poi-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.poi-stat-card {
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    color: white;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    height: 100%;
}

.poi-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.2);
}

.poi-stat-number {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1;
    margin: 1rem 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.poi-stat-icon {
    font-size: 3rem;
    opacity: 0.9;
}

.poi-stat-label {
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.poi-info-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    border: none;
}

.stat-email { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.stat-whatsapp { background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); }
.stat-patrol { background: linear-gradient(135deg, #ff9800 0%, #e65100 100%); }
.stat-surveillance { background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%); }
.stat-total { background: linear-gradient(135deg, #6610f2 0%, #520dc2 100%); }
.stat-cases { background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%); }
.stat-activity { background: linear-gradient(135deg, #20c997 0%, #17a589 100%); }
</style>

<div class="container-fluid py-4">
    
    <!-- Header Card -->
    <div class="poi-header">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div class="flex-grow-1 mb-3 mb-md-0">
                <div class="d-flex align-items-center mb-3">
                    <i class="bi bi-person-badge-fill" style="font-size: 3rem; margin-right: 1rem;"></i>
                    <div>
                        <h1 class="mb-1" style="font-size: 2.5rem; font-weight: 700;">{{ profile.poi_id }}</h1>
                        <h3 class="mb-0" style="font-weight: 500;">
                            {% if profile.name_english %}{{ profile.name_english }}{% endif %}
                            {% if profile.name_chinese %}
                                {% if profile.name_english %}<span style="opacity: 0.7;"> / </span>{% endif %}{{ profile.name_chinese }}
                            {% endif %}
                            {% if not profile.name_english and not profile.name_chinese %}
                                <span style="opacity: 0.7;">Name Not Specified</span>
                            {% endif %}
                        </h3>
                    </div>
                </div>
                
                <div class="d-flex flex-wrap gap-2 mb-3">
                    {% if profile.company %}
                    <span class="badge bg-light text-dark px-3 py-2" style="font-size: 0.9rem;">
                        <i class="bi bi-building"></i> {{ profile.company }}
                    </span>
                    {% endif %}
                    {% if profile.role %}
                    <span class="badge bg-light text-dark px-3 py-2" style="font-size: 0.9rem;">
                        <i class="bi bi-briefcase"></i> {{ profile.role }}
                    </span>
                    {% endif %}
                    {% if profile.license_number %}
                    <span class="badge bg-light text-dark px-3 py-2" style="font-size: 0.9rem;">
                        <i class="bi bi-card-checklist"></i> License: {{ profile.license_number }}
                    </span>
                    {% endif %}
                </div>
                
                <div class="d-flex flex-wrap gap-3" style="opacity: 0.9; font-size: 0.95rem;">
                    <div>
                        <i class="bi bi-circle-fill me-1 {% if profile.status == 'ACTIVE' %}text-success{% else %}text-light{% endif %}"></i>
                        <strong>Status:</strong> {{ profile.status }}
                    </div>
                    <div>
                        <i class="bi bi-robot me-1"></i>
                        <strong>Created By:</strong> {{ profile.created_by }}
                    </div>
                    <div>
                        <i class="bi bi-calendar-plus me-1"></i>
                        <strong>Created:</strong> {{ profile.created_at.strftime('%Y-%m-%d') if profile.created_at else 'N/A' }}
                    </div>
                </div>
            </div>
            
            <div class="text-end">
                <a href="{{ url_for('alleged_subject_list') }}" class="btn btn-light btn-lg me-2">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <form method="post" action="{{ url_for('delete_alleged_person_profile', profile_id=profile.id) }}"
                      onsubmit="return confirm('⚠️ DELETE PROFILE {{ profile.poi_id }}?\n\nThis will permanently remove this profile.\n\n⚠️ THIS CANNOT BE UNDONE!\n\nAre you sure?')"
                      style="display: inline;">
                    <button class="btn btn-danger btn-lg" type="submit">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Statistics Section -->
    <h4 class="mb-3" style="color: #333; font-weight: 600;">
        <i class="bi bi-graph-up-arrow me-2"></i>Cross-Source Intelligence Statistics
    </h4>
    
    <!-- Row 1: Source Counts -->
    <div class="row g-3 mb-3">
        <div class="col-lg-3 col-md-6">
            <div class="poi-stat-card stat-email">
                <i class="bi bi-envelope-fill poi-stat-icon"></i>
                <div class="poi-stat-number">{{ email_count if email_count is defined else (profile.email_count or 0) }}</div>
                <div class="poi-stat-label">Emails</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="poi-stat-card stat-whatsapp">
                <i class="bi bi-whatsapp poi-stat-icon"></i>
                <div class="poi-stat-number">{{ whatsapp_count if whatsapp_count is defined else (profile.whatsapp_count or 0) }}</div>
                <div class="poi-stat-label">WhatsApp</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="poi-stat-card stat-patrol">
                <i class="bi bi-shield-fill-check poi-stat-icon"></i>
                <div class="poi-stat-number">{{ patrol_count if patrol_count is defined else (profile.patrol_count or 0) }}</div>
                <div class="poi-stat-label">Patrol</div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="poi-stat-card stat-surveillance">
                <i class="bi bi-camera-video-fill poi-stat-icon"></i>
                <div class="poi-stat-number">{{ surveillance_count if surveillance_count is defined else (profile.surveillance_count or 0) }}</div>
                <div class="poi-stat-label">Surveillance</div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: Summary Stats -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="poi-stat-card stat-total">
                <i class="bi bi-bar-chart-fill poi-stat-icon"></i>
                <div class="poi-stat-number">{{ total_intelligence_count if total_intelligence_count is defined else (profile.total_mentions or 0) }}</div>
                <div class="poi-stat-label">Total Mentions</div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="poi-stat-card stat-cases">
                <i class="bi bi-folder-fill poi-stat-icon"></i>
                <div class="poi-stat-number">{{ profile.case_count or 0 }}</div>
                <div class="poi-stat-label">Cases Involved</div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="poi-stat-card stat-activity">
                <i class="bi bi-clock-history poi-stat-icon"></i>
                <div style="font-size: 1.8rem; font-weight: 700; margin: 1rem 0;">
                    {% if profile.last_activity_date %}
                        {{ profile.last_activity_date.strftime('%Y-%m-%d') }}
                    {% elif profile.last_mentioned_date %}
                        {{ profile.last_mentioned_date.strftime('%Y-%m-%d') }}
                    {% else %}
                        No Activity
                    {% endif %}
                </div>
                <div class="poi-stat-label">Last Activity</div>
            </div>
        </div>
    </div>
    
    <!-- Profile Information -->
    <div class="poi-info-card mb-4">
        <div class="card-header bg-primary text-white" style="border-radius: 15px 15px 0 0;">
            <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Profile Information</h5>
        </div>
        <div class="card-body p-4">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <th width="40%" class="text-muted">English Name:</th>
                            <td><strong>{{ profile.name_english or "N/A" }}</strong></td>
                        </tr>
                        <tr>
                            <th class="text-muted">Chinese Name:</th>
                            <td><strong>{{ profile.name_chinese or "N/A" }}</strong></td>
                        </tr>
                        <tr>
                            <th class="text-muted">License Number:</th>
                            <td>{{ profile.license_number or "N/A" }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless mb-0">
                        <tr>
                            <th width="40%" class="text-muted">Company:</th>
                            <td>{{ profile.company or "N/A" }}</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Role:</th>
                            <td>{{ profile.role or "N/A" }}</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Status:</th>
                            <td>
                                <span class="badge {% if profile.status == 'ACTIVE' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ profile.status }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <th class="text-muted">Created By:</th>
                            <td><span class="badge bg-info">{{ profile.created_by }}</span></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cross-Source Intelligence Timeline -->
    <div class="poi-info-card">
        <div class="card-header bg-dark text-white" style="border-radius: 15px 15px 0 0;">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Cross-Source Intelligence Timeline</h5>
        </div>
        <div class="card-body p-0">
            <ul class="nav nav-tabs border-bottom" role="tablist" style="padding: 1rem 1rem 0 1rem;">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#all-sources-tab" type="button">
                        <i class="bi bi-list-ul"></i> All Sources ({{ total_intelligence_count or 0 }})
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#email-tab" type="button">
                        <i class="bi bi-envelope"></i> Email ({{ email_count or 0 }})
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#whatsapp-tab" type="button">
                        <i class="bi bi-whatsapp"></i> WhatsApp ({{ whatsapp_count or 0 }})
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#patrol-tab" type="button">
                        <i class="bi bi-shield-check"></i> Patrol ({{ patrol_count or 0 }})
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#surveillance-tab" type="button">
                        <i class="bi bi-camera-video"></i> Surveillance ({{ surveillance_count or 0 }})
                    </button>
                </li>
            </ul>
            
            <div class="tab-content p-4">
                <!-- All Sources Tab -->
                <div class="tab-pane fade show active" id="all-sources-tab">
                    {% if all_intelligence and all_intelligence|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Date</th>
                                    <th width="12%">Source</th>
                                    <th width="18%">Reference</th>
                                    <th>Subject/Content</th>
                                    <th width="12%" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for intel in all_intelligence %}
                                <tr>
                                    <td>{{ intel.get('date').strftime('%Y-%m-%d') if intel.get('date') else 'N/A' }}</td>
                                    <td>
                                        {% if intel.get('source_type') == 'EMAIL' %}
                                            <span class="badge bg-primary"><i class="bi bi-envelope"></i> Email</span>
                                        {% elif intel.get('source_type') == 'WHATSAPP' %}
                                            <span class="badge bg-success"><i class="bi bi-whatsapp"></i> WhatsApp</span>
                                        {% elif intel.get('source_type') == 'PATROL' %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-shield"></i> Patrol</span>
                                        {% elif intel.get('source_type') == 'SURVEILLANCE' %}
                                            <span class="badge bg-danger"><i class="bi bi-camera-video"></i> Surveillance</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if intel.get('source_type') and intel.get('id') %}
                                            <span class="badge bg-info">{{ intel.get('source_type') }}-{{ intel.get('id') }}</span>
                                            {% if intel.get('case_int') %}
                                                <br><small class="text-muted">Case: {{ intel.get('case_int') }}</small>
                                            {% endif %}
                                        {% else %}
                                            <code>{{ intel.get('int_reference_number') or intel.get('reference') or 'N/A' }}</code>
                                        {% endif %}
                                    </td>
                                    <td>{{ intel.get('title') or intel.get('subject') or intel.get('summary') or intel.get('content', '')[:100] or 'No content' }}</td>
                                    <td class="text-center">
                                        {% if intel.get('source_type') == 'EMAIL' and intel.get('id') %}
                                            <a href="{{ url_for('int_source_email_detail', email_id=intel.get('id')) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        {% else %}
                                            <span class="text-muted small">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No intelligence records found for this profile.
                    </div>
                    {% endif %}
                </div>
                
                <!-- Email Tab -->
                <div class="tab-pane fade" id="email-tab">
                    {% if emails and emails|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Date</th>
                                    <th width="18%">Reference</th>
                                    <th>Subject</th>
                                    <th width="12%" class="text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for email in emails %}
                                <tr>
                                    <td>{{ email.get('date').strftime('%Y-%m-%d') if email.get('date') else 'N/A' }}</td>
                                    <td><code>{{ email.get('int_reference_number') or email.get('reference') }}</code></td>
                                    <td>{{ email.get('title') or email.get('subject') or email.get('summary') or 'No subject' }}</td>
                                    <td class="text-center">
                                        {% if email.get('id') %}
                                            <a href="{{ url_for('int_source_email_detail', email_id=email.get('id')) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        {% else %}
                                            <span class="text-muted small">—</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No email records for this profile.
                    </div>
                    {% endif %}
                </div>
                
                <!-- WhatsApp Tab -->
                <div class="tab-pane fade" id="whatsapp-tab">
                    {% if whatsapp and whatsapp|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Date</th>
                                    <th width="18%">Reference</th>
                                    <th>Content</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for msg in whatsapp %}
                                <tr>
                                    <td>{{ msg.get('date').strftime('%Y-%m-%d') if msg.get('date') else 'N/A' }}</td>
                                    <td><code>{{ msg.get('int_reference_number') }}</code></td>
                                    <td>{{ (msg.get('content', '')[:100] if msg.get('content') else 'No content') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No WhatsApp records for this profile.
                    </div>
                    {% endif %}
                </div>
                
                <!-- Patrol Tab -->
                <div class="tab-pane fade" id="patrol-tab">
                    {% if patrol and patrol|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Date</th>
                                    <th width="18%">Reference</th>
                                    <th>Content</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in patrol %}
                                <tr>
                                    <td>{{ entry.get('date').strftime('%Y-%m-%d') if entry.get('date') else 'N/A' }}</td>
                                    <td><code>{{ entry.get('int_reference_number') }}</code></td>
                                    <td>{{ (entry.get('content', '')[:100] if entry.get('content') else 'No content') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No patrol records for this profile.
                    </div>
                    {% endif %}
                </div>
                
                <!-- Surveillance Tab -->
                <div class="tab-pane fade" id="surveillance-tab">
                    {% if surveillance and surveillance|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="15%">Date</th>
                                    <th width="18%">Reference</th>
                                    <th>Content</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in surveillance %}
                                <tr>
                                    <td>{{ entry.get('date').strftime('%Y-%m-%d') if entry.get('date') else 'N/A' }}</td>
                                    <td><code>{{ entry.get('int_reference_number') }}</code></td>
                                    <td>{{ (entry.get('content', '')[:100] if entry.get('content') else 'No content') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>No surveillance records for this profile.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
</div>

{% endblock %}
