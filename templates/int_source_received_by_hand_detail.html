{% extends "base.html" %}

{% block title %}Received by Hand Intelligence Detail - Intelligence Platform{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); color: #fff;">
      <div>
        <h5 class="mb-0"><i class="bi bi-hand-index-thumb-fill"></i> Received by Hand Intelligence</h5>
        <small>Complainant: {{ entry.complaint_name or 'Unknown' }} | Created: {{ entry.received_time.strftime('%Y-%m-%d %H:%M') if entry.received_time else 'N/A' }}</small>
      </div>
      <div class="btn-group">
        <a href="{{ url_for('int_source') }}#received_by_hand" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back to Sources
        </a>
      </div>
    </div>
    <div class="card-body">
      
      <!-- üîó UNIFIED INT REFERENCE COMPONENT -->
      {% set source_type = "RECEIVED_BY_HAND" %}
      {% set source_id = entry.id %}
      {% set source_display_id = "RBH-" ~ entry.id %}
      {% set current_int_reference = int_reference or entry.int_reference or '' %}
      {% set update_url = url_for('update_received_by_hand_int_reference', entry_id=entry.id) %}
      {% include 'components/int_reference_component.html' with context %}

      <!-- Received by Hand Content Section -->
      <div class="card border-purple mb-4" style="border-color: #6c5ce7 !important;">
        <div class="card-header text-white" style="background: #6c5ce7;">
          <h5 class="mb-0"><i class="bi bi-hand-index-thumb-fill"></i> Entry Details</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('update_received_by_hand_details', entry_id=entry.id) }}" enctype="multipart/form-data">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Complainant Name:</strong></label>
                <input type="text" class="form-control" name="complaint_name" value="{{ entry.complaint_name or '' }}">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Received Time:</strong></label>
                <input type="datetime-local" class="form-control" name="received_time" 
                       value="{{ entry.received_time.strftime('%Y-%m-%dT%H:%M') if entry.received_time else '' }}">
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Source / How Received:</strong></label>
                <select name="source" class="form-select">
                  <option value="">Select Source...</option>
                  <option value="Walk-in" {% if entry.source == 'Walk-in' %}selected{% endif %}>Walk-in</option>
                  <option value="Mail" {% if entry.source == 'Mail' %}selected{% endif %}>Mail</option>
                  <option value="Fax" {% if entry.source == 'Fax' %}selected{% endif %}>Fax</option>
                  <option value="Counter" {% if entry.source == 'Counter' %}selected{% endif %}>Counter</option>
                  <option value="Other" {% if entry.source == 'Other' %}selected{% endif %}>Other</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label"><strong>Alleged Type:</strong></label>
                <input type="text" class="form-control" name="alleged_type" value="{{ entry.alleged_type or '' }}" placeholder="Type of allegation">
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><strong>Details:</strong></label>
              <textarea name="details" class="form-control" rows="3" placeholder="Brief description of the complaint...">{{ entry.details or '' }}</textarea>
            </div>
            
            <!-- File Upload Section -->
            <div class="mb-3">
              <label class="form-label"><strong>Upload Documents:</strong></label>
              <input type="file" class="form-control" name="documents[]" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <small class="text-muted">You can select multiple files (PDFs, Word docs, or images)</small>
            </div>
            
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-primary" style="background: #6c5ce7; border-color: #6c5ce7;">
                <i class="bi bi-save"></i> Save Changes
              </button>
            </div>
          </form>
          
          <!-- Existing Documents Display -->
          {% if documents and documents|length > 0 %}
          <hr class="my-4">
          <h6 class="mb-3"><i class="bi bi-file-earmark-text"></i> Attached Documents ({{ documents|length }})</h6>
          <div class="row">
            {% for doc in documents %}
            <div class="col-md-4 mb-3">
              <div class="card">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-text-fill fs-2 me-2 text-primary"></i>
                    <div class="flex-grow-1">
                      <strong>{{ doc.filename }}</strong><br>
                      <small class="text-muted">{{ doc.uploaded_at.strftime('%Y-%m-%d %H:%M') if doc.uploaded_at else '' }}</small>
                    </div>
                  </div>
                  <div class="mt-2">
                    <a href="{{ url_for('received_by_hand_document_download', document_id=doc.id) }}" class="btn btn-sm btn-primary">
                      <i class="bi bi-download"></i> Download
                    </a>
                    <form method="POST" action="{{ url_for('delete_received_by_hand_document', document_id=doc.id) }}" style="display: inline;">
                      <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this document?');">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Assessment Form -->
      <form method="POST" action="{{ url_for('update_received_by_hand_assessment', entry_id=entry.id) }}" class="mt-4" novalidate>
        <div class="card border-primary">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Assessment Details</h5>
          </div>
          <div class="card-body">
            <table class="table table-bordered align-middle">
              <tr>
                <td width="25%"><b>Date:</b></td>
                <td>{{ (entry.assessment_updated_at or entry.received_time).strftime("%Y-%m-%d %H:%M:%S") if (entry.assessment_updated_at or entry.received_time) else 'N/A' }}</td>
              </tr>
              <tr>
                <td><b>Preparer:</b></td>
                <td>
                  <select name="preparer" class="form-select">
                    <option value="">Select Preparer...</option>
                    <option value="Nicola" {% if entry.preparer == 'Nicola' %}selected{% endif %}>Nicola</option>
                    <option value="Erney" {% if entry.preparer == 'Erney' %}selected{% endif %}>Erney</option>
                    <option value="Alex" {% if entry.preparer == 'Alex' %}selected{% endif %}>Alex</option>
                    <option value="Queenie" {% if entry.preparer == 'Queenie' %}selected{% endif %}>Queenie</option>
                    <option value="Charlie" {% if entry.preparer == 'Charlie' %}selected{% endif %}>Charlie</option>
                    <option value="Eunice" {% if entry.preparer == 'Eunice' %}selected{% endif %}>Eunice</option>
                    <option value="Marcus" {% if entry.preparer == 'Marcus' %}selected{% endif %}>Marcus</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><b>Alleged Subject(s)</b></td>
                <td>
                  <div id="alleged-subjects">
                    {% if entry.alleged_subject_english or entry.alleged_subject_chinese %}
                      {% set english_names = entry.alleged_subject_english.split(',') if entry.alleged_subject_english else [] %}
                      {% set chinese_names = entry.alleged_subject_chinese.split(',') if entry.alleged_subject_chinese else [] %}
                      {% set max_len = [english_names|length, chinese_names|length] | max %}
                      
                      {% set license_numbers = [] %}
                      {% set intermediary_types = [] %}
                      {% if entry.license_numbers_json %}
                        {% set license_numbers = entry.license_numbers_json | from_json %}
                      {% endif %}
                      {% if entry.intermediary_types_json %}
                        {% set intermediary_types = entry.intermediary_types_json | from_json %}
                      {% endif %}
                      
                      {% for i in range(max_len) %}
                        <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">üìã Alleged Subject {{ loop.index }}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                              üóëÔ∏è Remove
                            </button>
                          </div>
                          
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">üìù English Name</label>
                              <input type="text" name="alleged_subjects_en[]" class="form-control" 
                                     value="{{ english_names[i].strip() if i < english_names|length else '' }}" 
                                     placeholder="Enter English name">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                              <input type="text" name="alleged_subjects_cn[]" class="form-control" 
                                     value="{{ chinese_names[i].strip() if i < chinese_names|length else '' }}"
                                     placeholder="Enter Chinese name">
                            </div>
                          </div>
                          
                          {% set has_license = i < license_numbers|length and license_numbers[i] %}
                          {% set license_type = intermediary_types[i] if i < intermediary_types|length else '' %}
                          {% set license_num = license_numbers[i] if i < license_numbers|length else '' %}
                          
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)" {% if has_license %}checked{% endif %}>
                              <label class="form-check-label">Is this an insurance intermediary?</label>
                            </div>
                          </div>
                          
                          <div class="insurance-fields" style="display: {% if has_license %}block{% else %}none{% endif %}; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div class="row">
                              <div class="col-6">
                                <label class="form-label">License Type:</label>
                                <select name="intermediary_type[]" class="form-select">
                                  <option value="">Select Type</option>
                                  <option value="Agent" {% if license_type == 'Agent' %}selected{% endif %}>Agent</option>
                                  <option value="Broker" {% if license_type == 'Broker' %}selected{% endif %}>Broker</option>
                                  <option value="Other" {% if license_type == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                              </div>
                              <div class="col-6">
                                <label class="form-label">License Number:</label>
                                <input type="text" name="license_numbers[]" class="form-control" value="{{ license_num }}" placeholder="Enter license number">
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    {% elif entry.alleged_person %}
                      {% set subjects = entry.alleged_person.split(',') %}
                      {% for subject in subjects %}
                        <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">üìã Alleged Subject {{ loop.index }}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                              üóëÔ∏è Remove
                            </button>
                          </div>
                          
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">üìù English Name</label>
                              <input type="text" name="alleged_subjects_en[]" class="form-control" value="{{ subject.strip() }}" placeholder="Enter English name">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                              <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                              <label class="form-check-label">Is this an insurance intermediary?</label>
                            </div>
                          </div>
                          
                          <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div class="row">
                              <div class="col-6">
                                <label class="form-label">License Type:</label>
                                <select name="intermediary_type[]" class="form-select">
                                  <option value="">Select Type</option>
                                  <option value="Agent">Agent</option>
                                  <option value="Broker">Broker</option>
                                  <option value="Other">Other</option>
                                </select>
                              </div>
                              <div class="col-6">
                                <label class="form-label">License Number:</label>
                                <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="text-primary mb-0">üìã Alleged Subject 1</h6>
                          <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)" disabled>
                            üóëÔ∏è Remove
                          </button>
                        </div>
                        
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label">üìù English Name</label>
                            <input type="text" name="alleged_subjects_en[]" class="form-control" placeholder="Enter English name">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                            <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
                          </div>
                        </div>
                        
                        <div class="mb-3">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                            <label class="form-check-label">Is this an insurance intermediary?</label>
                          </div>
                        </div>
                        
                        <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                          <div class="row">
                            <div class="col-6">
                              <label class="form-label">License Type:</label>
                              <select name="intermediary_type[]" class="form-select">
                                <option value="">Select Type</option>
                                <option value="Agent">Agent</option>
                                <option value="Broker">Broker</option>
                                <option value="Other">Other</option>
                              </select>
                            </div>
                            <div class="col-6">
                              <label class="form-label">License Number:</label>
                              <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="mt-3 text-center">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAllegedSubject()">
                      <i class="bi bi-plus-circle"></i> Add Another Alleged Subject
                    </button>
                  </div>
                </td>
              </tr>
              <tr>
                <td><b>Allegation Type:</b></td>
                <td>
                    {% set field_name = 'alleged_nature' %}
                    {% set current_value = entry.alleged_nature %}
                    {% include 'alleged_nature_multi_select.html' %}
                </td>
              </tr>
              <tr>
                <td><b>Allegation Summary:</b></td>
                <td>
                  <textarea name="allegation_summary" class="form-control" rows="4" placeholder="Detailed description of the allegation...">{{ entry.allegation_summary or '' }}</textarea>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="bg-light">
                  <h6 class="text-primary mb-0"><i class="bi bi-person-check"></i> Reviewer Section</h6>
                </td>
              </tr>
              <tr>
                <td><b>Reviewer Name:</b></td>
                <td>
                  <select name="reviewer_name" class="form-select">
                    <option value="">Select Reviewer...</option>
                    <option value="Nicola" {% if entry.reviewer_name == 'Nicola' %}selected{% endif %}>Nicola</option>
                    <option value="Erney" {% if entry.reviewer_name == 'Erney' %}selected{% endif %}>Erney</option>
                    <option value="Alex" {% if entry.reviewer_name == 'Alex' %}selected{% endif %}>Alex</option>
                    <option value="Queenie" {% if entry.reviewer_name == 'Queenie' %}selected{% endif %}>Queenie</option>
                    <option value="Charlie" {% if entry.reviewer_name == 'Charlie' %}selected{% endif %}>Charlie</option>
                    <option value="Eunice" {% if entry.reviewer_name == 'Eunice' %}selected{% endif %}>Eunice</option>
                    <option value="Marcus" {% if entry.reviewer_name == 'Marcus' %}selected{% endif %}>Marcus</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><b>Reviewer Comment:</b></td>
                <td>
                  <textarea name="reviewer_comment" class="form-control" rows="3" placeholder="Reviewer's comments...">{{ entry.reviewer_comment or '' }}</textarea>
                </td>
              </tr>
              <tr>
                <td><b>Reviewer Decision:</b></td>
                <td>
                  <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="reviewer_decision" value="agree" id="decision_agree" {% if entry.reviewer_decision == 'agree' %}checked{% endif %}>
                    <label class="btn btn-outline-success" for="decision_agree">
                      <i class="bi bi-check-circle"></i> Agree
                    </label>
                    
                    <input type="radio" class="btn-check" name="reviewer_decision" value="disagree" id="decision_disagree" {% if entry.reviewer_decision == 'disagree' %}checked{% endif %}>
                    <label class="btn btn-outline-danger" for="decision_disagree">
                      <i class="bi bi-x-circle"></i> Disagree
                    </label>
                    
                    <input type="radio" class="btn-check" name="reviewer_decision" value="pending" id="decision_pending" {% if entry.reviewer_decision == 'pending' or not entry.reviewer_decision %}checked{% endif %}>
                    <label class="btn btn-outline-warning" for="decision_pending">
                      <i class="bi bi-clock"></i> Pending
                    </label>
                  </div>
                </td>
              </tr>
            </table>
            
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i> Save Assessment
              </button>
              <a href="{{ url_for('int_source') }}#received_by_hand" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>
          </div>
        </div>
      </form>
      
      <!-- Delete Entry Section -->
      <div class="card border-danger mt-4">
        <div class="card-body text-center">
          <form method="POST" action="{{ url_for('delete_received_by_hand', entry_id=entry.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this entry? This cannot be undone.');">
            <button type="submit" class="btn btn-outline-danger">
              <i class="bi bi-trash"></i> Delete This Entry
            </button>
          </form>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
function toggleInsuranceFields(checkbox) {
    const row = checkbox.closest('.alleged-subject-row');
    const insuranceFields = row.querySelector('.insurance-fields');
    if (checkbox.checked) {
        insuranceFields.style.display = 'block';
    } else {
        insuranceFields.style.display = 'none';
        row.querySelector('select[name="intermediary_type[]"]').value = '';
        row.querySelector('input[name="license_numbers[]"]').value = '';
    }
}

function addAllegedSubject() {
    const container = document.getElementById('alleged-subjects');
    const rows = container.querySelectorAll('.alleged-subject-row');
    const newIndex = rows.length + 1;
    
    const newRow = document.createElement('div');
    newRow.className = 'alleged-subject-row mb-3 p-3 border rounded';
    newRow.style.backgroundColor = '#f8f9fa';
    newRow.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-primary mb-0">üìã Alleged Subject ${newIndex}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                üóëÔ∏è Remove
            </button>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">üìù English Name</label>
                <input type="text" name="alleged_subjects_en[]" class="form-control" placeholder="Enter English name">
            </div>
            <div class="col-md-6">
                <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                <label class="form-check-label">Is this an insurance intermediary?</label>
            </div>
        </div>
        
        <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
            <div class="row">
                <div class="col-6">
                    <label class="form-label">License Type:</label>
                    <select name="intermediary_type[]" class="form-select">
                        <option value="">Select Type</option>
                        <option value="Agent">Agent</option>
                        <option value="Broker">Broker</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">License Number:</label>
                    <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(newRow);
    updateRemoveButtons();
}

function removeAllegedSubject(button) {
    const row = button.closest('.alleged-subject-row');
    row.remove();
    
    const container = document.getElementById('alleged-subjects');
    const rows = container.querySelectorAll('.alleged-subject-row');
    rows.forEach((row, index) => {
        row.querySelector('h6').textContent = `üìã Alleged Subject ${index + 1}`;
    });
    
    updateRemoveButtons();
}

function updateRemoveButtons() {
    const container = document.getElementById('alleged-subjects');
    const rows = container.querySelectorAll('.alleged-subject-row');
    rows.forEach((row, index) => {
        const removeBtn = row.querySelector('.remove-subject-btn');
        if (rows.length <= 1) {
            removeBtn.disabled = true;
        } else {
            removeBtn.disabled = false;
        }
    });
}
</script>

{% endblock %}
