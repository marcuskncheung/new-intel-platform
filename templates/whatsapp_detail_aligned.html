{% extends "base.html" %}

{% block title %}WhatsApp Intelligence Detail - Intelligence Platform{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: #25D366; color: #fff;">
      <div>
        <h5 class="mb-0"><i class="bi bi-whatsapp"></i> WhatsApp Intelligence</h5>
        <small>Contact: {{ entry.contact_name or entry.phone_number or 'Unknown' }} | Created: {{ entry.created_at.strftime('%Y-%m-%d %H:%M') if entry.created_at else 'N/A' }}</small>
      </div>
      <div class="btn-group">
        <a href="{{ url_for('int_source') }}#whatsapp" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back to Sources
        </a>
      </div>
    </div>
    <div class="card-body">
      
      <!-- üîó UNIFIED INT REFERENCE COMPONENT -->
      {% set source_type = "WHATSAPP" %}
      {% set source_id = entry.id %}
      {% set source_display_id = "WHATSAPP-" ~ entry.id %}
      {% set current_int_reference = get_case_int_reference(entry) or '' %}
      {% set update_url = url_for('update_whatsapp_int_reference', entry_id=entry.id) %}
      {% include 'components/int_reference_component.html' with context %}

      <!-- WhatsApp Content Section - SIMPLIFIED & EDITABLE -->
      <div class="card border-success mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-whatsapp"></i> WhatsApp Details</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('update_whatsapp_details', entry_id=entry.id) }}" enctype="multipart/form-data">
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label"><strong>Complaint Name:</strong></label>
                <input type="text" class="form-control" name="complaint_name" value="{{ entry.complaint_name or '' }}">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label"><strong>Phone Number:</strong></label>
                <input type="text" class="form-control" name="phone_number" value="{{ entry.phone_number or '' }}">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label"><strong>Received Time:</strong></label>
                <input type="datetime-local" class="form-control" name="received_time" 
                       value="{{ entry.received_time.strftime('%Y-%m-%dT%H:%M') if entry.received_time else '' }}">
              </div>
            </div>
            
            <!-- File Upload Section -->
            <div class="mb-3">
              <label class="form-label"><strong>Upload Photos/PDFs:</strong></label>
              <input type="file" class="form-control" name="files" multiple accept="image/*,.pdf">
              <small class="text-muted">You can select multiple files (images or PDFs)</small>
            </div>
            
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-success">
                <i class="bi bi-save"></i> Save Changes
              </button>
            </div>
          </form>
          
          <!-- Existing Files Display -->
          {% if images and images|length > 0 %}
          <hr class="my-4">
          <h6 class="mb-3"><i class="bi bi-images"></i> Uploaded Files ({{ images|length }})</h6>
          <div class="row">
            {% for image in images %}
            <div class="col-md-3 mb-3">
              <div class="card">
                <img src="{{ url_for('whatsapp_image_download', image_id=image.id) }}" 
                     class="card-img-top" 
                     alt="WhatsApp image" 
                     style="max-height: 200px; object-fit: cover; cursor: pointer;"
                     onclick="window.open(this.src, '_blank')">
                <div class="card-body p-2 text-center">
                  <form method="POST" action="{{ url_for('delete_whatsapp_file', file_id=image.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this file?');">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </form>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Assessment Form -->
      <form method="POST" action="{{ url_for('int_source_whatsapp_update_assessment', entry_id=entry.id) }}" class="mt-4" novalidate>
        <div class="card border-primary">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Assessment Details</h5>
          </div>
          <div class="card-body">
            <table class="table table-bordered align-middle">
              <tr>
                <td width="25%"><b>Date:</b></td>
                <td>{{ (entry.assessment_updated_at or entry.updated_at or entry.created_at).strftime("%Y-%m-%d %H:%M:%S") if (entry.assessment_updated_at or entry.updated_at or entry.created_at) else 'N/A' }}</td>
              </tr>
              <tr>
                <td><b>Preparer:</b></td>
                <td>
                  <select name="preparer" class="form-select">
                    <option value="">Select Preparer...</option>
                    <option value="Nicola" {% if entry.preparer == 'Nicola' %}selected{% endif %}>Nicola</option>
                    <option value="Erney" {% if entry.preparer == 'Erney' %}selected{% endif %}>Erney</option>
                    <option value="Alex" {% if entry.preparer == 'Alex' %}selected{% endif %}>Alex</option>
                    <option value="Queenie" {% if entry.preparer == 'Queenie' %}selected{% endif %}>Queenie</option>
                    <option value="Charlie" {% if entry.preparer == 'Charlie' %}selected{% endif %}>Charlie</option>
                    <option value="Eunice" {% if entry.preparer == 'Eunice' %}selected{% endif %}>Eunice</option>
                    <option value="Marcus" {% if entry.preparer == 'Marcus' %}selected{% endif %}>Marcus</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><b>Alleged Subject(s)</b></td>
                <td>
                  <div id="alleged-subjects">
                    {% if entry.alleged_subject_english or entry.alleged_subject_chinese %}
                      {% set english_names = entry.alleged_subject_english.split(',') if entry.alleged_subject_english else [] %}
                      {% set chinese_names = entry.alleged_subject_chinese.split(',') if entry.alleged_subject_chinese else [] %}
                      {% set max_len = [english_names|length, chinese_names|length] | max %}
                      
                      {# Parse saved license info from JSON #}
                      {% set license_numbers = [] %}
                      {% set intermediary_types = [] %}
                      {% if entry.license_numbers_json %}
                        {% set license_numbers = entry.license_numbers_json | from_json %}
                      {% endif %}
                      {% if entry.intermediary_types_json %}
                        {% set intermediary_types = entry.intermediary_types_json | from_json %}
                      {% endif %}
                      
                      {% for i in range(max_len) %}
                        <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">üìã Alleged Subject {{ loop.index }}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                              üóëÔ∏è Remove
                            </button>
                          </div>
                          
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">üìù English Name</label>
                              <input type="text" name="alleged_subjects_en[]" class="form-control" 
                                     value="{{ english_names[i].strip() if i < english_names|length else '' }}" 
                                     placeholder="Enter English name">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                              <input type="text" name="alleged_subjects_cn[]" class="form-control" 
                                     value="{{ chinese_names[i].strip() if i < chinese_names|length else '' }}"
                                     placeholder="Enter Chinese name">
                            </div>
                          </div>
                          
                          {# Get saved license info for this person #}
                          {% set has_license = i < license_numbers|length and license_numbers[i] %}
                          {% set license_type = intermediary_types[i] if i < intermediary_types|length else '' %}
                          {% set license_num = license_numbers[i] if i < license_numbers|length else '' %}
                          
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)" {% if has_license %}checked{% endif %}>
                              <label class="form-check-label">Is this an insurance intermediary?</label>
                            </div>
                          </div>
                          
                          <div class="insurance-fields" style="display: {% if has_license %}block{% else %}none{% endif %}; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div class="row">
                              <div class="col-6">
                                <label class="form-label">License Type:</label>
                                <select name="intermediary_type[]" class="form-select">
                                  <option value="">Select Type</option>
                                  <option value="Agent" {% if license_type == 'Agent' %}selected{% endif %}>Agent</option>
                                  <option value="Broker" {% if license_type == 'Broker' %}selected{% endif %}>Broker</option>
                                  <option value="Other" {% if license_type == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                              </div>
                              <div class="col-6">
                                <label class="form-label">License Number:</label>
                                <input type="text" name="license_numbers[]" class="form-control" value="{{ license_num }}" placeholder="Enter license number">
                              </div>
                            </div>
                          </div>
                          
                          <p class="text-muted mt-2 mb-0">
                            <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                          </p>
                        </div>
                      {% endfor %}
                    {% elif entry.alleged_person %}
                      {% set subjects = entry.alleged_person.split(',') %}
                      {% for subject in subjects %}
                        <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                          <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="text-primary mb-0">üìã Alleged Subject {{ loop.index }}</h6>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                              üóëÔ∏è Remove
                            </button>
                          </div>
                          
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">üìù English Name</label>
                              <input type="text" name="alleged_subjects_en[]" class="form-control" value="{{ subject.strip() }}" placeholder="Enter English name">
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                              <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
                            </div>
                          </div>
                          
                          <div class="mb-3">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                              <label class="form-check-label">Is this an insurance intermediary?</label>
                            </div>
                          </div>
                          
                          <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <div class="row">
                              <div class="col-6">
                                <label class="form-label">License Type:</label>
                                <select name="intermediary_type[]" class="form-select">
                                  <option value="">Select Type</option>
                                  <option value="Agent">Agent</option>
                                  <option value="Broker">Broker</option>
                                  <option value="Other">Other</option>
                                </select>
                              </div>
                              <div class="col-6">
                                <label class="form-label">License Number:</label>
                                <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                              </div>
                            </div>
                          </div>
                          
                          <p class="text-muted mt-2 mb-0">
                            <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                          </p>
                        </div>
                      {% endfor %}
                    {% else %}
                      <!-- Empty state - add first person -->
                      <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                          <h6 class="text-primary mb-0">üìã Alleged Subject 1</h6>
                          <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)" disabled>
                            üóëÔ∏è Remove
                          </button>
                        </div>
                        
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label">üìù English Name</label>
                            <input type="text" name="alleged_subjects_en[]" class="form-control" placeholder="Enter English name">
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                            <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
                          </div>
                        </div>
                        
                        <div class="mb-3">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                            <label class="form-check-label">Is this an insurance intermediary?</label>
                          </div>
                        </div>
                        
                        <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                          <div class="row">
                            <div class="col-6">
                              <label class="form-label">License Type:</label>
                              <select name="intermediary_type[]" class="form-select">
                                <option value="">Select Type</option>
                                <option value="Agent">Agent</option>
                                <option value="Broker">Broker</option>
                                <option value="Other">Other</option>
                              </select>
                            </div>
                            <div class="col-6">
                              <label class="form-label">License Number:</label>
                              <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                            </div>
                          </div>
                        </div>
                        
                        <p class="text-muted mt-2 mb-0">
                          <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                        </p>
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="mt-3 text-center">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addAllegedSubject()">
                      <i class="bi bi-plus-circle"></i> Add Another Alleged Subject
                    </button>
                  </div>
                </td>
              </tr>
              <tr>
                <td><b>Allegation Type:</b></td>
                <td>
                    {% set field_name = 'alleged_nature' %}
                    {% set current_value = entry.alleged_nature %}
                    {% include 'alleged_nature_multi_select.html' %}
                </td>
              </tr>
              <tr>
                <td><b>Allegation Summary:</b></td>
                <td>
                  <textarea name="allegation_summary" class="form-control" rows="4" placeholder="Detailed description of the allegation...">{{ entry.allegation_summary or '' }}</textarea>
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Provide a detailed summary of the allegation, including key facts and circumstances.
                  </small>
                </td>
              </tr>
              <tr>
                <td><b>Source Reliability (1-5):</b></td>
                <td>
                  <div class="btn-group" role="group">
                    {% for i in range(1, 6) %}
                      <input type="radio" class="btn-check" name="source_reliability" value="{{ i }}" id="reliability{{ i }}" {% if entry.source_reliability == i %}checked{% endif %}>
                      <label class="btn btn-outline-primary" for="reliability{{ i }}">{{ i }}</label>
                    {% endfor %}
                  </div>
                  <small class="text-muted d-block mt-2">
                    1 = Highly Unreliable | 5 = Highly Reliable
                  </small>
                </td>
              </tr>
              <tr>
                <td><b>Content Validity (1-5):</b></td>
                <td>
                  <div class="btn-group" role="group">
                    {% for i in range(1, 6) %}
                      <input type="radio" class="btn-check" name="content_validity" value="{{ i }}" id="validity{{ i }}" {% if entry.content_validity == i %}checked{% endif %}>
                      <label class="btn btn-outline-success" for="validity{{ i }}">{{ i }}</label>
                    {% endfor %}
                  </div>
                  <small class="text-muted d-block mt-2">
                    1 = Not Credible | 5 = Highly Credible
                  </small>
                </td>
              </tr>
              <tr>
                <td colspan="2" class="bg-light">
                  <h6 class="text-primary mb-0"><i class="bi bi-person-check"></i> Reviewer Section</h6>
                </td>
              </tr>
              <tr>
                <td><b>Reviewer Name:</b></td>
                <td>
                  <select name="reviewer_name" class="form-select">
                    <option value="">Select Reviewer...</option>
                    <option value="Nicola" {% if entry.reviewer_name == 'Nicola' %}selected{% endif %}>Nicola</option>
                    <option value="Erney" {% if entry.reviewer_name == 'Erney' %}selected{% endif %}>Erney</option>
                    <option value="Alex" {% if entry.reviewer_name == 'Alex' %}selected{% endif %}>Alex</option>
                    <option value="Queenie" {% if entry.reviewer_name == 'Queenie' %}selected{% endif %}>Queenie</option>
                    <option value="Charlie" {% if entry.reviewer_name == 'Charlie' %}selected{% endif %}>Charlie</option>
                    <option value="Eunice" {% if entry.reviewer_name == 'Eunice' %}selected{% endif %}>Eunice</option>
                    <option value="Marcus" {% if entry.reviewer_name == 'Marcus' %}selected{% endif %}>Marcus</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><b>Reviewer Comment:</b></td>
                <td>
                  <textarea name="reviewer_comment" class="form-control" rows="3" placeholder="Reviewer's comments...">{{ entry.reviewer_comment or '' }}</textarea>
                </td>
              </tr>
              <tr>
                <td><b>Reviewer Decision:</b></td>
                <td>
                  <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="reviewer_decision" value="agree" id="decision_agree" {% if entry.reviewer_decision == 'agree' %}checked{% endif %}>
                    <label class="btn btn-outline-success" for="decision_agree">
                      <i class="bi bi-check-circle"></i> Agree
                    </label>
                    
                    <input type="radio" class="btn-check" name="reviewer_decision" value="disagree" id="decision_disagree" {% if entry.reviewer_decision == 'disagree' %}checked{% endif %}>
                    <label class="btn btn-outline-danger" for="decision_disagree">
                      <i class="bi bi-x-circle"></i> Disagree
                    </label>
                    
                    <input type="radio" class="btn-check" name="reviewer_decision" value="pending" id="decision_pending" {% if entry.reviewer_decision == 'pending' or not entry.reviewer_decision %}checked{% endif %}>
                    <label class="btn btn-outline-warning" for="decision_pending">
                      <i class="bi bi-clock"></i> Pending
                    </label>
                  </div>
                </td>
              </tr>
            </table>
            
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-save"></i> Save Assessment
              </button>
              <a href="{{ url_for('int_source') }}#whatsapp" class="btn btn-secondary btn-lg">
                <i class="bi bi-x-circle"></i> Cancel
              </a>
            </div>
          </div>
        </div>
      </form>
      
    </div>
  </div>
</div>

<script>
// Toggle insurance intermediary fields
function toggleInsuranceFields(checkbox) {
    const row = checkbox.closest('.alleged-subject-row');
    const insuranceFields = row.querySelector('.insurance-fields');
    if (checkbox.checked) {
        insuranceFields.style.display = 'block';
    } else {
        insuranceFields.style.display = 'none';
        // Clear fields when unchecked
        row.querySelector('select[name="intermediary_type[]"]').value = '';
        row.querySelector('input[name="license_numbers[]"]').value = '';
    }
}

// Add new alleged subject
function addAllegedSubject() {
    const container = document.getElementById('alleged-subjects');
    const rows = container.querySelectorAll('.alleged-subject-row');
    const newIndex = rows.length + 1;
    
    const newRow = document.createElement('div');
    newRow.className = 'alleged-subject-row mb-3 p-3 border rounded';
    newRow.style.backgroundColor = '#f8f9fa';
    newRow.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-primary mb-0">üìã Alleged Subject ${newIndex}</h6>
            <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                üóëÔ∏è Remove
            </button>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">üìù English Name</label>
                <input type="text" name="alleged_subjects_en[]" class="form-control" placeholder="Enter English name">
            </div>
            <div class="col-md-6">
                <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                <label class="form-check-label">Is this an insurance intermediary?</label>
            </div>
        </div>
        
        <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
            <div class="row">
                <div class="col-6">
                    <label class="form-label">License Type:</label>
                    <select name="intermediary_type[]" class="form-select">
                        <option value="">Select Type</option>
                        <option value="Agent">Agent</option>
                        <option value="Broker">Broker</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">License Number:</label>
                    <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                </div>
            </div>
        </div>
        
        <p class="text-muted mt-2 mb-0">
            <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
        </p>
    `;
    
    container.appendChild(newRow);
}

// Remove alleged subject
function removeAllegedSubject(button) {
    const row = button.closest('.alleged-subject-row');
    const container = document.getElementById('alleged-subjects');
    const rows = container.querySelectorAll('.alleged-subject-row');
    
    // Don't allow removal if it's the only row
    if (rows.length <= 1) {
        alert('You must have at least one alleged subject.');
        return;
    }
    
    row.remove();
    
    // Renumber remaining rows
    container.querySelectorAll('.alleged-subject-row').forEach((row, index) => {
        row.querySelector('h6').textContent = `üìã Alleged Subject ${index + 1}`;
    });
}
</script>

<!-- Include Alleged Nature Multi-Select JavaScript -->
{% include 'alleged_nature_multi_select_js.html' %}

{% endblock %}
