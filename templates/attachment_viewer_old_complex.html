{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: #1669d2; color: #fff;">
      <div>
        <h5 class="mb-0">
          <i class="bi bi-paperclip me-2"></i>{{ attachment.filename }}
        </h5>
        <small>Size: {{ "%.2f"|format(file_size / 1024) }} KB | Type: {{ mimetype }}</small>
      </div>
      <div>
        <button onclick="saveAsFile()" class="btn btn-outline-light btn-sm me-2">
          <i class="bi bi-download"></i> Download
        </button>
        <button onclick="window.history.back()" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back
        </button>
      </div>
    </div>
    
    <div class="card-body">
      {% if file_extension in ['.pdf'] %}
        <!-- Universal PDF Viewer - ONE METHOD FOR ALL -->
        <div class="pdf-viewer-container">
          <!-- Simple Status Display -->
          {% if pdf_info and pdf_info.warnings %}
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i>
            <strong>PDF Info:</strong> File loaded successfully. If viewing issues occur, download button is available above.
          </div>
          {% endif %}
          
          <!-- Single Universal PDF Viewer -->
          <div class="universal-pdf-viewer">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-success">Universal PDF Viewer</span>
              <span class="badge bg-info">Works with All PDF Versions</span>
            </div>
          
          <!-- PDF Embed Method -->
          <div id="pdf-embed" class="pdf-viewer-method">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-primary">Method: Browser Embed</span>
              <span class="badge bg-info">Best for: Standard PDFs</span>
            </div>
            {% if file_base64 and file_size < 10485760 %}
            <!-- Enhanced embed with better error handling and multiple fallbacks -->
            <div class="pdf-embed-container" style="position: relative;">
              <embed id="pdf-embed-element"
                     src="data:{{ mimetype }};base64,{{ file_base64 }}" 
                     type="{{ mimetype }}" 
                     width="100%" 
                     height="600px" 
                     style="border: 1px solid #ddd;"
                     onload="handlePdfLoad('embed')"
                     onerror="handlePdfError('embed')">
              
              <!-- Fallback content for when embed fails -->
              <div id="embed-fallback" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #f8f9fa; border: 1px solid #ddd;">
                <div class="d-flex align-items-center justify-content-center h-100">
                  <div class="text-center">
                    <i class="bi bi-file-pdf fs-1 text-danger mb-3"></i>
                    <h5>PDF Embed Failed</h5>
                    <p class="text-muted">Browser embed method is not working for this PDF.</p>
                    <div class="btn-group">
                      <button class="btn btn-primary" onclick="showPdfObject()">Try Object View</button>
                      <button class="btn btn-secondary" onclick="showPdfIframe()">Try Frame View</button>
                      <button class="btn btn-success" onclick="loadWithPdfJs()">Use PDF.js</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="alert alert-warning text-center">
              <i class="bi bi-exclamation-triangle"></i>
              <h5>File too large for embed viewing</h5>
              <p>This file ({{ "%.2f"|format(file_size / 1024 / 1024) }} MB) is too large for browser embed method.</p>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="showPdfObject()">Try Object View</button>
                <button class="btn btn-secondary" onclick="loadWithPdfJs()">Use PDF.js Viewer</button>
                <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                   class="btn btn-success">
                  <i class="bi bi-download"></i> Download to View
                </a>
              </div>
            </div>
            {% endif %}
          </div>
          
          <!-- PDF Object Method -->
          <div id="pdf-object" class="pdf-viewer-method" style="display: none;">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-secondary">Method: Browser Object</span>
              <span class="badge bg-info">Best for: Complex PDFs</span>
            </div>
            {% if file_base64 and file_size < 15728640 %}
            <div class="pdf-object-container" style="position: relative;">
              <object id="pdf-object-element"
                      data="data:{{ mimetype }};base64,{{ file_base64 }}" 
                      type="{{ mimetype }}" 
                      width="100%" 
                      height="600px" 
                      style="border: 1px solid #ddd;"
                      onload="handlePdfLoad('object')"
                      onerror="handlePdfError('object')">
                <!-- Built-in fallback for object element -->
                <div class="text-center text-muted mt-4 p-4">
                  <i class="bi bi-exclamation-triangle fs-1"></i>
                  <h5 class="mt-3">PDF cannot be displayed using object method</h5>
                  <p>This PDF may have compatibility issues with this viewing method.</p>
                  <div class="btn-group">
                    <button class="btn btn-primary" onclick="showPdfIframe()">Try Frame View</button>
                    <button class="btn btn-success" onclick="loadWithPdfJs()">Use PDF.js</button>
                    <button class="btn btn-secondary" onclick="showPdfDownload()">Download Instead</button>
                  </div>
                </div>
              </object>
              
              <!-- External fallback overlay -->
              <div id="object-fallback" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248,249,250,0.95); border: 1px solid #ddd;">
                <div class="d-flex align-items-center justify-content-center h-100">
                  <div class="text-center">
                    <i class="bi bi-file-pdf fs-1 text-warning mb-3"></i>
                    <h5>Object Method Failed</h5>
                    <p class="text-muted">PDF could not be displayed using browser object element.</p>
                    <div class="btn-group">
                      <button class="btn btn-primary" onclick="showPdfIframe()">Try Frame View</button>
                      <button class="btn btn-success" onclick="loadWithPdfJs()">Use PDF.js</button>
                      <button class="btn btn-secondary" onclick="forceDirectDownload()">Download</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="alert alert-warning text-center">
              <i class="bi bi-exclamation-triangle"></i>
              <h5>File too large for object viewing</h5>
              <p>This file ({{ "%.2f"|format(file_size / 1024 / 1024) }} MB) is too large for object method.</p>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="loadWithPdfJs()">Use PDF.js Viewer</button>
                <button class="btn btn-secondary" onclick="showPdfIframe()">Try Frame View</button>
                <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                   class="btn btn-success">
                  <i class="bi bi-download"></i> Download to View
                </a>
              </div>
            </div>
            {% endif %}
          </div>
          
          <!-- PDF Iframe Method -->
          <div id="pdf-iframe" class="pdf-viewer-method" style="display: none;">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-warning">Method: Browser Frame</span>
              <span class="badge bg-info">Best for: Problematic PDFs</span>
            </div>
            {% if file_base64 and file_size < 20971520 %}
            <div class="pdf-iframe-container" style="position: relative;">
              <iframe id="pdf-iframe-element"
                      src="data:{{ mimetype }};base64,{{ file_base64 }}" 
                      width="100%" 
                      height="600px" 
                      style="border: 1px solid #ddd;"
                      onload="handlePdfLoad('iframe')"
                      onerror="handlePdfError('iframe')">
              </iframe>
              
              <!-- Fallback for iframe failures -->
              <div id="iframe-fallback" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(248,249,250,0.95); border: 1px solid #ddd;">
                <div class="d-flex align-items-center justify-content-center h-100">
                  <div class="text-center">
                    <i class="bi bi-file-pdf fs-1 text-info mb-3"></i>
                    <h5>Frame Method Failed</h5>
                    <p class="text-muted">PDF could not be displayed in iframe. This may be due to browser security restrictions.</p>
                    <div class="btn-group">
                      <button class="btn btn-success" onclick="loadWithPdfJs()">Use PDF.js Viewer</button>
                      <button class="btn btn-primary" onclick="showPdfLegacy()">Try Legacy Mode</button>
                      <button class="btn btn-secondary" onclick="showPdfDownload()">Download</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% else %}
            <div class="alert alert-warning text-center">
              <i class="bi bi-exclamation-triangle"></i>
              <h5>File too large for frame viewing</h5>
              <p>This file ({{ "%.2f"|format(file_size / 1024 / 1024) }} MB) is too large for iframe method.</p>
              <div class="btn-group">
                <button class="btn btn-success" onclick="loadWithPdfJs()">Use PDF.js Viewer</button>
                <button class="btn btn-primary" onclick="showPdfLegacy()">Try Legacy Mode</button>
                <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                   class="btn btn-secondary">
                  <i class="bi bi-download"></i> Download to View
                </a>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- NEW: PDF.js Viewer Method -->
          <div id="pdf-pdfjs" class="pdf-viewer-method" style="display: none;">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-success">Method: PDF.js Viewer</span>
              <span class="badge bg-info">Universal Compatibility</span>
            </div>
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle"></i>
              <strong>PDF.js Universal Viewer:</strong> This method uses Mozilla's PDF.js library for maximum compatibility with all PDF versions.
              <small class="d-block mt-1">Works with encrypted, large, and legacy PDFs that other methods cannot display.</small>
            </div>
            
            <div id="pdfjs-container" style="width: 100%; height: 650px; border: 1px solid #ddd; background: #f8f9fa; position: relative;">
              <div id="pdfjs-loading" class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center">
                  <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading PDF.js...</span>
                  </div>
                  <h5>Loading PDF.js Viewer...</h5>
                  <p class="text-muted">Initializing universal PDF renderer...</p>
                </div>
              </div>
              
              <!-- PDF.js iframe will be inserted here -->
              <iframe id="pdfjs-iframe" 
                      style="width: 100%; height: 100%; border: none; display: none;"
                      title="PDF.js Viewer">
              </iframe>
              
              <!-- Fallback if PDF.js fails -->
              <div id="pdfjs-fallback" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #f8f9fa;">
                <div class="d-flex align-items-center justify-content-center h-100">
                  <div class="text-center">
                    <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
                    <h5>PDF.js Not Available</h5>
                    <p class="text-muted">Universal PDF viewer could not be loaded. This may be due to network restrictions.</p>
                    <div class="btn-group">
                      <button class="btn btn-primary" onclick="showPdfLegacy()">Try Legacy Mode</button>
                      <button class="btn btn-secondary" onclick="showPdfDownload()">Download File</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- PDF Legacy Compatibility Method -->
          <div id="pdf-legacy" class="pdf-viewer-method" style="display: none;">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-warning">Method: Legacy Compatibility</span>
              <span class="badge bg-info">Best for: PDF v1.0-1.4</span>
            </div>
            {% if file_base64 %}
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle"></i>
              <strong>Legacy PDF Mode:</strong> Multiple fallback methods for old PDF versions (1.0-1.4). 
              <br><small class="text-muted">üí° For desktop apps: If embedded viewing doesn't work, use the download options below.</small>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <h6><i class="bi bi-1-circle"></i> Direct Embed Method</h6>
                <embed src="data:{{ mimetype }};base64,{{ file_base64 }}" 
                       type="{{ mimetype }}" 
                       width="100%" height="350px" 
                       style="border: 1px solid #ddd;"
                       pluginspage="http://www.adobe.com/products/acrobat/readstep2.html"
                       onerror="handleLegacyPdfError(this, 'embed')">
                <div class="mt-2">
                  <small class="text-muted">If nothing appears above, try the download options below.</small>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <h6><i class="bi bi-2-circle"></i> Object Fallback</h6>
                <object data="data:{{ mimetype }};base64,{{ file_base64 }}" 
                        type="{{ mimetype }}" 
                        width="100%" height="350px" 
                        style="border: 1px solid #ddd;"
                        onerror="handleLegacyPdfError(this, 'object')">
                  <p class="text-center p-3">
                    <i class="bi bi-x-circle text-warning"></i><br>
                    <small>PDF not displayed - try download options below</small>
                  </p>
                </object>
                <div class="mt-2">
                  <small class="text-muted">Alternative rendering method for better compatibility.</small>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-12">
                <h6><i class="bi bi-3-circle"></i> Desktop-Friendly Options</h6>
                <div class="alert alert-secondary">
                  <p class="mb-2">For desktop applications, use these reliable viewing methods:</p>
                  <div class="btn-group-vertical w-100" role="group">
                    <button onclick="saveAsFile()" class="btn btn-primary btn-sm mb-2">
                      <i class="bi bi-save"></i> Save As...
                    </button>
                    <button onclick="openInSystemBrowser()" class="btn btn-outline-secondary btn-sm">
                      <i class="bi bi-window-plus"></i> Open in System Browser
                    </button>
                  </div>
                  <small class="d-block mt-3 text-muted">
                    <strong>üñ•Ô∏è Desktop App Tips:</strong><br>
                    ‚Ä¢ Use "Save As..." to choose where to save the PDF<br>
                    ‚Ä¢ File will open with your system's default PDF reader<br>
                    ‚Ä¢ <strong>Recommended for old PDFs:</strong> Adobe Acrobat Reader, Foxit Reader, SumatraPDF
                  </small>
                </div>
              </div>
            </div>
            {% else %}
            <div class="alert alert-warning text-center">
              <i class="bi bi-exclamation-triangle"></i>
              <h5>File too large for legacy compatibility mode</h5>
              <p>Large files should be downloaded for best compatibility with old PDF versions.</p>
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-primary">
                <i class="bi bi-download"></i> Download for External Viewing
              </a>
            </div>
            {% endif %}
          </div>
          
          <!-- Download Only Method -->
          <div id="pdf-download" class="pdf-viewer-method" style="display: none;">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-dark">Method: Download Only</span>
              <span class="badge bg-success">Most Reliable</span>
            </div>
            
            <div class="alert alert-info">
              <h5><i class="bi bi-info-circle"></i> Save PDF to Your Computer</h5>
              <p class="mb-3">Choose where to save the PDF file or view it in your system browser for full functionality.</p>
            </div>
            
            <div class="row">
              <div class="col-md-8">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-save"></i> Save Options</h6>
                  </div>
                  <div class="card-body">
                    <div class="d-grid gap-3">
                      <button onclick="saveAsFile()" class="btn btn-primary btn-lg">
                        <i class="bi bi-save"></i> Save As...
                        <small class="d-block">Choose save location on your computer</small>
                      </button>
                      
                      <button onclick="openInSystemBrowser()" class="btn btn-outline-secondary btn-lg">
                        <i class="bi bi-window-plus"></i> Open in System Browser
                        <small class="d-block">View PDF in external browser</small>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="card">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Recommended PDF Readers</h6>
                  </div>
                  <div class="card-body">
                    <div class="small">
                      <strong>üñ•Ô∏è For Desktop:</strong><br>
                      ‚Ä¢ Adobe Acrobat Reader<br>
                      ‚Ä¢ Foxit Reader<br>
                      ‚Ä¢ SumatraPDF<br>
                      ‚Ä¢ Edge (Windows 11)<br><br>
                      
                      <strong>üì± For Mobile:</strong><br>
                      ‚Ä¢ Adobe Acrobat<br>
                      ‚Ä¢ Google PDF Viewer<br>
                      ‚Ä¢ Built-in browser viewers<br><br>
                      
                      <strong>üí° Pro Tip:</strong><br>
                      Desktop apps work best with downloaded PDFs for full functionality.
                    </div>
                  </div>
                </div>
                
                <div class="card mt-3">
                  <div class="card-header bg-warning">
                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Troubleshooting</h6>
                  </div>
                  <div class="card-body">
                    <div class="small">
                      <strong>If save doesn't work:</strong><br>
                      1. Try "Open in System Browser" option<br>
                      2. Check your Downloads folder<br>
                      3. Disable browser popup blockers<br>
                      4. Try different PDF viewing methods<br>
                      5. Contact support if issues persist
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- PDF Analysis and Debug Method -->
          <div id="pdf-analysis" class="pdf-viewer-method" style="display: none;">
            <div class="pdf-status-indicator mb-2">
              <span class="badge bg-info">Method: PDF Analysis & Debug</span>
              <span class="badge bg-secondary">Troubleshooting</span>
            </div>
            {% if pdf_info %}
            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> PDF Information</h6>
                  </div>
                  <div class="card-body">
                    <table class="table table-sm mb-0">
                      <tr>
                        <td><strong>Valid PDF:</strong></td>
                        <td>
                          {% if pdf_info.is_valid %}
                            <span class="badge bg-success">Yes</span>
                          {% else %}
                            <span class="badge bg-danger">No</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Version:</strong></td>
                        <td>
                          <span class="badge bg-info">{{ pdf_info.version or 'Unknown' }}</span>
                          {% if pdf_info.version and pdf_info.version|float < 1.4 %}
                            <small class="text-warning">(Old version - try Legacy View)</small>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Encrypted:</strong></td>
                        <td>
                          {% if pdf_info.is_encrypted %}
                            <span class="badge bg-warning">Yes</span>
                          {% else %}
                            <span class="badge bg-success">No</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Linearized:</strong></td>
                        <td>
                          {% if pdf_info.is_linearized %}
                            <span class="badge bg-success">Yes</span>
                          {% elif pdf_info.is_linearized == False %}
                            <span class="badge bg-warning">No</span>
                          {% else %}
                            <span class="badge bg-secondary">Unknown</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Size:</strong></td>
                        <td>
                          <span class="badge bg-info">{{ "%.2f"|format(pdf_info.size_mb) }} MB</span>
                          {% if pdf_info.size_mb > 10 %}
                            <small class="text-warning">(Large file)</small>
                          {% endif %}
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                {% if file_base64 %}
                <div class="card">
                  <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-code"></i> PDF Header Analysis</h6>
                  </div>
                  <div class="card-body">
                    <h6>First 200 bytes:</h6>
                    <pre style="font-size: 10px; background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;">{{ (file_base64 | b64decode)[:200] if file_base64 else 'Not available' }}</pre>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            
            {% if pdf_info.warnings %}
            <div class="card mt-3">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Detected Issues</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  {% for warning in pdf_info.warnings %}
                    <li>{{ warning }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}
            
            {% if pdf_info.recommendations %}
            <div class="card mt-3">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Recommendations</h6>
              </div>
              <div class="card-body">
                <ul class="mb-0">
                  {% for rec in pdf_info.recommendations %}
                    <li>{{ rec }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            {% endif %}
            
            {% else %}
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              PDF analysis not available for this file.
            </div>
            {% endif %}
          </div>
          
          <!-- PDF Download Only -->
          <div id="pdf-download" class="pdf-viewer-method" style="display: none;">
            <div class="text-center py-5">
              <div class="mb-4">
                <i class="bi bi-file-earmark-pdf" style="font-size: 4rem; color: #dc3545;"></i>
              </div>
              <h4>{{ attachment.filename }}</h4>
              <p class="text-muted mb-4">
                This PDF cannot be displayed in the browser or you've chosen to download it.<br>
                Click the button below to download and open with your default PDF reader.
              </p>
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-primary btn-lg">
                <i class="bi bi-download"></i> Download PDF
              </a>
              <div class="mt-4">
                <small class="text-muted">
                  After downloading, you can open the file with Adobe Reader, browser, or any PDF viewer.
                </small>
              </div>
            </div>
          </div>
          
          <!-- PDF Info and Troubleshooting -->
          <div class="mt-3">
            <div class="row">
              <div class="col-md-8">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  <strong>Viewing Tips:</strong>
                  <ul class="mb-0 mt-2">
                    <li>Try different viewing methods using the tabs above</li>
                    <li>Large PDFs (>10MB) may take time to load</li>
                    <li>Some PDFs may require downloading to view properly</li>
                    <li>Password-protected PDFs cannot be displayed inline</li>
                  </ul>
                  
                  {% if pdf_info and pdf_info.warnings %}
                  <div class="mt-3">
                    <strong class="text-warning">‚ö†Ô∏è Detected Issues:</strong>
                    <ul class="mb-0 mt-1">
                      {% for warning in pdf_info.warnings %}
                      <li class="text-warning">{{ warning }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                  
                  {% if pdf_info and pdf_info.recommendations %}
                  <div class="mt-2">
                    <strong class="text-primary">üí° Recommendations:</strong>
                    <ul class="mb-0 mt-1">
                      {% for rec in pdf_info.recommendations %}
                      <li class="text-primary">{{ rec }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-light">
                  <div class="card-body">
                    <h6 class="card-title">PDF Details</h6>
                    <small class="text-muted">
                      <strong>File:</strong> {{ attachment.filename }}<br>
                      <strong>Size:</strong> {{ "%.2f"|format(file_size / 1024) }} KB<br>
                      <strong>Type:</strong> {{ mimetype }}<br>
                      {% if pdf_info %}
                      {% if pdf_info.version %}
                      <strong>PDF Version:</strong> {{ pdf_info.version }}<br>
                      {% endif %}
                      <strong>Valid PDF:</strong> {{ "Yes" if pdf_info.is_valid else "No" }}<br>
                      {% if pdf_info.is_linearized is defined %}
                      <strong>Optimized:</strong> {{ "Yes" if pdf_info.is_linearized else "No" }}<br>
                      {% endif %}
                      {% endif %}
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      {% elif file_extension in ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'] %}
        <!-- Image Viewer -->
        <div class="text-center">
          <img src="data:{{ mimetype }};base64,{{ file_base64 }}" 
               class="img-fluid" 
               style="max-height: 70vh; border: 1px solid #ddd; border-radius: 5px;"
               alt="{{ attachment.filename }}">
        </div>
        
      {% elif file_extension in ['.txt', '.log', '.csv'] %}
        <!-- Text File Viewer -->
        <div class="bg-light p-3 rounded" style="max-height: 60vh; overflow-y: auto;">
          <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9em;">{{ file_base64|b64decode|e }}</pre>
        </div>
        
      {% elif file_extension in ['.html', '.htm'] %}
        <!-- HTML Viewer -->
        <div class="border rounded p-3" style="max-height: 60vh; overflow-y: auto;">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>HTML Content Detected</strong><br>
            For security reasons, HTML files cannot be displayed directly. Please download the file to view its content.
            <a href="data:text/html;base64,{{ file_base64 }}" download="{{ file_name }}" class="btn btn-sm btn-primary mt-2">
              <i class="bi bi-download"></i> Download File
            </a>
          </div>
        </div>
        
      {% elif file_extension in ['.json'] %}
        <!-- JSON Viewer -->
        <div class="bg-light p-3 rounded" style="max-height: 60vh; overflow-y: auto;">
          <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.9em;"><code>{{ file_base64|b64decode|e }}</code></pre>
        </div>
        
      {% else %}
        <!-- Generic File Viewer -->
        <div class="text-center py-5">
          <div class="mb-4">
            <i class="bi bi-file-earmark" style="font-size: 4rem; color: #6c757d;"></i>
          </div>
          <h4>{{ attachment.filename }}</h4>
          <p class="text-muted">
            This file type ({{ file_extension or 'unknown' }}) cannot be previewed directly.<br>
            Please use the download button to save and open the file with an appropriate application.
          </p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-primary">
            <i class="bi bi-download"></i> Download File
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
.card {
  min-height: 70vh;
}

pre {
  margin: 0;
  background: transparent;
  border: none;
}

embed, iframe, object {
  border-radius: 5px;
}

.btn-outline-light:hover {
  background-color: rgba(255, 255, 255, 0.1);
}

.alert-info {
  background-color: #d1ecf1;
  border-color: #bee5eb;
  color: #0c5460;
}

/* PDF Viewer Enhancements */
.pdf-viewer-container {
  position: relative;
}

.pdf-viewer-tabs .btn {
  margin-right: 5px;
  margin-bottom: 10px;
}

.pdf-viewer-tabs .btn.active {
  background-color: #1669d2;
  color: white;
  border-color: #1669d2;
}

.pdf-viewer-method {
  position: relative;
  min-height: 600px;
}

.pdf-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10;
  background: rgba(255, 255, 255, 0.9);
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.pdf-status-indicator {
  text-align: center;
}

.pdf-status-indicator .badge {
  margin-right: 5px;
}

/* Error styling for failed PDF methods */
.pdf-viewer-method.error {
  border: 2px solid #dc3545 !important;
  background-color: #f8f9fa;
}

/* Method suggestion styling */
.method-suggestion {
  animation: slideIn 0.3s ease-in;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive PDF viewer */
@media (max-width: 768px) {
  .pdf-viewer-method {
    min-height: 400px;
  }
  
  embed, iframe, object {
    height: 400px !important;
  }
  
  .pdf-viewer-tabs .btn {
    font-size: 0.8rem;
    padding: 0.375rem 0.5rem;
  }
  
  .pdf-viewer-tabs .badge {
    display: none;
  }
}
</style>

<script>
// PDF Viewer Functions with Enhanced Error Handling
function showPdfEmbed() {
  switchPdfMethod('pdf-embed');
  setActiveButton(0);
}

function showPdfObject() {
  switchPdfMethod('pdf-object');
  setActiveButton(1);
}

function showPdfIframe() {
  switchPdfMethod('pdf-iframe');
  setActiveButton(2);
}

function showPdfJs() {
  switchPdfMethod('pdf-pdfjs');
  setActiveButton(3);
  loadWithPdfJs();
}

function showPdfLegacy() {
  switchPdfMethod('pdf-legacy');
  setActiveButton(4);
}

function showPdfAnalysis() {
  switchPdfMethod('pdf-analysis');
  setActiveButton(5);
}

function showPdfDownload() {
  switchPdfMethod('pdf-download');
  setActiveButton(6);
}

function switchPdfMethod(methodId) {
  // Hide all methods
  document.querySelectorAll('.pdf-viewer-method').forEach(method => {
    method.style.display = 'none';
  });
  
  // Show selected method
  const selectedMethod = document.getElementById(methodId);
  if (selectedMethod) {
    selectedMethod.style.display = 'block';
    
    // Don't show loading for download method
    if (methodId !== 'pdf-download' && methodId !== 'pdf-pdfjs') {
      // Add loading indicator
      showLoadingIndicator(selectedMethod);
      
      // Remove loading after a short delay and check for errors
      setTimeout(() => {
        hideLoadingIndicator(selectedMethod);
        checkMethodSuccess(methodId);
      }, 3000);
    }
  }
}

function checkMethodSuccess(methodId) {
  // Check if the PDF viewing method loaded successfully
  const method = document.getElementById(methodId);
  if (!method) return;
  
  let success = false;
  
  try {
    if (methodId === 'pdf-embed') {
      const embed = method.querySelector('#pdf-embed-element');
      if (embed && embed.contentDocument) {
        success = true;
      }
    } else if (methodId === 'pdf-object') {
      const object = method.querySelector('#pdf-object-element');
      if (object && (object.contentDocument || object.getSVGDocument())) {
        success = true;
      }
    } else if (methodId === 'pdf-iframe') {
      const iframe = method.querySelector('#pdf-iframe-element');
      if (iframe && iframe.contentDocument) {
        success = true;
      }
    }
  } catch (e) {
    console.log(`Method ${methodId} access check failed:`, e);
    success = false;
  }
  
  // If method failed, show fallback
  if (!success && methodId !== 'pdf-download' && methodId !== 'pdf-legacy') {
    setTimeout(() => {
      const fallbackId = methodId.replace('pdf-', '') + '-fallback';
      const fallback = document.getElementById(fallbackId);
      if (fallback) {
        fallback.style.display = 'block';
      }
    }, 1000);
  }
}

// Enhanced PDF.js loader with multiple CDN fallbacks
function loadWithPdfJs() {
  console.log('Loading PDF.js viewer...');
  
  const container = document.getElementById('pdfjs-container');
  const loading = document.getElementById('pdfjs-loading');
  const iframe = document.getElementById('pdfjs-iframe');
  const fallback = document.getElementById('pdfjs-fallback');
  
  if (!container) return;
  
  // Show loading state
  loading.style.display = 'flex';
  iframe.style.display = 'none';
  fallback.style.display = 'none';
  
  // Use local PDF.js viewer only (offline mode)
  const pdfJsSources = [
    '{{ url_for("static", filename="js/pdf.viewer.html") }}?file='
  ];
  
  let sourceIndex = 0;
  
  function tryNextSource() {
    if (sourceIndex >= pdfJsSources.length) {
      // All sources failed
      console.log('All PDF.js sources failed');
      loading.style.display = 'none';
      fallback.style.display = 'block';
      return;
    }
    
    const source = pdfJsSources[sourceIndex];
    const base64Data = "{{ file_base64 }}";
    
    if (!base64Data) {
      // No base64 data available, use direct URL
      const fileUrl = "{{ url_for('int_source_view_email_attachment', att_id=attachment.id) }}";
      iframe.src = `${source}?file=${encodeURIComponent(fileUrl)}`;
    } else {
      // Use base64 data URL
      const dataUrl = `data:application/pdf;base64,${base64Data}`;
      iframe.src = `${source}?file=${encodeURIComponent(dataUrl)}`;
    }
    
    // Set up load/error handlers
    iframe.onload = function() {
      console.log(`PDF.js loaded successfully from: ${source}`);
      loading.style.display = 'none';
      iframe.style.display = 'block';
    };
    
    iframe.onerror = function() {
      console.log(`PDF.js failed to load from: ${source}`);
      sourceIndex++;
      setTimeout(tryNextSource, 1000);
    };
    
    // Timeout fallback
    setTimeout(() => {
      if (loading.style.display !== 'none') {
        console.log(`PDF.js timeout for: ${source}`);
        sourceIndex++;
        tryNextSource();
      }
    }, 10000);
    
    sourceIndex++;
  }
  
  // Start trying sources
  tryNextSource();
}

function handlePdfLoad(method) {
  console.log(`PDF ${method} method loaded successfully`);
  
  // Hide any fallback elements for this method
  const fallbackId = method + '-fallback';
  const fallback = document.getElementById(fallbackId);
  if (fallback) {
    fallback.style.display = 'none';
  }
  
  // Show success indicator briefly
  const methodElement = document.getElementById(`pdf-${method}`);
  if (methodElement) {
    const success = document.createElement('div');
    success.className = 'alert alert-success mt-2 pdf-success';
    success.innerHTML = `
      <i class="bi bi-check-circle"></i>
      <strong>Success!</strong> PDF loaded using ${method} method.
    `;
    methodElement.appendChild(success);
    
    // Remove success message after 3 seconds
    setTimeout(() => {
      if (success.parentElement) {
        success.remove();
      }
    }, 3000);
  }
}

function setActiveButton(index) {
  // Remove active class from all buttons
  document.querySelectorAll('.pdf-viewer-tabs .btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Add active class to selected button
  const buttons = document.querySelectorAll('.pdf-viewer-tabs .btn');
  if (buttons[index]) {
    buttons[index].classList.add('active');
  }
}

function handlePdfError(method) {
  console.log(`PDF viewing error in ${method} method`);
  
  // Show method-specific fallback
  const fallbackId = method + '-fallback';
  const fallback = document.getElementById(fallbackId);
  if (fallback) {
    fallback.style.display = 'block';
  }
  
  // Add error indicator to the method container
  const methodElement = document.getElementById(`pdf-${method}`);
  if (methodElement && !methodElement.querySelector('.pdf-error-notice')) {
    // Add error styling
    methodElement.style.border = '2px solid #dc3545';
    
    // Show error message
    const errorMsg = document.createElement('div');
    errorMsg.className = 'alert alert-danger mt-2 pdf-error-notice';
    errorMsg.innerHTML = `
      <i class="bi bi-exclamation-triangle"></i>
      <strong>Viewing Error:</strong> This PDF failed to load using the ${method} method.
      <div class="mt-2">
        <button class="btn btn-sm btn-warning me-2" onclick="tryNextMethod('${method}')">Try Next Method</button>
        <button class="btn btn-sm btn-success me-2" onclick="showPdfJs()">Use PDF.js</button>
        <button class="btn btn-sm btn-secondary" onclick="showPdfDownload()">Download Instead</button>
      </div>
    `;
    methodElement.appendChild(errorMsg);
  }
}

function tryNextMethod(failedMethod) {
  console.log(`Auto-switching from failed method: ${failedMethod}`);
  
  // Auto-switch to next available method with smart fallback logic
  if (failedMethod === 'embed') {
    showPdfObject();
  } else if (failedMethod === 'object') {
    showPdfIframe();
  } else if (failedMethod === 'iframe') {
    showPdfJs();
  } else if (failedMethod === 'pdfjs') {
    showPdfLegacy();
  } else {
    showPdfDownload();
  }
}

function forceDirectDownload() {
  console.log('Forcing direct download...');
  
  // Multiple download methods for maximum compatibility
  const downloadUrl = "{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}";
  
  // Method 1: Traditional link click
  window.location.href = downloadUrl;
  
  // Method 2: Open in new window (fallback)
  setTimeout(() => {
    window.open(downloadUrl, '_blank');
  }, 500);
  
  // Method 3: Create temporary download link
  setTimeout(() => {
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = "{{ attachment.filename }}";
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }, 1000);
  
  // Show download status
  showDownloadStatus('forced');
}

function showDownloadStatus(method) {
  const statusDiv = document.createElement('div');
  statusDiv.className = 'alert alert-info mt-2 download-status';
  const methodText = method === 'forced' ? 'Force Download Started!' : 'Download Initiated!';
  statusDiv.innerHTML = `
    <i class="bi bi-download"></i>
    <strong>${methodText}</strong> 
    <div class="small mt-1">
      The PDF should download to your default Downloads folder.
      If the download doesn't start, try refreshing the page.
    </div>
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  // Remove any existing status messages
  const existing = document.querySelectorAll('.download-status');
  existing.forEach(el => el.remove());
  
  // Add new status to current method container
  const activeMethod = document.querySelector('.pdf-viewer-method[style*="block"]');
  if (activeMethod) {
    activeMethod.appendChild(statusDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (statusDiv.parentElement) {
        statusDiv.remove();
      }
    }, 5000);
  }
}

function showLoadingIndicator(container) {
  const existing = container.querySelector('.pdf-loading');
  if (existing) return;
  
  const loading = document.createElement('div');
  loading.className = 'pdf-loading text-center';
  loading.innerHTML = `
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading PDF...</span>
    </div>
    <p class="mt-2 text-muted">Loading PDF viewer...</p>
    <small class="text-muted">If this takes too long, try a different viewing method or download the file.</small>
  `;
  container.appendChild(loading);
}

function hideLoadingIndicator(container) {
  const loading = container.querySelector('.pdf-loading');
  if (loading) {
    loading.remove();
  }
}

// Auto-detect PDF loading issues and suggest solutions
document.addEventListener('DOMContentLoaded', function() {
  console.log('Enhanced PDF viewer initialized');
  
  // Smart PDF auto-detection based on file analysis
  const pdfInfo = {{ pdf_info | tojson }} || null;
  const fileSize = {{ file_size }} || 0;
  
  if (pdfInfo) {
    console.log('PDF Analysis Results:', pdfInfo);
    
    // Auto-suggest best viewing method based on analysis
    setTimeout(() => {
      suggestBestViewingMethod(pdfInfo, fileSize);
    }, 2000);
    
    // Auto-fallback if embed method fails
    setTimeout(() => {
      checkEmbedMethodAndFallback();
    }, 5000);
  }
  
  // Enhanced compatibility detection
  setTimeout(() => {
    detectBrowserCapabilities();
  }, 1000);
});

function suggestBestViewingMethod(pdfInfo, fileSize) {
  let suggestedMethod = null;
  let reason = '';
  
  // Size-based recommendations
  const sizeMB = fileSize / (1024 * 1024);
  if (sizeMB > 50) {
    suggestedMethod = 'download';
    reason = 'Large file size (>50MB) - download recommended';
  } else if (sizeMB > 10) {
    suggestedMethod = 'pdfjs';
    reason = 'Large file size - PDF.js handles big files better';
  }
  
  // Version-based recommendations
  if (pdfInfo.version) {
    const version = parseFloat(pdfInfo.version);
    if (version < 1.4) {
      suggestedMethod = 'legacy';
      reason = `Old PDF version (${pdfInfo.version}) - legacy mode recommended`;
    } else if (version > 1.7) {
      suggestedMethod = 'pdfjs';
      reason = `Modern PDF version (${pdfInfo.version}) - PDF.js recommended`;
    }
  }
  
  // Encryption-based recommendations
  if (pdfInfo.is_encrypted) {
    suggestedMethod = 'download';
    reason = 'Encrypted PDF - download and open with PDF reader';
  }
  
  // Warning-based recommendations
  if (pdfInfo.warnings && pdfInfo.warnings.length > 0) {
    if (pdfInfo.warnings.some(w => w.includes('structure') || w.includes('incomplete'))) {
      suggestedMethod = 'pdfjs';
      reason = 'PDF structure issues detected - PDF.js more tolerant';
    }
  }
  
  // Show suggestion if we have one
  if (suggestedMethod && suggestedMethod !== 'embed') {
    showMethodSuggestion(suggestedMethod, reason);
  }
}

function checkEmbedMethodAndFallback() {
  const embedElement = document.getElementById('pdf-embed-element');
  const embedMethod = document.getElementById('pdf-embed');
  
  if (embedElement && embedMethod && embedMethod.style.display !== 'none') {
    try {
      // Check if embed loaded properly
      const hasContent = embedElement.contentDocument || 
                        embedElement.getSVGDocument() ||
                        embedElement.offsetHeight > 100;
      
      if (!hasContent) {
        console.log('Embed method appears to have failed, suggesting alternatives');
        showAutoFallbackSuggestion();
      }
    } catch (e) {
      console.log('Embed method access failed:', e);
      showAutoFallbackSuggestion();
    }
  }
}

function detectBrowserCapabilities() {
  const capabilities = {
    browser: getBrowserName(),
    pdfSupport: 'unknown',
    pdfJsSupport: true,
    embedSupport: true,
    objectSupport: true
  };
  
  // Test PDF support
  try {
    const testEmbed = document.createElement('embed');
    testEmbed.type = 'application/pdf';
    capabilities.embedSupport = !!testEmbed;
  } catch (e) {
    capabilities.embedSupport = false;
  }
  
  console.log('Browser Capabilities:', capabilities);
  
  // Show browser-specific recommendations
  if (capabilities.browser === 'safari') {
    showBrowserSpecificTip('Safari users: PDF.js or Download methods work best');
  } else if (capabilities.browser === 'firefox') {
    showBrowserSpecificTip('Firefox users: All methods should work well');
  } else if (capabilities.browser === 'edge') {
    showBrowserSpecificTip('Edge users: Native PDF support available');
  }
}

function getBrowserName() {
  const userAgent = navigator.userAgent.toLowerCase();
  if (userAgent.includes('chrome')) return 'chrome';
  if (userAgent.includes('firefox')) return 'firefox';
  if (userAgent.includes('safari')) return 'safari';
  if (userAgent.includes('edge')) return 'edge';
  return 'unknown';
}

function showMethodSuggestion(method, reason) {
  const embedMethod = document.getElementById('pdf-embed');
  if (embedMethod && !embedMethod.querySelector('.auto-suggestion')) {
    const suggestion = document.createElement('div');
    suggestion.className = 'alert alert-info auto-suggestion mt-2';
    suggestion.innerHTML = `
      <i class="bi bi-lightbulb"></i>
      <strong>Smart Recommendation:</strong> ${reason}
      <div class="mt-2">
        ${getMethodButton(method)}
        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="this.parentElement.parentElement.remove()">
          Dismiss
        </button>
      </div>
    `;
    embedMethod.appendChild(suggestion);
  }
}

function showAutoFallbackSuggestion() {
  const embedMethod = document.getElementById('pdf-embed');
  if (embedMethod && !embedMethod.querySelector('.auto-fallback-suggestion')) {
    const suggestion = document.createElement('div');
    suggestion.className = 'alert alert-warning auto-fallback-suggestion mt-2';
    suggestion.innerHTML = `
      <i class="bi bi-exclamation-triangle"></i>
      <strong>Auto-Detection:</strong> The embed method may not be working properly.
      <div class="mt-2">
        <button class="btn btn-sm btn-success me-2" onclick="showPdfJs()">Try PDF.js</button>
        <button class="btn btn-sm btn-primary me-2" onclick="showPdfObject()">Try Object View</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="this.parentElement.parentElement.remove()">
          Dismiss
        </button>
      </div>
    `;
    embedMethod.appendChild(suggestion);
  }
}

function getMethodButton(method) {
  const buttons = {
    'pdfjs': '<button class="btn btn-sm btn-success" onclick="showPdfJs()">Use PDF.js</button>',
    'object': '<button class="btn btn-sm btn-primary" onclick="showPdfObject()">Try Object View</button>',
    'iframe': '<button class="btn btn-sm btn-warning" onclick="showPdfIframe()">Try Frame View</button>',
    'legacy': '<button class="btn btn-sm btn-secondary" onclick="showPdfLegacy()">Use Legacy Mode</button>',
    'download': '<button class="btn btn-sm btn-dark" onclick="showPdfDownload()">Download File</button>'
  };
  return buttons[method] || '';
}

function showBrowserSpecificTip(message) {
  const container = document.querySelector('.pdf-viewer-container');
  if (container && !container.querySelector('.browser-tip')) {
    const tip = document.createElement('div');
    tip.className = 'alert alert-light browser-tip mb-3';
    tip.innerHTML = `
      <i class="bi bi-info-circle"></i>
      <small><strong>Browser Tip:</strong> ${message}</small>
      <button type="button" class="btn-close btn-close-sm" onclick="this.parentElement.remove()"></button>
    `;
    container.insertBefore(tip, container.firstChild);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
      if (tip.parentElement) {
        tip.remove();
      }
    }, 10000);
  }
}

// Desktop-specific PDF handling with enhanced save methods
function saveAsFile() {
  console.log('Initiating Save As...');
  
  try {
    const base64Data = "{{ file_base64 }}";
    const filename = "{{ attachment.filename }}";
    
    if (!base64Data) {
      // Fallback to direct download if no base64 data
      window.location.href = "{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}";
      showSaveStatus('direct');
      return;
    }
    
    // Create a blob from base64 data
    const byteCharacters = atob(base64Data);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    const blob = new Blob([byteArray], { type: 'application/pdf' });
    
    // For modern browsers, try using the File System Access API if available
    if ('showSaveFilePicker' in window) {
      window.showSaveFilePicker({
        suggestedName: filename,
        types: [{
          description: 'PDF files',
          accept: { 'application/pdf': ['.pdf'] }
        }]
      }).then(fileHandle => {
        return fileHandle.createWritable();
      }).then(writable => {
        return writable.write(blob);
      }).then(writable => {
        return writable.close();
      }).then(() => {
        showSaveStatus('saveAs');
      }).catch(err => {
        console.log('Save picker cancelled or failed:', err);
        // Fallback to regular download
        downloadFromBase64(base64Data, filename);
        showSaveStatus('download');
      });
    } else {
      // Fallback for older browsers/desktop apps
      downloadFromBase64(base64Data, filename);
      showSaveStatus('download');
    }
    
  } catch (e) {
    console.error('Save As failed:', e);
    showSaveError('Save operation failed');
  }
}

function downloadFromBase64(base64Data, filename) {
  // Convert base64 to blob
  const byteCharacters = atob(base64Data);
  const byteNumbers = new Array(byteCharacters.length);
  for (let i = 0; i < byteCharacters.length; i++) {
    byteNumbers[i] = byteCharacters.charCodeAt(i);
  }
  const byteArray = new Uint8Array(byteNumbers);
  const blob = new Blob([byteArray], { type: 'application/pdf' });
  
  // Create download link
  const url = window.URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  
  // Trigger download
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Clean up
  setTimeout(() => {
    window.URL.revokeObjectURL(url);
  }, 1000);
}

function trackDownloadClick(element) {
  console.log('Direct download link clicked');
  
  // Add visual feedback
  const originalText = element.innerHTML;
  element.innerHTML = '<i class="bi bi-hourglass-split"></i> Downloading...';
  element.classList.add('disabled');
  
  // Reset after delay
  setTimeout(() => {
    element.innerHTML = originalText;
    element.classList.remove('disabled');
    showDownloadStatus('direct');
  }, 2000);
}

function openInSystemBrowser() {
  console.log('Attempting to open in system browser...');
  
  const isDesktop = !window.location.protocol.startsWith('http') || 
                   window.navigator.userAgent.includes('Electron') ||
                   window.pywebview !== undefined;
  
  if (isDesktop) {
    // For desktop apps, try to open the download URL in system browser
    const downloadUrl = "{{ url_for('int_source_view_email_attachment', att_id=attachment.id) }}";
    
    // Multiple methods to open external browser
    if (window.pywebview && window.pywebview.api) {
      // PyWebView specific
      try {
        window.pywebview.api.open_url(downloadUrl);
        showBrowserOpenStatus(true);
        return;
      } catch (e) {
        console.log('PyWebView API not available');
      }
    }
    
    // Generic approach - create a full URL and try to open
    const fullUrl = window.location.origin + downloadUrl;
    window.open(fullUrl, '_blank');
    showBrowserOpenStatus(false);
    
  } else {
    // Regular browser - open in new tab
    const viewUrl = "{{ url_for('int_source_view_email_attachment', att_id=attachment.id) }}";
    window.open(viewUrl, '_blank');
    showBrowserOpenStatus(true);
  }
}

function showSaveStatus(method) {
  const statusDiv = document.createElement('div');
  statusDiv.className = 'alert alert-success mt-2 save-status';
  const methodText = method === 'saveAs' ? 'File Saved!' : 
                    method === 'direct' ? 'Download Started!' : 'File Downloaded!';
  statusDiv.innerHTML = `
    <i class="bi bi-check-circle"></i>
    <strong>${methodText}</strong> 
    <span class="method-info">Method: ${method}</span>
    <div class="small mt-1">
      ${method === 'saveAs' ? 
        'The PDF was saved to your chosen location.' :
        'The PDF should be in your Downloads folder and may open automatically.'
      }
    </div>
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  // Remove any existing status messages
  const existing = document.querySelectorAll('.save-status, .download-status');
  existing.forEach(el => el.remove());
  
  // Add new status
  const container = document.getElementById('pdf-download') || document.getElementById('pdf-legacy');
  if (container) {
    container.appendChild(statusDiv);
    
    // Auto-remove after 8 seconds
    setTimeout(() => {
      if (statusDiv.parentElement) {
        statusDiv.remove();
      }
    }, 8000);
  }
}

function showSaveError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'alert alert-danger mt-2 save-error';
  errorDiv.innerHTML = `
    <i class="bi bi-exclamation-triangle"></i>
    <strong>Save Error:</strong> ${message}
    <div class="small mt-1">
      Try refreshing the page or contact support if the problem persists.
    </div>
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  // Remove any existing error messages
  const existing = document.querySelectorAll('.save-error, .download-error');
  existing.forEach(el => el.remove());
  
  // Add new error
  const container = document.getElementById('pdf-download') || document.getElementById('pdf-legacy');
  if (container) {
    container.appendChild(errorDiv);
  }
}

function showBrowserOpenStatus(success) {
  const statusDiv = document.createElement('div');
  statusDiv.className = `alert ${success ? 'alert-info' : 'alert-warning'} mt-2 browser-status`;
  statusDiv.innerHTML = `
    <i class="bi bi-${success ? 'info-circle' : 'exclamation-triangle'}"></i>
    <strong>${success ? 'Opening in System Browser...' : 'Browser Open Attempted'}</strong>
    <div class="small mt-1">
      ${success ? 
        'The PDF should open in your default web browser for better viewing.' :
        'If a new browser window didn\'t open, try the download options instead.'
      }
    </div>
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  // Remove any existing status messages
  const existing = document.querySelectorAll('.browser-status');
  existing.forEach(el => el.remove());
  
  // Add new status
  const legacyView = document.getElementById('pdf-legacy');
  if (legacyView) {
    legacyView.appendChild(statusDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (statusDiv.parentElement) {
        statusDiv.remove();
      }
    }, 5000);
  }
}


// Keep the old function for backward compatibility but improve it
function openPdfInNewWindow() {
  openInSystemBrowser();
}

function showDesktopMessage() {
  // Show a temporary message about desktop app behavior
  const message = document.createElement('div');
  message.className = 'alert alert-info mt-2';
  message.innerHTML = `
    <i class="bi bi-info-circle"></i>
    <strong>Desktop App:</strong> The PDF should download and open with your system's default PDF reader.
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  const legacyView = document.getElementById('pdf-legacy');
  if (legacyView) {
    legacyView.appendChild(message);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (message.parentElement) {
        message.remove();
      }
    }, 5000);
  }
}

// Handle errors in legacy PDF viewing methods
function handleLegacyPdfError(element, method) {
  console.log(`Legacy PDF ${method} method failed`);
  
  // Add visual indicator that this method failed
  const container = element.parentElement;
  if (container && !container.querySelector('.legacy-error-notice')) {
    const notice = document.createElement('div');
    notice.className = 'legacy-error-notice alert alert-warning mt-2 p-2';
    notice.innerHTML = `
      <i class="bi bi-exclamation-triangle"></i>
      <small><strong>${method} method failed.</strong> Try the download options below.</small>
    `;
    container.appendChild(notice);
  }
}
</script>

{% endblock %}
