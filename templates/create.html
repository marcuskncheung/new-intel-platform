{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">üìù Create New Profile</h4>
        </div>
        <div class="card-body">
          <form method="post" id="createProfileForm">
            
            <!-- Basic Information -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Index</label>
                <input name="Index" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Date of Receipt</label>
                <input name="Date of Receipt" type="date" class="form-control">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Source Type</label>
                <select name="Source Type" class="form-control">
                  <option value="">Select Source Type</option>
                  <option value="Email">Email</option>
                  <option value="WhatsApp">WhatsApp</option>
                  <option value="Online Patrol">Online Patrol</option>
                  <option value="Surveillance">Surveillance</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Source</label>
                <input name="Source" class="form-control">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Case Status</label>
                <select name="Case Status" class="form-control">
                  <option value="">Select Status</option>
                  <option value="Pending">Pending</option>
                  <option value="Under Investigation">Under Investigation</option>
                  <option value="Closed">Closed</option>
                  <option value="Unsubstantial">Unsubstantial</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Case Number</label>
                <input name="Case Number" class="form-control">
              </div>
            </div>

            <!-- Alleged Subject Section -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h5 class="mb-0">üë§ Alleged Subject(s)</h5>
              </div>
              <div class="card-body">
                <div id="alleged-subjects-container">
                  <div class="alleged-subject-item border rounded p-3 mb-3" data-subject-index="0">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="text-primary mb-0">üìã Alleged Subject Details</h6>
                      <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" style="display: none;">
                        üóëÔ∏è Remove
                      </button>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <label class="form-label">üìù English Name</label>
                        <input name="alleged_subjects[0][english_name]" class="form-control" placeholder="Enter English name">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                        <input name="alleged_subjects[0][chinese_name]" class="form-control" placeholder="Enter Chinese name">
                      </div>
                    </div>
                    
                    <div class="mt-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="alleged_subjects[0][is_insurance_intermediary]" id="insurance_check_0">
                        <label class="form-check-label" for="insurance_check_0">
                          Is this an insurance intermediary?
                        </label>
                      </div>
                    </div>
                    
                    <div class="row mt-3 insurance-details" style="display: none;">
                      <div class="col-md-6">
                        <label class="form-label">License Type</label>
                        <select name="alleged_subjects[0][license_type]" class="form-control">
                          <option value="">Select Type</option>
                          <option value="Agent">Agent</option>
                          <option value="Broker">Broker</option>
                          <option value="Other">Other</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">License Number</label>
                        <input name="alleged_subjects[0][license_number]" class="form-control" placeholder="Enter license number">
                      </div>
                    </div>
                    
                    <p class="text-muted mt-2 mb-0">
                      <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                    </p>
                  </div>
                </div>
                
                <div class="text-center">
                  <button type="button" id="add-another-subject" class="btn btn-success">
                    ‚ûï Add Another Subject (English/Chinese)
                  </button>
                </div>
                
                <div class="alert alert-info mt-3">
                  <i class="bi bi-lightbulb"></i> 
                  <strong>Tip:</strong> You can add multiple alleged subjects, each with English and Chinese names
                </div>
              </div>
            </div>

            <!-- Other Information -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Agent Number</label>
                <input name="Agent Number" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Agent Company/Broker</label>
                <input name="Agent Company/Broker" class="form-control">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Alleged Misconduct Type</label>
              <select name="Alleged Misconduct Type" class="form-control">
                <option value="">Select Misconduct Type</option>
                <option value="Misrepresentation">Misrepresentation</option>
                <option value="Unauthorized Practice">Unauthorized Practice</option>
                <option value="Policy Churning">Policy Churning</option>
                <option value="Premium Misappropriation">Premium Misappropriation</option>
                <option value="Breach of Professional Conduct">Breach of Professional Conduct</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="mb-4">
              <label class="form-label">Description of Incident</label>
              <textarea name="Description of Incident" class="form-control" rows="4" placeholder="Describe the incident in detail..."></textarea>
            </div>

            <!-- Hidden fields for alleged subjects (will be populated by JavaScript) -->
            <input type="hidden" name="Alleged Subject (English Name)" id="hidden_english_names">
            <input type="hidden" name="Alleged Subject (Chinese Name)" id="hidden_chinese_names">

            <div class="text-center">
              <button type="submit" class="btn btn-success btn-lg">
                ‚úÖ Create Profile
              </button>
              <a href="{{ url_for('alleged_subject_list') }}" class="btn btn-secondary btn-lg ms-2">
                ‚ùå Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let subjectIndex = 1; // Start from 1 since we already have index 0
    
    // Add Another Subject functionality
    document.getElementById('add-another-subject').addEventListener('click', function() {
        const container = document.getElementById('alleged-subjects-container');
        
        const newSubjectHTML = `
        <div class="alleged-subject-item border rounded p-3 mb-3" data-subject-index="${subjectIndex}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-primary mb-0">üìã Alleged Subject Details</h6>
                <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn">
                    üóëÔ∏è Remove
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">üìù English Name</label>
                    <input name="alleged_subjects[${subjectIndex}][english_name]" class="form-control" placeholder="Enter English name">
                </div>
                <div class="col-md-6">
                    <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                    <input name="alleged_subjects[${subjectIndex}][chinese_name]" class="form-control" placeholder="Enter Chinese name">
                </div>
            </div>
            
            <div class="mt-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="alleged_subjects[${subjectIndex}][is_insurance_intermediary]" id="insurance_check_${subjectIndex}">
                    <label class="form-check-label" for="insurance_check_${subjectIndex}">
                        Is this an insurance intermediary?
                    </label>
                </div>
            </div>
            
            <div class="row mt-3 insurance-details" style="display: none;">
                <div class="col-md-6">
                    <label class="form-label">License Type</label>
                    <select name="alleged_subjects[${subjectIndex}][license_type]" class="form-control">
                        <option value="">Select Type</option>
                        <option value="Agent">Agent</option>
                        <option value="Broker">Broker</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">License Number</label>
                    <input name="alleged_subjects[${subjectIndex}][license_number]" class="form-control" placeholder="Enter license number">
                </div>
            </div>
            
            <p class="text-muted mt-2 mb-0">
                <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
            </p>
        </div>`;
        
        container.insertAdjacentHTML('beforeend', newSubjectHTML);
        subjectIndex++;
        
        // Show remove buttons for all items except the first one
        updateRemoveButtons();
        // Set up insurance intermediary handlers for new item
        setupInsuranceHandlers();
    });
    
    // Remove subject functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-subject-btn') || e.target.closest('.remove-subject-btn')) {
            const subjectItem = e.target.closest('.alleged-subject-item');
            subjectItem.remove();
            updateRemoveButtons();
        }
    });
    
    // Update remove button visibility
    function updateRemoveButtons() {
        const items = document.querySelectorAll('.alleged-subject-item');
        items.forEach((item, index) => {
            const removeBtn = item.querySelector('.remove-subject-btn');
            if (index === 0 && items.length === 1) {
                removeBtn.style.display = 'none';
            } else {
                removeBtn.style.display = 'block';
            }
        });
    }
    
    // Insurance intermediary checkbox handlers
    function setupInsuranceHandlers() {
        document.querySelectorAll('input[type="checkbox"][name*="is_insurance_intermediary"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const detailsDiv = this.closest('.alleged-subject-item').querySelector('.insurance-details');
                detailsDiv.style.display = this.checked ? 'block' : 'none';
            });
        });
    }
    
    // Initialize insurance handlers
    setupInsuranceHandlers();
    
    // Form submission - collect all subject data
    document.getElementById('createProfileForm').addEventListener('submit', function(e) {
        const englishNames = [];
        const chineseNames = [];
        
        document.querySelectorAll('.alleged-subject-item').forEach(item => {
            const englishName = item.querySelector('input[name*="[english_name]"]').value.trim();
            const chineseName = item.querySelector('input[name*="[chinese_name]"]').value.trim();
            
            if (englishName) englishNames.push(englishName);
            if (chineseName) chineseNames.push(chineseName);
        });
        
        // Set hidden fields
        document.getElementById('hidden_english_names').value = englishNames.join(', ');
        document.getElementById('hidden_chinese_names').value = chineseNames.join(', ');
    });
});
</script>

<style>
.alleged-subject-item {
    background-color: #f8f9fa;
    transition: all 0.3s ease;
}

.alleged-subject-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.insurance-details {
    background-color: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #2196f3;
}

#add-another-subject {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

#add-another-subject:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.remove-subject-btn {
    transition: all 0.3s ease;
}

.remove-subject-btn:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}