{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Alleged Subjects Dashboard</h2>
  <div class="btn-group" role="group">
    {% if automation_enabled %}
      {# New automated profile system #}
      <a href="{{ url_for('create_alleged_person_profile') }}" class="btn btn-success">
        <i class="bi bi-plus-lg"></i> New POI Profile
      </a>
      <a href="{{ url_for('find_duplicate_poi_profiles') }}" class="btn btn-warning">
        <i class="bi bi-search"></i> Find & Merge Duplicates
      </a>
      <form method="POST" action="{{ url_for('recalculate_poi_counts') }}" style="display: inline;">
        <button type="submit" class="btn btn-secondary" title="Fix email count discrepancies">
          <i class="bi bi-calculator"></i> Recalculate Counts
        </button>
      </form>
    {% else %}
      {# Old legacy profile system #}
      <a href="{{ url_for('create') }}" class="btn btn-success">+ New Profile</a>
    {% endif %}
    <form method="POST" action="{{ url_for('refresh_poi_profiles') }}" style="display: inline;">
      <button type="submit" class="btn btn-info">
        <i class="bi bi-arrow-clockwise"></i> Refresh All Sources
      </button>
    </form>
  </div>
</div>
<div class="row">
  {% for t in targets %}
  <div class="col-md-4 mb-3">
    <div class="card h-100">
      <div class="card-body d-flex flex-column">
        {% if automation_enabled and t.poi_id %}
          {# Show POI number prominently #}
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title mb-0">{{ t.label }}</h5>
            <span class="badge bg-primary fs-6">{{ t.poi_id }}</span>
          </div>
        {% else %}
          <h5 class="card-title">{{ t.label }}</h5>
        {% endif %}
        {% if t.subtitle %}<p class="text-muted small mb-2">{{ t.subtitle }}</p>{% endif %}
        
        {# ✅ Show intelligence breakdown by source type #}
        {% if automation_enabled and (t.email_count or t.whatsapp_count or t.patrol_count or t.surveillance_count) %}
        <div class="mb-2">
          <div class="d-flex flex-wrap gap-1">
            {% if t.email_count %}
              <span class="badge bg-info" title="Emails">
                <i class="bi bi-envelope"></i> {{ t.email_count }}
              </span>
            {% endif %}
            {% if t.whatsapp_count %}
              <span class="badge bg-success" title="WhatsApp">
                <i class="bi bi-whatsapp"></i> {{ t.whatsapp_count }}
              </span>
            {% endif %}
            {% if t.patrol_count %}
              <span class="badge bg-warning text-dark" title="Online Patrol">
                <i class="bi bi-binoculars"></i> {{ t.patrol_count }}
              </span>
            {% endif %}
            {% if t.surveillance_count %}
              <span class="badge bg-danger" title="Surveillance">
                <i class="bi bi-camera-video"></i> {{ t.surveillance_count }}
              </span>
            {% endif %}
            {% if t.total_intel %}
              <span class="badge bg-secondary" title="Total Intelligence">
                <i class="bi bi-bar-chart"></i> {{ t.total_intel }}
              </span>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
        {% if t.time %}
          <div class="mb-2"><span class="badge bg-light text-dark">Time: {{ t.time }}</span></div>
        {% endif %}
        <div class="mt-auto d-flex justify-content-between align-items-center">
          {% if automation_enabled and t.poi_id %}
            {# New automated profile system #}
            <a href="{{ url_for('view_alleged_person_profile', profile_id=t.idx) }}" class="btn btn-primary btn-sm">View</a>
            <form method="post" action="{{ url_for('delete_alleged_person_profile', profile_id=t.idx) }}"
                  onsubmit="return confirm('⚠️ Delete profile {{ t.poi_id }}?\n\nThis will remove:\n- Profile information\n- All linked allegations\n\nThe emails will remain in the system.\n\nAre you sure?')"
                  style="margin: 0;">
              <button class="btn btn-danger btn-sm" type="submit">
                <i class="bi bi-trash"></i> Delete
              </button>
            </form>
          {% else %}
            {# Old legacy profile system #}
            <a href="{{ url_for('details', idx=t.idx) }}" class="btn btn-primary btn-sm">View</a>
            <form method="post" action="{{ url_for('delete', idx=t.idx) }}"
                  onsubmit="return confirm('Delete this profile?')">
              <button class="btn btn-danger btn-sm">Delete</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}
