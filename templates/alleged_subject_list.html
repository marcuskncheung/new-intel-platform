{% extends "base.html" %}
{% block content %}
<style>
/* POI Dashboard - Professional Modern Design */
:root {
    --dash-primary: #4f46e5;
    --dash-primary-dark: #3730a3;
    --dash-success: #10b981;
    --dash-warning: #f59e0b;
    --dash-danger: #ef4444;
    --dash-info: #06b6d4;
    --dash-purple: #8b5cf6;
    --dash-gray-50: #f9fafb;
    --dash-gray-100: #f3f4f6;
    --dash-gray-200: #e5e7eb;
    --dash-gray-300: #d1d5db;
    --dash-gray-500: #6b7280;
    --dash-gray-600: #4b5563;
    --dash-gray-700: #374151;
    --dash-gray-900: #111827;
}

.poi-dashboard {
    max-width: 1600px;
    margin: 0 auto;
    padding: 1.5rem;
    background: var(--dash-gray-50);
    min-height: 100vh;
}

/* Header Section */
.dash-header {
    background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4338ca 100%);
    border-radius: 20px;
    padding: 2rem 2.5rem;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
}

.dash-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.dash-header-content {
    position: relative;
    z-index: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1.5rem;
}

.dash-title-section {
    display: flex;
    align-items: center;
    gap: 1.25rem;
}

.dash-icon {
    width: 64px;
    height: 64px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    color: white;
}

.dash-title {
    color: white;
}

.dash-title h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0 0 0.25rem 0;
}

.dash-title p {
    margin: 0;
    opacity: 0.8;
    font-size: 0.95rem;
}

.dash-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn-dash {
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    text-decoration: none;
}

.btn-dash-warning {
    background: rgba(245, 158, 11, 0.9);
    color: white;
}

.btn-dash-warning:hover {
    background: #f59e0b;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

/* Stats Summary Bar */
.dash-stats-bar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.dash-stat-pill {
    background: white;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    border: 1px solid var(--dash-gray-100);
    flex: 1;
    min-width: 150px;
}

.dash-stat-pill-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.dash-stat-pill-icon.total { background: #eef2ff; color: #4f46e5; }
.dash-stat-pill-icon.active { background: #ecfdf5; color: #059669; }
.dash-stat-pill-icon.inactive { background: #f3f4f6; color: #6b7280; }

.dash-stat-pill-info {
    display: flex;
    flex-direction: column;
}

.dash-stat-pill-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dash-gray-900);
    line-height: 1;
}

.dash-stat-pill-label {
    font-size: 0.75rem;
    color: var(--dash-gray-500);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Search and Filter Bar */
.dash-toolbar {
    background: white;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    border: 1px solid var(--dash-gray-100);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.dash-search {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.dash-search input {
    width: 100%;
    padding: 0.625rem 1rem 0.625rem 2.75rem;
    border: 1px solid var(--dash-gray-200);
    border-radius: 8px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.dash-search input:focus {
    outline: none;
    border-color: var(--dash-primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.dash-search i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--dash-gray-400);
}

.dash-view-toggle {
    display: flex;
    gap: 0.25rem;
    background: var(--dash-gray-100);
    border-radius: 8px;
    padding: 0.25rem;
}

.dash-view-btn {
    padding: 0.5rem 0.75rem;
    border: none;
    background: transparent;
    border-radius: 6px;
    color: var(--dash-gray-600);
    cursor: pointer;
    transition: all 0.2s ease;
}

.dash-view-btn.active {
    background: white;
    color: var(--dash-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* POI Grid */
.poi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 1.25rem;
}

/* POI Card */
.poi-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    border: 1px solid var(--dash-gray-100);
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
}

.poi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    border-color: var(--dash-primary);
}

.poi-card-header {
    background: linear-gradient(135deg, #312e81 0%, #4338ca 100%);
    padding: 1.25rem;
    position: relative;
}

.poi-card-header-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.poi-card-avatar {
    width: 52px;
    height: 52px;
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    flex-shrink: 0;
}

.poi-card-identity {
    flex: 1;
    min-width: 0;
    color: white;
}

.poi-card-id {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: rgba(255,255,255,0.2);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-bottom: 0.35rem;
}

.poi-card-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.poi-card-subtitle {
    font-size: 0.8rem;
    opacity: 0.8;
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.poi-card-status {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.3);
}

.poi-card-status.active {
    background: #10b981;
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
}

.poi-card-status.inactive {
    background: #6b7280;
}

.poi-card-body {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* Intelligence Stats in Card */
.poi-intel-stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.poi-intel-stat {
    text-align: center;
    padding: 0.5rem 0.25rem;
    border-radius: 8px;
    background: var(--dash-gray-50);
}

.poi-intel-stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--dash-gray-900);
    line-height: 1;
    margin-bottom: 0.2rem;
}

.poi-intel-stat-label {
    font-size: 0.6rem;
    color: var(--dash-gray-500);
    text-transform: uppercase;
    font-weight: 500;
}

.poi-intel-stat.email { border-bottom: 2px solid #4f46e5; }
.poi-intel-stat.whatsapp { border-bottom: 2px solid #10b981; }
.poi-intel-stat.patrol { border-bottom: 2px solid #f59e0b; }
.poi-intel-stat.rbh { border-bottom: 2px solid #06b6d4; }
.poi-intel-stat.surveillance { border-bottom: 2px solid #ef4444; }
.poi-intel-stat.total { border-bottom: 2px solid #8b5cf6; }

/* Case Count Badge */
.poi-case-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-weight: 600;
}

.poi-case-badge i {
    font-size: 1rem;
}

.poi-case-badge-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.poi-case-badge-label {
    font-size: 0.75rem;
    opacity: 0.9;
}

/* Card Meta Info */
.poi-card-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.poi-meta-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.3rem 0.6rem;
    background: var(--dash-gray-100);
    border-radius: 6px;
    font-size: 0.75rem;
    color: var(--dash-gray-600);
}

.poi-meta-tag i {
    font-size: 0.7rem;
}

/* Card Actions */
.poi-card-actions {
    margin-top: auto;
    display: flex;
    gap: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--dash-gray-100);
}

.btn-poi-card {
    flex: 1;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
    text-decoration: none;
}

.btn-poi-view {
    background: var(--dash-primary);
    color: white;
}

.btn-poi-view:hover {
    background: var(--dash-primary-dark);
    color: white;
}

.btn-poi-delete {
    background: #fef2f2;
    color: var(--dash-danger);
    flex: 0 0 auto;
    padding: 0.625rem 0.875rem;
}

.btn-poi-delete:hover {
    background: #fee2e2;
    color: #b91c1c;
}

/* Empty State */
.poi-empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 16px;
    border: 1px solid var(--dash-gray-100);
}

.poi-empty-state i {
    font-size: 4rem;
    color: var(--dash-gray-300);
    margin-bottom: 1rem;
}

.poi-empty-state h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--dash-gray-700);
    margin-bottom: 0.5rem;
}

.poi-empty-state p {
    color: var(--dash-gray-500);
    margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .poi-dashboard { padding: 1rem; }
    .dash-header { padding: 1.5rem; }
    .dash-header-content { flex-direction: column; align-items: flex-start; }
    .dash-title h1 { font-size: 1.5rem; }
    .poi-grid { grid-template-columns: 1fr; }
    .dash-stats-bar { flex-direction: column; }
    .dash-stat-pill { min-width: 100%; }
}
</style>

<div class="poi-dashboard">
    
    <!-- Header -->
    <div class="dash-header">
        <div class="dash-header-content">
            <div class="dash-title-section">
                <div class="dash-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="dash-title">
                    <h1>POI Profiles</h1>
                    <p>Person of Interest Intelligence Database</p>
                </div>
            </div>
            <div class="dash-actions">
                {% if automation_enabled %}
                <a href="{{ url_for('find_duplicate_poi_profiles') }}" class="btn-dash btn-dash-warning">
                    <i class="bi bi-search"></i> Find & Merge Duplicates
                </a>
                {% endif %}
                {% if current_user.is_admin %}
                <!-- Admin Only: Rebuild POI List from All Sources -->
                <button type="button" class="btn-dash" style="background: rgba(220, 53, 69, 0.9); color: white;" 
                        data-bs-toggle="modal" data-bs-target="#rebuildPoiModal">
                    <i class="bi bi-arrow-repeat"></i> Rebuild POI List
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Stats Summary -->
    <div class="dash-stats-bar">
        <div class="dash-stat-pill">
            <div class="dash-stat-pill-icon total">
                <i class="bi bi-people-fill"></i>
            </div>
            <div class="dash-stat-pill-info">
                <span class="dash-stat-pill-value">{{ targets|length }}</span>
                <span class="dash-stat-pill-label">Total POI Recorded</span>
            </div>
        </div>
    </div>
    
    <!-- Toolbar -->
    <div class="dash-toolbar">
        <div class="dash-search">
            <i class="bi bi-search"></i>
            <input type="text" id="poiSearchInput" placeholder="Search by name, ID, company..." onkeyup="filterPOIs()">
        </div>
        <div class="dash-view-toggle">
            <button class="dash-view-btn active" title="Grid View">
                <i class="bi bi-grid-3x3-gap-fill"></i>
            </button>
            <button class="dash-view-btn" title="List View">
                <i class="bi bi-list-ul"></i>
            </button>
        </div>
    </div>
    
    <!-- POI Grid -->
    {% if targets and targets|length > 0 %}
    <div class="poi-grid" id="poiGrid">
        {% for t in targets %}
        <div class="poi-card" data-search="{{ t.label|lower }} {{ t.subtitle|lower if t.subtitle else '' }} {{ t.poi_id|lower if t.poi_id else '' }} {{ t.company|lower if t.company else '' }}">
            <div class="poi-card-header">
                <div class="poi-card-header-content">
                    <div class="poi-card-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <div class="poi-card-identity">
                        {% if t.poi_id %}
                        <div class="poi-card-id">
                            <i class="bi bi-fingerprint"></i>
                            {{ t.poi_id }}
                        </div>
                        {% endif %}
                        <h3 class="poi-card-name">{{ t.label or 'Unknown' }}</h3>
                        {% if t.subtitle %}
                        <p class="poi-card-subtitle">{{ t.subtitle }}</p>
                        {% endif %}
                    </div>
                </div>
                <div class="poi-card-status {{ 'active' if t.status == 'ACTIVE' else 'inactive' }}" title="{{ t.status or 'ACTIVE' }}"></div>
            </div>
            
            <div class="poi-card-body">
                <!-- Case Count Badge -->
                <div class="poi-case-badge">
                    <i class="bi bi-folder-fill"></i>
                    <span class="poi-case-badge-value">{{ t.case_count or 0 }}</span>
                    <span class="poi-case-badge-label">{{ 'Case' if (t.case_count or 0) == 1 else 'Cases' }} (INT)</span>
                </div>
                
                <!-- Intelligence Stats -->
                <div class="poi-intel-stats">
                    <div class="poi-intel-stat email">
                        <div class="poi-intel-stat-value">{{ t.email_count or 0 }}</div>
                        <div class="poi-intel-stat-label">Email</div>
                    </div>
                    <div class="poi-intel-stat whatsapp">
                        <div class="poi-intel-stat-value">{{ t.whatsapp_count or 0 }}</div>
                        <div class="poi-intel-stat-label">WhatsApp</div>
                    </div>
                    <div class="poi-intel-stat patrol">
                        <div class="poi-intel-stat-value">{{ t.patrol_count or 0 }}</div>
                        <div class="poi-intel-stat-label">Patrol</div>
                    </div>
                    <div class="poi-intel-stat rbh">
                        <div class="poi-intel-stat-value">{{ t.received_by_hand_count or 0 }}</div>
                        <div class="poi-intel-stat-label">RBH</div>
                    </div>
                    <div class="poi-intel-stat total">
                        <div class="poi-intel-stat-value">{{ t.total_intel or (t.email_count or 0) + (t.whatsapp_count or 0) + (t.patrol_count or 0) + (t.received_by_hand_count or 0) }}</div>
                        <div class="poi-intel-stat-label">Total</div>
                    </div>
                </div>
                
                <!-- Meta Tags -->
                <div class="poi-card-meta">
                    {% if t.company %}
                    <span class="poi-meta-tag">
                        <i class="bi bi-building"></i> {{ t.company }}
                    </span>
                    {% endif %}
                    {% if t.role %}
                    <span class="poi-meta-tag">
                        <i class="bi bi-briefcase"></i> {{ t.role }}
                    </span>
                    {% endif %}
                    {% if t.license_number %}
                    <span class="poi-meta-tag">
                        <i class="bi bi-card-checklist"></i> {{ t.license_number }}
                    </span>
                    {% endif %}
                    {% if t.time %}
                    <span class="poi-meta-tag">
                        <i class="bi bi-clock"></i> {{ t.time }}
                    </span>
                    {% endif %}
                </div>
                
                <!-- Actions -->
                <div class="poi-card-actions">
                    {% if automation_enabled and t.poi_id %}
                    <a href="{{ url_for('view_alleged_person_profile', profile_id=t.idx) }}" class="btn-poi-card btn-poi-view">
                        <i class="bi bi-eye"></i> View Profile
                    </a>
                    <form method="post" action="{{ url_for('delete_alleged_person_profile', profile_id=t.idx) }}"
                          onsubmit="return confirm('⚠️ Delete {{ t.poi_id }}?\n\nThis will permanently remove this profile.\n\nAre you sure?')"
                          style="margin: 0;">
                        <button class="btn-poi-card btn-poi-delete" type="submit">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </form>
                    {% else %}
                    <a href="{{ url_for('details', idx=t.idx) }}" class="btn-poi-card btn-poi-view">
                        <i class="bi bi-eye"></i> View Profile
                    </a>
                    <form method="post" action="{{ url_for('delete', idx=t.idx) }}"
                          onsubmit="return confirm('Delete this profile?')" style="margin: 0;">
                        <button class="btn-poi-card btn-poi-delete" type="submit">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="poi-empty-state">
        <i class="bi bi-people"></i>
        <h3>No POI Profiles Found</h3>
        <p>Profiles are automatically created when intelligence entries are added.</p>
    </div>
    {% endif %}
    
</div>

<script>
function filterPOIs() {
    const searchValue = document.getElementById('poiSearchInput').value.toLowerCase();
    const cards = document.querySelectorAll('.poi-card');
    
    cards.forEach(card => {
        const searchData = card.getAttribute('data-search');
        if (searchData.includes(searchValue)) {
            card.style.display = '';
        } else {
            card.style.display = 'none';
        }
    });
}
</script>

<!-- Rebuild POI Modal (Admin Only) -->
{% if current_user.is_admin %}
<div class="modal fade" id="rebuildPoiModal" tabindex="-1" aria-labelledby="rebuildPoiModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rebuildPoiModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Rebuild POI List
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-circle-fill me-2"></i>
                    <strong>Warning:</strong> This will delete ALL existing POI profiles and rebuild them from scratch.
                </div>
                
                <p>This action will:</p>
                <ol>
                    <li><strong>Delete</strong> all {{ targets|length }} existing POI profiles</li>
                    <li><strong>Scan</strong> all intelligence sources:
                        <ul>
                            <li><i class="bi bi-envelope text-primary"></i> Email records</li>
                            <li><i class="bi bi-chat text-success"></i> WhatsApp entries</li>
                            <li><i class="bi bi-globe text-warning"></i> Online Patrol entries</li>
                            <li><i class="bi bi-hand-index text-info"></i> Received By Hand entries</li>
                        </ul>
                    </li>
                    <li><strong>Re-create</strong> POI profiles from alleged subjects in each source</li>
                </ol>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    This is useful when POI profiles are missing or out of sync with intelligence records.
                </div>
                
                <p class="text-danger fw-bold">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('rebuild_poi_list') }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-arrow-repeat me-1"></i> Yes, Rebuild POI List
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
