{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h2 class="text-white mb-2">
                        <i class="bi bi-graph-up-arrow me-2"></i>INT Reference Statistics Dashboard
                    </h2>
                    <p class="text-white-50 mb-0">
                        Unique allegations across Email, WhatsApp, and Online Patrol sources
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-hash" style="font-size: 3rem; color: #667eea;"></i>
                    </div>
                    <h1 class="display-4 fw-bold text-primary mb-2">{{ unique_allegations }}</h1>
                    <h6 class="text-muted mb-0">Unique Allegations</h6>
                    <small class="text-muted">Distinct INT numbers</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-collection" style="font-size: 3rem; color: #28a745;"></i>
                    </div>
                    <h1 class="display-4 fw-bold text-success mb-2">{{ total_items }}</h1>
                    <h6 class="text-muted mb-0">Total Intelligence Items</h6>
                    <small class="text-muted">All sources combined</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-diagram-3" style="font-size: 3rem; color: #fd7e14;"></i>
                    </div>
                    <h1 class="display-4 fw-bold text-warning mb-2">{{ multi_source_count }}</h1>
                    <h6 class="text-muted mb-0">Multi-Source Cases</h6>
                    <small class="text-muted">Allegations from 2+ sources</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-percent" style="font-size: 3rem; color: #17a2b8;"></i>
                    </div>
                    <h1 class="display-4 fw-bold text-info mb-2">
                        {{ "%.1f"|format((total_items / unique_allegations if unique_allegations > 0 else 0)) }}
                    </h1>
                    <h6 class="text-muted mb-0">Avg Items per Case</h6>
                    <small class="text-muted">Intelligence density</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Breakdown -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill me-2 text-primary"></i>Source Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Source Type</th>
                                    <th class="text-center">Total Items</th>
                                    <th class="text-center">Unique INT</th>
                                    <th class="text-end">Ratio</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for source_type, count, unique_int in source_breakdown %}
                                <tr>
                                    <td>
                                        {% if source_type == 'EMAIL' %}
                                            <span class="badge bg-primary"><i class="bi bi-envelope"></i> Email</span>
                                        {% elif source_type == 'WHATSAPP' %}
                                            <span class="badge bg-success"><i class="bi bi-whatsapp"></i> WhatsApp</span>
                                        {% elif source_type == 'PATROL' %}
                                            <span class="badge bg-warning text-dark"><i class="bi bi-shield"></i> Patrol</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ source_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center"><strong>{{ count }}</strong></td>
                                    <td class="text-center"><strong>{{ unique_int }}</strong></td>
                                    <td class="text-end">
                                        <span class="badge bg-light text-dark">
                                            {{ "%.2f"|format((count / unique_int if unique_int > 0 else 0)) }} items/INT
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle-fill me-2 text-info"></i>Understanding INT Numbers
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb me-2"></i>What is an INT Number?
                        </h6>
                        <p class="mb-0">
                            An INT (Intelligence Reference) number groups related intelligence from different sources 
                            about the same allegation. For example, <code>INT-007</code> might contain:
                        </p>
                    </div>

                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <span class="badge bg-primary me-2">EMAIL-182</span> Initial complaint email
                        </li>
                        <li class="mb-2">
                            <span class="badge bg-primary me-2">EMAIL-189</span> Follow-up from complainant
                        </li>
                        <li class="mb-2">
                            <span class="badge bg-success me-2">WHATSAPP-23</span> WhatsApp conversation
                        </li>
                        <li class="mb-2">
                            <span class="badge bg-warning text-dark me-2">PATROL-15</span> Online patrol finding
                        </li>
                    </ul>

                    <p class="text-muted small mb-0">
                        <i class="bi bi-arrow-right me-1"></i>
                        All 4 sources above would share <code>INT-007</code> representing ONE unique allegation.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Allegations Table -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy-fill me-2 text-warning"></i>Top 20 Allegations by Volume
                    </h5>
                    <a href="{{ url_for('int_source') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-left me-1"></i>Back to INT Source
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4" style="width: 5%;">#</th>
                                    <th style="width: 15%;">INT Number</th>
                                    <th style="width: 10%;">Volume</th>
                                    <th style="width: 20%;">Sources</th>
                                    <th>Alleged Subject</th>
                                    <th class="text-center pe-4" style="width: 10%;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for int_ref, item_count, subject, sources in top_allegations %}
                                <tr>
                                    <td class="ps-4 text-muted">{{ loop.index }}</td>
                                    <td>
                                        <code class="fs-6 fw-bold">{{ int_ref }}</code>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary rounded-pill">{{ item_count }} items</span>
                                    </td>
                                    <td>
                                        {% if sources %}
                                            {% for source in sources %}
                                                {% if source == 'EMAIL' %}
                                                    <span class="badge bg-primary me-1">Email</span>
                                                {% elif source == 'WHATSAPP' %}
                                                    <span class="badge bg-success me-1">WhatsApp</span>
                                                {% elif source == 'PATROL' %}
                                                    <span class="badge bg-warning text-dark me-1">Patrol</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 400px;" title="{{ subject or 'N/A' }}">
                                            {{ subject or 'N/A' }}
                                        </span>
                                    </td>
                                    <td class="text-center pe-4">
                                        <a href="{{ url_for('int_source', filter_int=int_ref) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.table thead th {
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

code {
    padding: 4px 8px;
    background-color: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}
