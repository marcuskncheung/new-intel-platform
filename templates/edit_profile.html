{% extends "base.html" %}

{% block title %}Edit Profile: {{ profile.name_english }} - Intelligence Platform{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('poi.alleged_subject_profiles') }}">Profiles</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('poi.profile_detail', profile_id=profile.id) }}">{{ profile.name_english }}</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <h2><i class="bi bi-pencil-square"></i> Edit Profile: {{ profile.name_english }}</h2>
        </div>
    </div>

    <!-- Edit Form -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-person-vcard"></i> Profile Information</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('poi.edit_profile', profile_id=profile.id) }}" method="POST">
                        <!-- Basic Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="name_english" class="form-label">English Name *</label>
                                <input type="text" class="form-control" id="name_english" name="name_english" 
                                       value="{{ profile.name_english }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="name_chinese" class="form-label">Chinese Name</label>
                                <input type="text" class="form-control" id="name_chinese" name="name_chinese" 
                                       value="{{ profile.name_chinese or '' }}">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="license_number" class="form-label">License Number</label>
                                <input type="text" class="form-control" id="license_number" name="license_number" 
                                       value="{{ profile.license_number or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="company_broker" class="form-label">Company/Broker</label>
                                <input type="text" class="form-control" id="company_broker" name="company_broker" 
                                       value="{{ profile.company_broker or '' }}">
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="phone_numbers" class="form-label">Phone Numbers</label>
                                <input type="text" class="form-control" id="phone_numbers" name="phone_numbers" 
                                       value="{{ phone_numbers|join(', ') if phone_numbers else '' }}"
                                       placeholder="Separate multiple numbers with commas">
                                <div class="form-text">Example: +852 1234 5678, 9876 5432</div>
                            </div>
                            <div class="col-md-6">
                                <label for="email_addresses" class="form-label">Email Addresses</label>
                                <input type="text" class="form-control" id="email_addresses" name="email_addresses" 
                                       value="{{ email_addresses|join(', ') if email_addresses else '' }}"
                                       placeholder="Separate multiple emails with commas">
                                <div class="form-text">Example: john@email.com, john.doe@company.com</div>
                            </div>
                        </div>

                        <!-- Status Information -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="profile_status" class="form-label">Profile Status</label>
                                <select class="form-select" id="profile_status" name="profile_status">
                                    <option value="Active" {% if profile.profile_status == 'Active' %}selected{% endif %}>Active</option>
                                    <option value="Under Investigation" {% if profile.profile_status == 'Under Investigation' %}selected{% endif %}>Under Investigation</option>
                                    <option value="Resolved" {% if profile.profile_status == 'Resolved' %}selected{% endif %}>Resolved</option>
                                    <option value="Closed" {% if profile.profile_status == 'Closed' %}selected{% endif %}>Closed</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="investigation_status" class="form-label">Investigation Status</label>
                                <input type="text" class="form-control" id="investigation_status" name="investigation_status" 
                                       value="{{ profile.investigation_status or '' }}"
                                       placeholder="e.g., Pending Review, In Progress">
                            </div>
                            <div class="col-md-4">
                                <label for="assigned_investigator" class="form-label">Assigned Investigator</label>
                                <input type="text" class="form-control" id="assigned_investigator" name="assigned_investigator" 
                                       value="{{ profile.assigned_investigator or '' }}"
                                       placeholder="Investigator name">
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="4" 
                                          placeholder="Additional notes about this profile...">{{ profile.notes or '' }}</textarea>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="row">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg"></i> Save Changes
                                </button>
                                <a href="{{ url_for('poi.profile_detail', profile_id=profile.id) }}" class="btn btn-secondary">
                                    <i class="bi bi-x-lg"></i> Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Profile Summary -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Profile Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Current Risk Score</h6>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                <div class="progress-bar {% if profile.risk_score >= 80 %}bg-danger{% elif profile.risk_score >= 60 %}bg-warning{% elif profile.risk_score >= 40 %}bg-info{% else %}bg-success{% endif %}" 
                                     style="width: {{ profile.risk_score }}%">
                                    {{ "%.1f"|format(profile.risk_score) }}
                                </div>
                            </div>
                            <span class="badge {% if profile.priority_level == 'Critical' %}bg-danger{% elif profile.priority_level == 'High' %}bg-warning{% elif profile.priority_level == 'Medium' %}bg-info{% else %}bg-success{% endif %}">
                                {{ profile.priority_level }}
                            </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6>Statistics</h6>
                        <ul class="list-unstyled">
                            <li><strong>Total Allegations:</strong> {{ profile.total_allegations }}</li>
                            <li><strong>Unique Complainants:</strong> {{ profile.unique_complainants }}</li>
                            {% if profile.first_allegation_date %}
                            <li><strong>First Allegation:</strong> {{ profile.first_allegation_date.strftime('%Y-%m-%d') }}</li>
                            {% endif %}
                            {% if profile.last_allegation_date %}
                            <li><strong>Last Allegation:</strong> {{ profile.last_allegation_date.strftime('%Y-%m-%d') }}</li>
                            {% endif %}
                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6>System Information</h6>
                        <ul class="list-unstyled small text-muted">
                            <li><strong>Created:</strong> {{ profile.created_at.strftime('%Y-%m-%d %H:%M') }}</li>
                            <li><strong>Created By:</strong> {{ profile.created_by or 'Unknown' }}</li>
                            <li><strong>Last Updated:</strong> {{ profile.updated_at.strftime('%Y-%m-%d %H:%M') }}</li>
                        </ul>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb"></i>
                        <strong>Note:</strong> Risk scores and analytics are automatically calculated based on allegations. Changes to profile information will not affect the calculated risk score.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
