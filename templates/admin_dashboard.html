{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-shield-lock-fill"></i> Admin Dashboard</h2>
        <div class="btn-group" role="group">
          <a href="{{ url_for('admin_users') }}" class="btn btn-primary">
            <i class="bi bi-people-fill"></i> Manage Users
          </a>
          <a href="{{ url_for('admin_logs') }}" class="btn btn-info">
            <i class="bi bi-file-text"></i> Activity Logs
          </a>
          <a href="{{ url_for('security_admin') }}" class="btn btn-warning">
            <i class="bi bi-shield-lock-fill"></i> Security Admin
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ total_users }}</h4>
              <p class="mb-0">Total Users</p>
            </div>
            <div class="align-self-center">
              <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ active_users }}</h4>
              <p class="mb-0">Active Users</p>
            </div>
            <div class="align-self-center">
              <i class="bi bi-person-check-fill" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4>{{ admin_users }}</h4>
              <p class="mb-0">Admin Users</p>
            </div>
            <div class="align-self-center">
              <i class="bi bi-shield-fill-check" style="font-size: 2rem;"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h4><i class="bi bi-check-circle-fill"></i></h4>
              <p class="mb-0">Security Enabled</p>
              <small>Encryption & Audit Trail</small>
            </div>
            <div class="align-self-center">
              <i class="bi bi-shield-lock-fill" style="font-size: 2rem;"></i>
            </div>
          </div>
          <div class="mt-2">
            <a href="{{ url_for('security_admin') }}" class="btn btn-outline-light btn-sm">
              <i class="bi bi-gear-fill"></i> Security Admin
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- System Information -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5><i class="bi bi-cpu"></i> System Information</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <tr>
              <td><strong>Platform:</strong></td>
              <td>{{ system_info.platform }}</td>
            </tr>
            <tr>
              <td><strong>Python Version:</strong></td>
              <td>{{ system_info.python_version }}</td>
            </tr>
            <tr>
              <td><strong>CPU Usage:</strong></td>
              <td>
                {% if system_info.cpu_percent != 'N/A' and 'psutil' not in system_info.cpu_percent|string %}
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar {% if system_info.cpu_percent > 80 %}bg-danger{% elif system_info.cpu_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                         role="progressbar" style="width: {{ system_info.cpu_percent }}%">
                      {{ system_info.cpu_percent }}%
                    </div>
                  </div>
                {% else %}
                  {{ system_info.cpu_percent }}
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Memory Usage:</strong></td>
              <td>
                {% if system_info.memory_percent != 'N/A' and 'psutil' not in system_info.memory_percent|string %}
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar {% if system_info.memory_percent > 80 %}bg-danger{% elif system_info.memory_percent > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                         role="progressbar" style="width: {{ system_info.memory_percent }}%">
                      {{ system_info.memory_percent }}%
                    </div>
                  </div>
                {% else %}
                  {{ system_info.memory_percent }}
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Disk Usage:</strong></td>
              <td>
                {% if system_info.disk_percent != 'N/A' and 'psutil' not in system_info.disk_percent|string %}
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar {% if system_info.disk_percent > 90 %}bg-danger{% elif system_info.disk_percent > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                         role="progressbar" style="width: {{ system_info.disk_percent }}%">
                      {{ system_info.disk_percent }}%
                    </div>
                  </div>
                {% else %}
                  {{ system_info.disk_percent }}
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>

      <!-- Server Controls -->
      <div class="card mt-3">
        <div class="card-header">
          <h5><i class="bi bi-gear-fill"></i> Server Controls</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-warning" onclick="adminRestartServer()">
              <i class="bi bi-arrow-clockwise"></i> Restart Server
            </button>
            <button class="btn btn-danger" onclick="adminShutdownServer()">
              <i class="bi bi-power"></i> Shutdown Server
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h5><i class="bi bi-clock-history"></i> Recent Activity</h5>
        </div>
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          {% if recent_logs %}
            {% for log in recent_logs %}
              <div class="d-flex justify-content-between align-items-start mb-3 pb-2 border-bottom">
                <div class="flex-grow-1">
                  <div class="fw-bold">{{ log.action }}</div>
                  <small class="text-muted">
                    {{ log.username }} - {{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                  </small>
                  {% if log.details %}
                    <div class="small mt-1">{{ log.details }}</div>
                  {% endif %}
                </div>
                <span class="badge bg-secondary ms-2">{{ log.ip_address or 'N/A' }}</span>
              </div>
            {% endfor %}
            <div class="text-center">
              <a href="{{ url_for('admin_logs') }}" class="btn btn-sm btn-outline-primary">View All Logs</a>
            </div>
          {% else %}
            <p class="text-muted text-center">No recent activity</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function adminRestartServer() {
    if (confirm('Are you sure you want to restart the server? This will temporarily disconnect all users.')) {
        showAdminMessage('Restarting server...', 'warning');
        
        fetch('/admin/server/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAdminMessage('Server is restarting. Page will reload automatically...', 'info');
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            } else {
                showAdminMessage('Failed to restart server: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAdminMessage('Error communicating with server', 'danger');
        });
    }
}

function adminShutdownServer() {
    if (confirm('Are you sure you want to shutdown the server? This will stop the application completely.')) {
        showAdminMessage('Shutting down server...', 'warning');
        
        fetch('/admin/server/shutdown', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAdminMessage('Server is shutting down...', 'info');
            } else {
                showAdminMessage('Failed to shutdown server: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAdminMessage('Server may have shut down successfully', 'info');
        });
    }
}

function showAdminMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        <i class="bi bi-info-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
