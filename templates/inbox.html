{% extends "base.html" %}
{% block content %}
<h2>Email Inbox</h2>
<p>
  
  
  <a href="{{ url_for('inbox', export='excel') }}" class="btn btn-outline-success">Export Excel</a>
  <button id="refresh-emails-btn" class="btn btn-outline-info">Refresh</button>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('refresh-emails-btn');
      if(btn) {
        btn.addEventListener('click', function() {
          btn.disabled = true;
          btn.textContent = 'Refreshing...';
          fetch('/api/refresh-emails', {method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest'}})
            .then(resp => resp.json())
            .then(data => {
              if(data.success) {
                window.location.reload();
              } else {
                alert('Error: ' + (data.error || 'Unknown error'));
                btn.disabled = false;
                btn.textContent = 'Refresh';
              }
            })
            .catch(() => {
              alert('Failed to refresh emails.');
              btn.disabled = false;
              btn.textContent = 'Refresh';
            });
        });
      }
    });
  </script>
</p>
<table class="table table-sm">
  <thead>
    <tr>
      <th>Sender</th>
      <th>Subject</th>
      <th>Received</th>
      <th>Combined Score</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for email in emails %}
      {% set combined_score = (email.source_reliability or 0) + (email.content_validity or 0) %}
    <tr>
      <td>{{ email.sender }}</td>
      <td>{{ email.subject }}</td>
      <td>{{ email.received|strftime('%Y-%m-%d %H:%M:%S') }}</td>
      <td>
        {% if email.source_reliability is not none and email.content_validity is not none %}
          {{ combined_score }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if email.source_reliability is not none and email.content_validity is not none %}
          {% if email.intelligence_case_opened %}
            <span class="badge bg-success">Case Opened</span>
          {% else %}
            <span class="badge bg-secondary">Unsubstantial</span>
          {% endif %}
        {% else %}
          <span class="badge bg-light text-muted">Pending</span>
        {% endif %}
      </td>
      <td>
        <a href="{{ url_for('email_detail', email_id=email.id) }}" class="btn btn-sm btn-outline-primary">View</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}