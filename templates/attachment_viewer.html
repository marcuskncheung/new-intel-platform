{% extends "base.html" %}

{% block content %}
<!-- PDF.js Library for Ultimate Compatibility -->
<script src="{{ url_for('static', filename='js/pdf.min.js') }}"></script>

<!-- Mammoth.js for DOCX processing -->
<script src="{{ url_for('static', filename='js/mammoth.browser.min.js') }}"></script>

<!-- JSZip for ZIP file handling (required for DOCX) -->
<script src="{{ url_for('static', filename='js/jszip.min.js') }}"></script>

<script>
  // Configure PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = '{{ url_for("static", filename="js/pdf.worker.min.js") }}';
</script>
<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: #1669d2; color: #fff;">
      <div>
        <h5 class="mb-0">
          <i class="bi bi-paperclip me-2"></i>{{ attachment.filename }}
        </h5>
        <small>Size: {{ "%.2f"|format(file_size / 1024) }} KB | Type: {{ mimetype }}</small>
      </div>
      <div>
        <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
           class="btn btn-outline-light btn-sm me-2">
          <i class="bi bi-download"></i> Download
        </a>
        <button onclick="window.history.back()" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back
        </button>
      </div>
    </div>
    
    <div class="card-body">
      {% if file_extension in ['.pdf'] %}
        <!-- DIRECT PDF VIEWER - NO MORE BLANK SCREENS -->
        <div class="alert alert-warning mb-3">
          <i class="bi bi-file-earmark-pdf"></i>
          <strong>Direct PDF Viewer</strong> - IMMEDIATE display, no waiting for browser compatibility
        </div>
        
        {% if file_base64 and file_size < 52428800 %}
        <!-- IMMEDIATE PDF.JS CANVAS - SKIP UNRELIABLE METHODS -->
        <div id="pdf-viewer-container" style="width: 100%; height: 700px; border: 2px solid #dee2e6; border-radius: 8px; background: white; position: relative; overflow: hidden;">
          
          <!-- LOADING INDICATOR -->
          <div id="pdf-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 1000;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading PDF...</span>
            </div>
            <p class="mt-2 text-muted">Loading PDF.js direct renderer...</p>
            <p id="loading-status" class="small text-info">Bypassing browser methods, loading guaranteed renderer...</p>
          </div>
          
          <!-- DIRECT PDF.JS CANVAS (PRIMARY METHOD) -->
          <div id="pdf-canvas-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; overflow: auto; background: white;">
            <div style="text-align: center; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
              <button onclick="prevPage()" class="btn btn-sm btn-secondary me-2">
                <i class="bi bi-chevron-left"></i> Previous
              </button>
              <span id="page-info" style="margin: 0 15px; font-weight: bold;">Page 1 of 1</span>
              <button onclick="nextPage()" class="btn btn-sm btn-secondary me-2">
                <i class="bi bi-chevron-right"></i> Next
              </button>
              <button onclick="zoomIn()" class="btn btn-sm btn-info me-1">
                <i class="bi bi-zoom-in"></i>
              </button>
              <button onclick="zoomOut()" class="btn btn-sm btn-info">
                <i class="bi bi-zoom-out"></i>
              </button>
              <span id="zoom-info" style="margin-left: 15px; font-size: 12px;">100%</span>
            </div>
            <div id="canvas-wrapper" style="text-align: center; padding: 20px;">
              <canvas id="pdf-canvas" style="border: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></canvas>
            </div>
          </div>
          
          <!-- BACKUP IFRAME (HIDDEN, FOR FALLBACK) -->
          <iframe id="pdf-iframe-backup" 
                  src="data:application/pdf;base64,{{ file_base64 }}" 
                  width="100%" 
                  height="100%" 
                  style="border: none; position: absolute; top: 0; left: 0; display: none;">
          </iframe>
          
          <!-- SUCCESS MESSAGE -->
          <div id="pdf-success" style="position: absolute; top: 10px; right: 10px; z-index: 1001; display: none;">
            <div class="alert alert-success alert-sm p-2">
              <i class="bi bi-check-circle"></i> <span id="success-method">PDF loaded successfully!</span>
            </div>
          </div>
        </div>
        
        <!-- IMMEDIATE ACTION BUTTONS -->
        <div class="mt-3">
          <div class="alert alert-info">
            <strong>Multiple viewing options (no more blank screens):</strong><br>
            <div class="btn-group mt-2">
              <a href="data:application/pdf;base64,{{ file_base64 }}" 
                 target="_blank" 
                 class="btn btn-primary btn-sm">
                <i class="bi bi-window"></i> Open in New Window (GUARANTEED)
              </a>
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-secondary btn-sm">
                <i class="bi bi-download"></i> Download File
              </a>
              <button onclick="showIframeBackup()" class="btn btn-warning btn-sm">
                <i class="bi bi-arrow-repeat"></i> Try Browser Method
              </button>
              <button onclick="reloadPdfJs()" class="btn btn-info btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Reload PDF.js
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <strong>Current method:</strong> <span id="current-method-display">Direct PDF.js Canvas (bypasses browser issues)</span>
              </small>
            </div>
          </div>
        </div>
        
        {% else %}
        <!-- LARGE FILE -->
        <div class="text-center py-5">
          <i class="bi bi-file-earmark-pdf" style="font-size: 4rem; color: #dc3545;"></i>
          <h4 class="mt-3">Large PDF File</h4>
          <p class="text-muted">This file ({{ "%.2f"|format(file_size / 1024 / 1024) }} MB) is too large for online viewing.</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-primary btn-lg">
            <i class="bi bi-download"></i> Download to View
          </a>
        </div>
        {% endif %}
        
      {% elif file_extension in ['.docx', '.doc'] %}
        <!-- DOCX/DOC VIEWER -->
        <div class="alert alert-info mb-3">
          <i class="bi bi-file-earmark-word"></i>
          <strong>Word Document Viewer</strong> - Real DOCX content extraction and display
        </div>
        
        {% if file_base64 and file_size < 52428800 %}
        <!-- REAL DOCX CONTENT VIEWER -->
        <div id="docx-viewer-container" style="width: 100%; min-height: 600px; border: 2px solid #dee2e6; border-radius: 8px; background: white; position: relative;">
          
          <!-- DOCX CONTENT DISPLAY AREA -->
          <div id="docx-content" style="width: 100%; height: 700px; padding: 20px; overflow-y: auto; background: white;">
            <div style="text-align: center; padding: 50px;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading DOCX processing library...</span>
              </div>
              <p class="mt-3 text-muted">Extracting content from Word document...</p>
              <p class="small text-info">Loading mammoth.js for DOCX processing...</p>
            </div>
          </div>
          
          <!-- SUCCESS MESSAGE -->
          <div id="docx-success" style="position: absolute; top: 10px; right: 10px; z-index: 1001; display: none;">
            <div class="alert alert-success alert-sm p-2">
              <i class="bi bi-check-circle"></i> <span id="docx-success-method">DOCX processed!</span>
            </div>
          </div>
          
          <!-- ERROR MESSAGE -->
          <div id="docx-error" style="position: absolute; top: 10px; right: 10px; z-index: 1001; display: none;">
            <div class="alert alert-warning alert-sm p-2">
              <i class="bi bi-exclamation-triangle"></i> <span id="docx-error-method">Processing failed</span>
            </div>
          </div>
        </div>
        
        <!-- DOCX VIEWING OPTIONS -->
        <div class="mt-3">
          <div class="alert alert-info">
            <strong>Word document viewing controls:</strong><br>
            <div class="btn-group mt-2">
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-primary btn-sm">
                <i class="bi bi-download"></i> Download Original
              </a>
              <button onclick="reprocessDocx()" class="btn btn-info btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Reload Document
              </button>
              <button onclick="showDocxAsText()" class="btn btn-secondary btn-sm">
                <i class="bi bi-file-text"></i> Text Only
              </button>
              <button onclick="zoomDocxIn()" class="btn btn-success btn-sm">
                <i class="bi bi-zoom-in"></i> Zoom In
              </button>
              <button onclick="zoomDocxOut()" class="btn btn-warning btn-sm">
                <i class="bi bi-zoom-out"></i> Zoom Out
              </button>
              <button onclick="resetDocxZoom()" class="btn btn-light btn-sm">
                <i class="bi bi-arrows-angle-contract"></i> Reset Zoom
              </button>
              <button onclick="openDocxNewWindow()" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-window"></i> New Window
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <strong>Status:</strong> <span id="docx-status">Loading DOCX processor...</span> | 
                <strong>Zoom:</strong> <span id="docx-zoom-level">100%</span>
              </small>
            </div>
          </div>
        </div>
        
        <!-- HIDDEN DOCX DATA -->
        <input type="hidden" id="docx-base64-data" value="{{ file_base64 }}">
        <input type="hidden" id="docx-filename" value="{{ attachment.filename }}">
        
        {% else %}
        <!-- LARGE DOCX FILE -->
        <div class="text-center py-5">
          <i class="bi bi-file-earmark-word" style="font-size: 4rem; color: #2b579a;"></i>
          <h4 class="mt-3">Large Word Document</h4>
          <p class="text-muted">This file ({{ "%.2f"|format(file_size / 1024 / 1024) }} MB) is too large for online viewing.</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-primary btn-lg">
            <i class="bi bi-download"></i> Download to View
          </a>
        </div>
        {% endif %}
        <!-- IMAGE VIEWER -->
        <div class="text-center">
          {% if file_base64 %}
          <img src="data:{{ mimetype }};base64,{{ file_base64 }}" 
               class="img-fluid" 
               style="max-height: 70vh; border: 1px solid #dee2e6; border-radius: 8px;"
               alt="{{ attachment.filename }}">
          {% else %}
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            Image file too large to display inline.
            <br>
            <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
               class="btn btn-primary mt-2">
              <i class="bi bi-download"></i> Download to View
            </a>
          </div>
          {% endif %}
        </div>
        
      {% elif file_extension in ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'] %}
        <!-- IMAGE VIEWER -->
        <div class="alert alert-success mb-3">
          <i class="bi bi-image"></i>
          <strong>Image Viewer</strong> - Displaying your image with zoom and viewing controls
        </div>
        
        {% if file_base64 and file_size < 52428800 %}
        <!-- IMAGE DISPLAY CONTAINER -->
        <div id="image-viewer-container" style="width: 100%; min-height: 600px; border: 2px solid #dee2e6; border-radius: 8px; background: #f8f9fa; position: relative; overflow: hidden;">
          
          <!-- IMAGE CONTENT AREA -->
          <div id="image-content" style="width: 100%; height: 700px; display: flex; align-items: center; justify-content: center; overflow: auto; background: #ffffff;">
            <img id="main-image" 
                 src="data:{{ attachment.mime_type or 'image/jpeg' }};base64,{{ file_base64 }}" 
                 alt="{{ attachment.filename }}"
                 style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease; cursor: zoom-in;">
          </div>
          
          <!-- IMAGE INFO OVERLAY -->
          <div id="image-info" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 100;">
            <div>📸 {{ attachment.filename }}</div>
            <div>📏 <span id="image-dimensions">Loading...</span></div>
            <div>💾 {{ "%.1f"|format(file_size / 1024 / 1024) }} MB</div>
          </div>
          
          <!-- ZOOM LEVEL INDICATOR -->
          <div id="zoom-indicator" style="position: absolute; top: 10px; right: 10px; background: rgba(13, 110, 253, 0.9); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; z-index: 100;">
            <span id="image-zoom-level">100%</span>
          </div>
          
          <!-- SUCCESS MESSAGE -->
          <div id="image-success" style="position: absolute; bottom: 10px; right: 10px; z-index: 1001; display: none;">
            <div class="alert alert-success alert-sm p-2">
              <i class="bi bi-check-circle"></i> <span id="image-success-method">Image loaded!</span>
            </div>
          </div>
        </div>
        
        <!-- IMAGE VIEWING CONTROLS -->
        <div class="mt-3">
          <div class="alert alert-info">
            <strong>Image viewing controls:</strong><br>
            <div class="btn-group mt-2">
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-primary btn-sm">
                <i class="bi bi-download"></i> Download Original
              </a>
              <button onclick="zoomImageIn()" class="btn btn-success btn-sm">
                <i class="bi bi-zoom-in"></i> Zoom In
              </button>
              <button onclick="zoomImageOut()" class="btn btn-warning btn-sm">
                <i class="bi bi-zoom-out"></i> Zoom Out
              </button>
              <button onclick="resetImageZoom()" class="btn btn-light btn-sm">
                <i class="bi bi-arrows-angle-contract"></i> Fit to Screen
              </button>
              <button onclick="toggleImageFullscreen()" class="btn btn-info btn-sm">
                <i class="bi bi-arrows-fullscreen"></i> Fullscreen
              </button>
              <button onclick="openImageNewWindow()" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-window"></i> New Window
              </button>
              <button onclick="rotateImage()" class="btn btn-secondary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Rotate
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <strong>Status:</strong> <span id="image-status">Image loaded successfully</span> | 
                <strong>Zoom:</strong> <span id="image-zoom-display">100%</span> |
                <strong>Size:</strong> <span id="image-size-display">Loading...</span>
              </small>
            </div>
          </div>
        </div>
        
        {% else %}
        <!-- LARGE IMAGE FILE -->
        <div class="text-center py-5">
          <i class="bi bi-image" style="font-size: 4rem; color: #198754;"></i>
          <h4 class="mt-3">Large Image File</h4>
          <p class="text-muted">File size: {{ "%.1f"|format(file_size / 1024 / 1024) }} MB</p>
          <p>This image is too large to display inline.</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-success">
            <i class="bi bi-download"></i> Download Image
          </a>
        </div>
        {% endif %}

      {% elif file_extension in ['.mp4', '.avi', '.mov', '.wmv', '.flv', '.webm', '.mkv', '.m4v'] %}
        <!-- VIDEO PLAYER - PROFESSIONAL LIKE PDF, DOCX AND IMAGE VIEWERS -->
        <div class="alert alert-success mb-3">
          <i class="bi bi-play-circle"></i>
          <strong>Video Player</strong> - Playing your video with full media controls
        </div>
        
        {% if file_base64 and file_size < 104857600 %}
        <!-- VIDEO DISPLAY CONTAINER -->
        <div id="video-viewer-container" style="width: 100%; min-height: 600px; border: 2px solid #dee2e6; border-radius: 8px; background: #000; position: relative; overflow: hidden;">
          
          <!-- VIDEO CONTENT AREA -->
          <div id="video-content" style="width: 100%; height: 600px; display: flex; align-items: center; justify-content: center; background: #000;">
            <video id="main-video" 
                   controls
                   preload="metadata"
                   style="width: 100%; height: 100%; object-fit: contain;"
                   onloadedmetadata="initializeVideoPlayer()"
                   onplay="updatePlayButton(true)"
                   onpause="updatePlayButton(false)"
                   ontimeupdate="updateVideoProgress()"
                   onvolumechange="updateVolumeDisplay()">
              <source src="data:{{ attachment.mime_type or 'video/mp4' }};base64,{{ file_base64 }}" type="{{ attachment.mime_type or 'video/mp4' }}">
              Your browser does not support the video tag.
            </video>
          </div>
          
          <!-- VIDEO INFO OVERLAY -->
          <div id="video-info" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 100;">
            <div>🎬 {{ attachment.filename }}</div>
            <div>📏 <span id="video-dimensions">Loading...</span></div>
            <div>⏱️ <span id="video-duration">Loading...</span></div>
            <div>💾 {{ "%.1f"|format(file_size / 1024 / 1024) }} MB</div>
          </div>
          
          <!-- PLAYBACK STATUS INDICATOR -->
          <div id="playback-indicator" style="position: absolute; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.9); color: white; padding: 6px 10px; border-radius: 6px; font-size: 12px; z-index: 100;">
            <span id="video-status-display">Ready to Play</span>
          </div>
          
          <!-- SUCCESS MESSAGE -->
          <div id="video-success" style="position: absolute; bottom: 10px; right: 10px; z-index: 1001; display: none;">
            <div class="alert alert-success alert-sm p-2">
              <i class="bi bi-check-circle"></i> <span id="video-success-method">Video loaded!</span>
            </div>
          </div>
        </div>
        
        <!-- CUSTOM VIDEO PROGRESS BAR -->
        <div class="mt-2">
          <div class="progress" style="height: 8px; cursor: pointer;" onclick="seekVideo(event)">
            <div class="progress-bar bg-danger" id="video-progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
          <div class="d-flex justify-content-between mt-1">
            <small class="text-muted" id="current-time">00:00</small>
            <small class="text-muted" id="total-duration">00:00</small>
          </div>
        </div>
        
        <!-- VIDEO PLAYER CONTROLS -->
        <div class="mt-3">
          <div class="alert alert-info">
            <strong>Video player controls:</strong><br>
            <div class="btn-group mt-2">
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-primary btn-sm">
                <i class="bi bi-download"></i> Download Original
              </a>
              <button onclick="playPauseVideo()" class="btn btn-success btn-sm" id="play-pause-btn">
                <i class="bi bi-play-fill" id="play-pause-icon"></i> <span id="play-pause-text">Play</span>
              </button>
              <button onclick="stopVideo()" class="btn btn-danger btn-sm">
                <i class="bi bi-stop-fill"></i> Stop
              </button>
              <button onclick="muteUnmuteVideo()" class="btn btn-warning btn-sm" id="mute-btn">
                <i class="bi bi-volume-up-fill" id="mute-icon"></i> <span id="mute-text">Mute</span>
              </button>
              <button onclick="toggleVideoFullscreen()" class="btn btn-info btn-sm">
                <i class="bi bi-arrows-fullscreen"></i> Fullscreen
              </button>
              <button onclick="openVideoNewWindow()" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-window"></i> New Window
              </button>
            </div>
            
            <!-- VOLUME CONTROL -->
            <div class="mt-3">
              <label for="volume-slider" class="form-label">Volume Control:</label>
              <div class="d-flex align-items-center">
                <i class="bi bi-volume-down me-2"></i>
                <input type="range" class="form-range flex-grow-1" id="volume-slider" min="0" max="100" value="100" oninput="changeVolume(this.value)">
                <i class="bi bi-volume-up ms-2"></i>
                <span class="ms-2 text-muted" id="volume-percentage">100%</span>
              </div>
            </div>
            
            <div class="mt-2">
              <small class="text-muted">
                <strong>Status:</strong> <span id="video-status">Video loaded successfully</span> | 
                <strong>Time:</strong> <span id="video-time-display">00:00 / 00:00</span> |
                <strong>Volume:</strong> <span id="video-volume-display">100%</span>
              </small>
            </div>
          </div>
        </div>
        
        {% else %}
        <!-- LARGE VIDEO FILE -->
        <div class="text-center py-5">
          <i class="bi bi-play-circle" style="font-size: 4rem; color: #dc3545;"></i>
          <h4 class="mt-3">Large Video File</h4>
          <p class="text-muted">File size: {{ "%.1f"|format(file_size / 1024 / 1024) }} MB</p>
          <p>This video is too large to play inline (limit: 100MB).</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-danger">
            <i class="bi bi-download"></i> Download Video
          </a>
        </div>
        {% endif %}

      {% elif file_extension in ['.msg'] %}
        <!-- MSG EMAIL VIEWER - PROFESSIONAL LIKE PDF, DOCX, IMAGE AND VIDEO VIEWERS -->
        <div class="alert alert-success mb-3">
          <i class="bi bi-envelope-open"></i>
          <strong>MSG Email Viewer</strong> - Displaying Outlook email message content
        </div>
        
        {% if file_base64 and file_size < 52428800 %}
        <!-- MSG DISPLAY CONTAINER -->
        <div id="msg-viewer-container" style="width: 100%; min-height: 600px; border: 2px solid #dee2e6; border-radius: 8px; background: #f8f9fa; position: relative; overflow: hidden;">
          
          <!-- MSG CONTENT AREA -->
          <div id="msg-content" style="width: 100%; height: 700px; overflow: auto; background: #ffffff; padding: 20px;">
            <div id="msg-loading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-3">Extracting email content from MSG file...</p>
            </div>
            
            <!-- EMAIL HEADER SECTION -->
            <div id="email-header" style="display: none; border-bottom: 2px solid #dee2e6; padding-bottom: 15px; margin-bottom: 20px;">
              <div class="row">
                <div class="col-md-8">
                  <h4 id="email-subject" style="color: #0d6efd; margin-bottom: 10px;"></h4>
                  <div class="email-meta">
                    <div><strong>From:</strong> <span id="email-from"></span></div>
                    <div><strong>To:</strong> <span id="email-to"></span></div>
                    <div id="email-cc-row" style="display: none;"><strong>CC:</strong> <span id="email-cc"></span></div>
                    <div><strong>Date:</strong> <span id="email-date"></span></div>
                  </div>
                </div>
                <div class="col-md-4 text-end">
                  <div class="email-info">
                    <small class="text-muted">
                      <div>📧 Outlook Message</div>
                      <div>📏 <span id="msg-size">{{ "%.1f"|format(file_size / 1024 / 1024) }} MB</span></div>
                      <div>📎 <span id="attachment-count">0</span> attachments</div>
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- EMAIL BODY SECTION -->
            <div id="email-body" style="display: none;">
              <div id="email-html-content" style="display: none; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; background: #fff;"></div>
              <div id="email-text-content" style="display: none; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; background: #f8f9fa; white-space: pre-wrap; font-family: monospace; font-size: 13px;"></div>
            </div>
            
            <!-- EMAIL ATTACHMENTS SECTION -->
            <div id="email-attachments" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
              <h5><i class="bi bi-paperclip"></i> Email Attachments</h5>
              <div id="attachment-list" class="mt-2"></div>
            </div>
            
            <!-- FALLBACK TEXT DISPLAY -->
            <div id="msg-text-fallback" style="display: none;">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Note:</strong> Advanced MSG parsing not available. Showing raw text content:
              </div>
              <div style="border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; background: #f8f9fa;">
                <pre id="msg-raw-text" style="white-space: pre-wrap; font-size: 12px; max-height: 500px; overflow-y: auto;"></pre>
              </div>
            </div>
          </div>
          
          <!-- MSG INFO OVERLAY -->
          <div id="msg-info" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 100;">
            <div>📧 {{ attachment.filename }}</div>
            <div>💾 {{ "%.1f"|format(file_size / 1024 / 1024) }} MB</div>
            <div>📊 <span id="msg-status-display">Loading...</span></div>
          </div>
          
          <!-- SUCCESS MESSAGE -->
          <div id="msg-success" style="position: absolute; bottom: 10px; right: 10px; z-index: 1001; display: none;">
            <div class="alert alert-success alert-sm p-2">
              <i class="bi bi-check-circle"></i> <span id="msg-success-method">Email loaded!</span>
            </div>
          </div>
        </div>
        
        <!-- MSG VIEWING CONTROLS -->
        <div class="mt-3">
          <div class="alert alert-info">
            <strong>Email viewing controls:</strong><br>
            <div class="btn-group mt-2">
              <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
                 class="btn btn-primary btn-sm">
                <i class="bi bi-download"></i> Download Original
              </a>
              <button onclick="toggleEmailView('html')" class="btn btn-success btn-sm" id="html-view-btn">
                <i class="bi bi-code-slash"></i> HTML View
              </button>
              <button onclick="toggleEmailView('text')" class="btn btn-warning btn-sm" id="text-view-btn">
                <i class="bi bi-file-text"></i> Text View
              </button>
              <button onclick="zoomMsgContent('in')" class="btn btn-info btn-sm">
                <i class="bi bi-zoom-in"></i> Zoom In
              </button>
              <button onclick="zoomMsgContent('out')" class="btn btn-light btn-sm">
                <i class="bi bi-zoom-out"></i> Zoom Out
              </button>
              <button onclick="openMsgNewWindow()" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-window"></i> New Window
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <strong>Status:</strong> <span id="msg-status">Processing MSG file...</span> | 
                <strong>View:</strong> <span id="msg-view-mode">Auto-detecting</span> |
                <strong>Zoom:</strong> <span id="msg-zoom-level">100%</span>
              </small>
            </div>
          </div>
        </div>
        
        {% else %}
        <!-- LARGE MSG FILE -->
        <div class="text-center py-5">
          <i class="bi bi-envelope-x" style="font-size: 4rem; color: #dc3545;"></i>
          <h4 class="mt-3">Large MSG File</h4>
          <p class="text-muted">File size: {{ "%.1f"|format(file_size / 1024 / 1024) }} MB</p>
          <p>This MSG file is too large to display inline (limit: 50MB).</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-danger">
            <i class="bi bi-download"></i> Download MSG File
          </a>
        </div>
        {% endif %}

      {% elif file_extension in ['.txt', '.log'] %}
        <!-- TEXT FILE VIEWER -->
        {% if file_base64 and file_size < 1048576 %}
        <div class="card">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0"><i class="bi bi-file-earmark-text"></i> Text Content</h6>
          </div>
          <div class="card-body">
            <pre style="max-height: 500px; overflow-y: auto; white-space: pre-wrap; font-size: 12px;">{{ file_base64 | b64decode }}</pre>
          </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
          <i class="bi bi-file-earmark-text"></i>
          <h5>Text File</h5>
          <p>File too large to display inline or content not available.</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-primary">
            <i class="bi bi-download"></i> Download to View
          </a>
        </div>
        {% endif %}
        
      {% else %}
        <!-- GENERIC FILE VIEWER -->
        <div class="alert alert-info text-center">
          <i class="bi bi-file-earmark"></i>
          <h5>{{ attachment.filename }}</h5>
          <p>File type: {{ mimetype }}</p>
          <p>This file type cannot be previewed online.</p>
          <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
             class="btn btn-primary btn-lg">
            <i class="bi bi-download"></i> Download File
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// DIRECT PDF VIEWER - NO MORE BLANK SCREENS
let pdfDoc = null;
let pageNum = 1;
let pageRendering = false;
let pageNumPending = null;
let scale = 1.0;
let canvas = null;
let ctx = null;
let pdfData = null;

document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 DIRECT PDF Viewer: Skipping unreliable methods, loading PDF.js immediately');
  initializeDirectPdfViewer();
});

function initializeDirectPdfViewer() {
  updateLoadingStatus('Loading PDF.js directly - no more blank screens...');
  
  // Get PDF data from base64
  const base64Data = "{{ file_base64 }}";
  if (base64Data) {
    pdfData = "data:application/pdf;base64," + base64Data;
  }
  
  canvas = document.getElementById('pdf-canvas');
  if (canvas) {
    ctx = canvas.getContext('2d');
  }
  
  // Start PDF.js immediately (no waiting for browser methods)
  setTimeout(() => {
    loadPdfWithPdfJs();
  }, 1000);
}

function loadPdfWithPdfJs() {
  console.log('📄 Loading PDF directly with PDF.js (bypassing browser compatibility issues)...');
  updateLoadingStatus('PDF.js loading - this will definitely work...');
  
  if (!pdfData || typeof pdfjsLib === 'undefined') {
    console.error('❌ PDF.js library not loaded or no PDF data');
    showIframeBackup();
    return;
  }
  
  try {
    // Convert data URL to array buffer
    const base64String = pdfData.split(',')[1];
    const binaryString = atob(base64String);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    console.log('📄 Converting PDF data, size:', bytes.length, 'bytes');
    
    pdfjsLib.getDocument({data: bytes}).promise.then(function(pdf) {
      console.log('✅ PDF loaded successfully with PDF.js! Pages:', pdf.numPages);
      pdfDoc = pdf;
      
      // Update page info
      document.getElementById('page-info').textContent = `Page 1 of ${pdf.numPages}`;
      
      // Render first page immediately
      renderPage(1);
      
      showSuccess('PDF.js Canvas - PDF content loaded and displaying!');
      hideLoading();
      
    }).catch(function(error) {
      console.error('❌ PDF.js failed to load PDF:', error);
      console.log('🔄 Falling back to iframe method...');
      showIframeBackup();
    });
    
  } catch (error) {
    console.error('❌ Error processing PDF data:', error);
    showIframeBackup();
  }
}

function renderPage(num) {
  if (!pdfDoc) {
    console.error('❌ No PDF document loaded');
    return;
  }
  
  pageRendering = true;
  console.log('🎨 Rendering page', num, 'at scale', scale);
  
  pdfDoc.getPage(num).then(function(page) {
    const viewport = page.getViewport({scale: scale});
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    
    console.log('📐 Canvas size:', canvas.width, 'x', canvas.height);
    
    const renderContext = {
      canvasContext: ctx,
      viewport: viewport
    };
    
    const renderTask = page.render(renderContext);
    
    renderTask.promise.then(function() {
      pageRendering = false;
      console.log('✅ Page', num, 'rendered successfully');
      
      if (pageNumPending !== null) {
        renderPage(pageNumPending);
        pageNumPending = null;
      }
    });
  }).catch(function(error) {
    console.error('❌ Error rendering page:', error);
    pageRendering = false;
  });
  
  // Update page info
  document.getElementById('page-info').textContent = `Page ${num} of ${pdfDoc.numPages}`;
}

function queueRenderPage(num) {
  if (pageRendering) {
    pageNumPending = num;
  } else {
    renderPage(num);
  }
}

function showIframeBackup() {
  console.log('🔄 Switching to iframe backup method');
  const canvasContainer = document.getElementById('pdf-canvas-container');
  const iframeBackup = document.getElementById('pdf-iframe-backup');
  const loading = document.getElementById('pdf-loading');
  
  if (canvasContainer) canvasContainer.style.display = 'none';
  if (loading) loading.style.display = 'none';
  if (iframeBackup) {
    iframeBackup.style.display = 'block';
    showSuccess('Iframe backup method - PDF should display now');
  }
  
  updateCurrentMethodDisplay('Browser iframe fallback');
}

function reloadPdfJs() {
  console.log('🔄 Reloading PDF.js renderer');
  const loading = document.getElementById('pdf-loading');
  const canvasContainer = document.getElementById('pdf-canvas-container');
  const iframeBackup = document.getElementById('pdf-iframe-backup');
  
  if (loading) loading.style.display = 'block';
  if (canvasContainer) canvasContainer.style.display = 'block';
  if (iframeBackup) iframeBackup.style.display = 'none';
  
  updateCurrentMethodDisplay('Direct PDF.js Canvas (reloading)');
  
  // Reset variables
  pdfDoc = null;
  pageNum = 1;
  scale = 1.0;
  
  // Reload
  setTimeout(() => {
    loadPdfWithPdfJs();
  }, 500);
}

// Navigation functions
function prevPage() {
  if (!pdfDoc || pageNum <= 1) return;
  pageNum--;
  queueRenderPage(pageNum);
}

function nextPage() {
  if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
  pageNum++;
  queueRenderPage(pageNum);
}

function zoomIn() {
  scale *= 1.2;
  document.getElementById('zoom-info').textContent = Math.round(scale * 100) + '%';
  if (pdfDoc) queueRenderPage(pageNum);
}

function zoomOut() {
  scale /= 1.2;
  document.getElementById('zoom-info').textContent = Math.round(scale * 100) + '%';
  if (pdfDoc) queueRenderPage(pageNum);
}

// Utility functions
function updateLoadingStatus(message) {
  const status = document.getElementById('loading-status');
  if (status) {
    status.textContent = message;
  }
}

function updateCurrentMethodDisplay(method) {
  const display = document.getElementById('current-method-display');
  if (display) {
    display.textContent = method || 'Direct PDF.js Canvas (bypasses browser issues)';
  }
}

function showSuccess(message) {
  const success = document.getElementById('pdf-success');
  const successMethod = document.getElementById('success-method');
  if (success && successMethod) {
    successMethod.textContent = message;
    success.style.display = 'block';
    setTimeout(() => {
      success.style.display = 'none';
    }, 5000);
  }
}

function hideLoading() {
  const loading = document.getElementById('pdf-loading');
  if (loading) {
    loading.style.display = 'none';
  }
}

// DOCX VIEWER FUNCTIONS - REAL CONTENT EXTRACTION
document.addEventListener('DOMContentLoaded', function() {
  // Check if we have a DOCX file
  const docxContainer = document.getElementById('docx-viewer-container');
  if (docxContainer) {
    initializeRealDocxViewer();
  }
});

function initializeRealDocxViewer() {
  console.log('📄 REAL DOCX Viewer: Starting actual DOCX processing...');
  updateDocxStatus('Loading DOCX processing libraries...');
  
  // Check if mammoth.js is loaded
  if (typeof mammoth === 'undefined') {
    console.error('❌ Mammoth.js library not loaded');
    showDocxError('DOCX library not loaded - trying alternative method...');
    fallbackDocxDisplay();
    return;
  }
  
  console.log('✅ Mammoth.js library loaded successfully');
  updateDocxStatus('DOCX library loaded, processing document...');
  
  // Get the base64 data
  const base64Data = document.getElementById('docx-base64-data').value;
  const filename = document.getElementById('docx-filename').value;
  
  if (!base64Data) {
    console.error('❌ No DOCX base64 data available');
    showDocxError('No document data available');
    return;
  }
  
  console.log('📄 Processing DOCX file:', filename);
  updateDocxStatus('Converting base64 data to binary...');
  
  try {
    // Convert base64 to binary
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    console.log('✅ Base64 converted to binary, size:', bytes.length, 'bytes');
    updateDocxStatus('Extracting DOCX content with Mammoth.js...');
    
    // Process DOCX with mammoth.js - ENHANCED FOR BETTER FORMATTING
    console.log('📄 Starting mammoth.js HTML conversion...');
    mammoth.convertToHtml({arrayBuffer: bytes.buffer}, {
      styleMap: [
        // Enhanced style mapping for better Word document display
        "p[style-name='Heading 1'] => h1:fresh",
        "p[style-name='Heading 2'] => h2:fresh", 
        "p[style-name='Heading 3'] => h3:fresh",
        "p[style-name='Heading 4'] => h4:fresh",
        "p[style-name='Title'] => h1.title:fresh",
        "p[style-name='Subtitle'] => h2.subtitle:fresh",
        "p[style-name='Quote'] => blockquote:fresh",
        "r[style-name='Strong'] => strong",
        "r[style-name='Emphasis'] => em",
        "table => table.docx-table:fresh"
      ],
      convertImage: mammoth.images.imgElement(function(image) {
        // Handle images in DOCX
        return image.read("base64").then(function(imageBuffer) {
          return {
            src: "data:" + image.contentType + ";base64," + imageBuffer
          };
        });
      }),
      includeDefaultStyleMap: true,
      includeEmbeddedStyleMap: true
    })
      .then(function(result) {
        console.log('✅ Mammoth.js HTML conversion result:', result);
        console.log('📄 HTML content length:', result.html ? result.html.length : 0);
        console.log('⚠️ Conversion messages:', result.messages.length);
        
        // Check if we got actual HTML content
        if (result.html && result.html.trim().length > 0) {
          console.log('✅ DOCX HTML conversion successful!');
          displayDocxContent(result.html, filename, result.messages);
          showDocxSuccess('DOCX content extracted and displayed with formatting!');
          updateDocxStatus('DOCX document displayed successfully with original formatting!');
        } else {
          console.log('⚠️ HTML conversion returned empty, trying text extraction...');
          // If HTML conversion failed, try text extraction as fallback
          extractDocxTextAsFallback(bytes, filename);
        }
      })
      .catch(function(error) {
        console.error('❌ Mammoth.js HTML conversion failed:', error);
        console.log('🔄 Falling back to text extraction...');
        // Try text extraction as fallback
        extractDocxTextAsFallback(bytes, filename);
      });
      
} catch (error) {
  console.error('❌ Base64 conversion failed:', error);
  showDocxError('Data conversion failed - showing alternative view');
  fallbackDocxDisplay();
}
}

function displayDocxContent(htmlContent, filename, messages) {
  const docxContent = document.getElementById('docx-content');
  
  // Create a proper document display with the extracted HTML - LIKE PDF VIEWER
  docxContent.innerHTML = `
    <div style="max-width: 100%; margin: 0; padding: 0; background: white; height: 100%;">
      <!-- DOCX DOCUMENT HEADER -->
      <div style="background: #0d6efd; color: white; padding: 15px; margin-bottom: 0; position: sticky; top: 0; z-index: 100;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h5 style="margin: 0; color: white;">📄 ${filename}</h5>
            <small style="color: #e3f2fd;">Word Document - Formatted View</small>
          </div>
          <div>
            ${messages && messages.length > 0 ? 
              `<span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px;">⚠️ ${messages.length} notes</span>` : 
              `<span style="background: #198754; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">✅ Clean</span>`
            }
          </div>
        </div>
      </div>
      
      <!-- DOCX DOCUMENT CONTENT - FULL FORMAT LIKE PDF -->
      <div style="background: white; padding: 40px; min-height: 600px; font-family: 'Segoe UI', 'Times New Roman', serif; line-height: 1.6; color: #333;">
        <style>
          /* DOCX STYLING - MAKE IT LOOK LIKE REAL WORD DOCUMENT */
          .docx-content h1, .docx-content h2, .docx-content h3, .docx-content h4, .docx-content h5, .docx-content h6 {
            color: #2c3e50;
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: bold;
          }
          .docx-content h1 { font-size: 2em; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
          .docx-content h2 { font-size: 1.6em; color: #2980b9; }
          .docx-content h3 { font-size: 1.4em; color: #3498db; }
          .docx-content h4 { font-size: 1.2em; color: #34495e; }
          .docx-content p { margin-bottom: 12px; text-align: justify; }
          .docx-content ul, .docx-content ol { margin: 16px 0; padding-left: 30px; }
          .docx-content li { margin-bottom: 6px; }
          .docx-content table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          }
          .docx-content th, .docx-content td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
          }
          .docx-content th { 
            background-color: #f8f9fa; 
            font-weight: bold; 
            color: #495057;
          }
          .docx-content blockquote {
            border-left: 4px solid #3498db;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
          }
          .docx-content strong { color: #2c3e50; }
          .docx-content em { color: #7f8c8d; }
          .docx-content code {
            background: #f1f2f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #e74c3c;
          }
        </style>
        
        <div class="docx-content">
          ${htmlContent || '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 40px;">No readable content found in this document.</p>'}
        </div>
      </div>
      
      <!-- CONVERSION NOTES (if any) -->
      ${messages && messages.length > 0 ? `
        <div style="background: #fff8e1; border-top: 1px solid #ffecb3; padding: 20px; margin-top: 0;">
          <h6 style="color: #f57f17; margin-bottom: 15px; font-size: 14px;">📝 Document Conversion Notes:</h6>
          <div style="max-height: 100px; overflow-y: auto;">
            ${messages.map(msg => `
              <div style="background: white; margin-bottom: 8px; padding: 8px 12px; border-radius: 4px; border-left: 3px solid #ffc107; font-size: 13px; color: #856404;">
                ${msg.message}
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      <!-- SUCCESS FOOTER -->
      <div style="background: #e8f5e8; padding: 20px; text-align: center; border-top: 1px solid #c8e6c8;">
        <div style="color: #2e7d32; font-weight: bold; margin-bottom: 8px; font-size: 16px;">✅ Word Document Displayed Successfully!</div>
        <div style="color: #388e3c; font-size: 14px;">Document content has been converted and formatted for viewing. Original formatting preserved where possible.</div>
      </div>
    </div>
  `;
  
  console.log('✅ DOCX content successfully displayed in full format - like PDF viewer!');
}

function fallbackDocxDisplay() {
  const docxContent = document.getElementById('docx-content');
  const filename = document.getElementById('docx-filename').value;
  
  docxContent.innerHTML = `
    <div style="max-width: 800px; margin: 0 auto; padding: 40px; background: white;">
      <div style="text-align: center; margin-bottom: 30px;">
        <h3 style="color: #ffc107; margin-bottom: 10px;">⚠️ DOCX Processing Fallback</h3>
        <p style="color: #6c757d; font-size: 14px;">Document: ${filename}</p>
      </div>
      
      <div style="border: 2px dashed #ffc107; padding: 30px; text-align: center; border-radius: 8px; background: #fff8e1;">
        <div style="font-size: 48px; color: #ffc107; margin-bottom: 15px;">📄</div>
        <h4 style="color: #495057;">DOCX Processing Alternative</h4>
        <p style="color: #6c757d; margin-bottom: 20px;">The automated content extraction encountered an issue, but the document is ready for download.</p>
        
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6;">
          <h5 style="color: #198754; margin-bottom: 15px;">📋 Document Available:</h5>
          <ul style="text-align: left; color: #495057; max-width: 300px; margin: 0 auto;">
            <li><strong>Filename:</strong> ${filename}</li>
            <li><strong>Type:</strong> Microsoft Word Document</li>
            <li><strong>Status:</strong> Ready for download</li>
            <li><strong>Alternative:</strong> Use buttons below</li>
          </ul>
        </div>
        
        <div style="margin-top: 25px;">
          <p style="color: #dc3545; font-weight: bold;">📥 Recommended Actions:</p>
          <p style="color: #6c757d; font-size: 14px;">Download the original file or try the text extraction option below</p>
        </div>
      </div>
    </div>
  `;
  
  updateDocxStatus('Fallback display - document ready for download');
}

// NEW FUNCTION: Extract text as fallback when HTML conversion fails
function extractDocxTextAsFallback(bytes, filename) {
  console.log('🔄 Attempting text extraction as fallback...');
  updateDocxStatus('HTML conversion failed, extracting text content...');
  
  mammoth.extractRawText({arrayBuffer: bytes.buffer})
    .then(function(textResult) {
      console.log('✅ Text extraction successful!');
      console.log('📝 Text content length:', textResult.value ? textResult.value.length : 0);
      
      if (textResult.value && textResult.value.trim().length > 0) {
        // Display the text content formatted as HTML
        displayDocxTextAsHtml(textResult.value, filename);
        showDocxSuccess('DOCX text content extracted successfully!');
        updateDocxStatus('DOCX text content displayed (formatting limited)');
      } else {
        console.log('❌ No text content found either');
        showDocxError('No readable content found in document');
        fallbackDocxDisplay();
      }
    })
    .catch(function(textError) {
      console.error('❌ Text extraction also failed:', textError);
      showDocxError('Both HTML and text extraction failed');
      fallbackDocxDisplay();
    });
}

// NEW FUNCTION: Display text content as formatted HTML
function displayDocxTextAsHtml(textContent, filename) {
  const docxContent = document.getElementById('docx-content');
  
  // Convert plain text to basic HTML formatting
  const formattedText = textContent
    .split('\n\n')  // Split paragraphs
    .map(paragraph => {
      if (paragraph.trim().length === 0) return '';
      
      // Basic formatting detection
      let formatted = paragraph.trim();
      
      // Try to detect headings (all caps, short lines)
      if (formatted.length < 100 && formatted === formatted.toUpperCase() && formatted.length > 5) {
        return `<h3 style="color: #2c3e50; margin-top: 24px; margin-bottom: 12px;">${formatted}</h3>`;
      }
      
      // Try to detect lists (lines starting with numbers or bullets)
      if (formatted.match(/^\d+\.|^[-•*]/)) {
        const listItems = formatted.split('\n').map(line => {
          if (line.trim().match(/^\d+\.|^[-•*]/)) {
            return `<li>${line.trim().replace(/^\d+\.|^[-•*]\s*/, '')}</li>`;
          }
          return line.trim();
        }).join('');
        return `<ul style="margin: 16px 0; padding-left: 30px;">${listItems}</ul>`;
      }
      
      // Regular paragraph
      return `<p style="margin-bottom: 12px; text-align: justify; line-height: 1.6;">${formatted}</p>`;
    })
    .filter(p => p.length > 0)
    .join('');
  
  // Create the full display
  docxContent.innerHTML = `
    <div style="max-width: 100%; margin: 0; padding: 0; background: white; height: 100%;">
      <!-- DOCX DOCUMENT HEADER -->
      <div style="background: #17a2b8; color: white; padding: 15px; margin-bottom: 0; position: sticky; top: 0; z-index: 100;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h5 style="margin: 0; color: white;">📝 ${filename}</h5>
            <small style="color: #b8e6f0;">Word Document - Text Content (Limited Formatting)</small>
          </div>
          <div>
            <span style="background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px;">⚠️ Text Only</span>
          </div>
        </div>
      </div>
      
      <!-- DOCX TEXT CONTENT -->
      <div style="background: white; padding: 40px; min-height: 600px; font-family: 'Segoe UI', 'Times New Roman', serif; line-height: 1.6; color: #333;">
        <div style="background: #e1f5fe; padding: 15px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #0288d1;">
          <p style="margin: 0; color: #01579b; font-size: 14px;">
            <strong>📝 Text Content:</strong> HTML conversion failed, displaying text content with basic formatting. 
            For full formatting, images, and tables, download the original document.
          </p>
        </div>
        
        <div style="line-height: 1.8;">
          ${formattedText || '<p style="color: #6c757d; font-style: italic; text-align: center; padding: 40px;">No readable text content found in this document.</p>'}
        </div>
      </div>
      
      <!-- SUCCESS FOOTER -->
      <div style="background: #fff3e0; padding: 20px; text-align: center; border-top: 1px solid #ffcc02;">
        <div style="color: #ef6c00; font-weight: bold; margin-bottom: 8px; font-size: 16px;">📝 Text Content Extracted!</div>
        <div style="color: #f57c00; font-size: 14px;">Document text has been extracted with basic formatting. For complete content, download the original file.</div>
      </div>
    </div>
  `;
  
  console.log('✅ DOCX text content displayed as formatted HTML');
}

function reprocessDocx() {
  console.log('🔄 Reprocessing DOCX document...');
  updateDocxStatus('Reprocessing document...');
  
  // Clear any previous messages
  hideDocxMessages();
  
  // Restart the processing
  setTimeout(() => {
    initializeRealDocxViewer();
  }, 500);
}

function showDocxAsText() {
  console.log('📝 Extracting text from DOCX (enhanced version)...');
  updateDocxStatus('Extracting plain text with basic formatting...');
  
  const base64Data = document.getElementById('docx-base64-data').value;
  const filename = document.getElementById('docx-filename').value;
  
  if (!base64Data || typeof mammoth === 'undefined') {
    showDocxError('Cannot extract text - missing data or library');
    return;
  }
  
  try {
    // Convert base64 to binary
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    // Extract plain text with enhanced formatting
    mammoth.extractRawText({arrayBuffer: bytes.buffer})
      .then(function(result) {
        console.log('✅ Enhanced text extraction completed!');
        console.log('📝 Text length:', result.value ? result.value.length : 0);
        
        if (result.value && result.value.trim().length > 0) {
          displayDocxTextAsHtml(result.value, filename);
          showDocxSuccess('Text extracted with enhanced formatting!');
          updateDocxStatus('Enhanced text extraction completed!');
        } else {
          console.log('❌ No text content found');
          showDocxError('No readable text found in document');
          fallbackDocxDisplay();
        }
      })
      .catch(function(error) {
        console.error('❌ Enhanced text extraction failed:', error);
        showDocxError('Text extraction failed');
        fallbackDocxDisplay();
      });
      
  } catch (error) {
    console.error('❌ Text extraction error:', error);
    showDocxError('Text extraction failed');
    fallbackDocxDisplay();
  }
}

function displayDocxText(textContent, filename) {
  const docxContent = document.getElementById('docx-content');
  
  docxContent.innerHTML = `
    <div style="max-width: 800px; margin: 0 auto; padding: 20px; background: white;">
      <h4 style="color: #0d6efd; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;">📝 Extracted Plain Text</h4>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #198754;">
        <p style="margin: 0; color: #495057;"><strong>Text Extraction:</strong> Plain text content from ${filename} (formatting removed).</p>
      </div>
      
      <div style="background: white; padding: 25px; border: 1px solid #dee2e6; border-radius: 8px; font-family: monospace; line-height: 1.8; max-height: 600px; overflow-y: auto; white-space: pre-wrap;">
        ${textContent || 'No readable text found in this document.'}
      </div>
      
      <div style="margin-top: 20px; text-align: center; padding: 15px; background: #e7f3ff; border-radius: 8px;">
        <p style="color: #0d6efd; font-weight: bold; margin-bottom: 5px;">✅ Text Extraction Complete!</p>
        <p style="color: #6c757d; font-size: 14px; margin: 0;">For formatted content with images and tables, download the original document.</p>
      </div>
    </div>
  `;
}

function openDocxNewWindow() {
  console.log('🪟 Opening DOCX information in new window...');
  const filename = document.getElementById('docx-filename').value;
  
  const newWindow = window.open('', '_blank', 'width=900,height=700');
  newWindow.document.write(`
    <html>
    <head>
      <title>Word Document - ${filename}</title>
      <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #0d6efd; padding-bottom: 25px; }
        .download-section { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 30px; border-radius: 12px; text-align: center; margin: 30px 0; }
        .btn { background: #0d6efd; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; display: inline-block; margin: 10px; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(13, 110, 253, 0.3); }
        .btn:hover { background: #0b5ed7; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(13, 110, 253, 0.4); }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .info-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #198754; }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1 style="color: #0d6efd; margin-bottom: 15px; font-size: 2.5em;">📄 Word Document</h1>
          <h2 style="color: #495057; margin-bottom: 10px;">${filename}</h2>
          <p style="color: #6c757d; font-size: 16px;">Microsoft Word Document Viewer</p>
        </div>
        
        <div class="info-grid">
          <div class="info-card">
            <h4 style="color: #198754; margin-bottom: 10px;">📋 Document Type</h4>
            <p style="margin: 0; color: #495057;">Microsoft Word Document (.docx)</p>
          </div>
          <div class="info-card">
            <h4 style="color: #198754; margin-bottom: 10px;">💾 File Status</h4>
            <p style="margin: 0; color: #495057;">Ready for Download & Viewing</p>
          </div>
        </div>
        
        <div class="download-section">
          <h3 style="color: #0d6efd; margin-bottom: 20px;">📥 Access Your Document</h3>
          <p style="margin-bottom: 25px; color: #495057; font-size: 16px;">Download the complete Word document with all formatting, images, and content preserved.</p>
          <a href="#" onclick="window.close(); window.opener.document.querySelector('a[href*=\"download_email_attachment\"]').click();" class="btn">
            📥 Download ${filename}
          </a>
          <a href="#" onclick="window.close();" class="btn" style="background: #6c757d;">
            ↩️ Close Window
          </a>
        </div>
        
        <div style="text-align: center; margin-top: 40px; padding: 25px; background: #e8f5e8; border-radius: 8px;">
          <p style="color: #198754; font-weight: bold; margin-bottom: 10px; font-size: 18px;">✅ Document Ready!</p>
          <p style="color: #495057; margin: 0;">Open with Microsoft Word, LibreOffice Writer, Google Docs, or any compatible word processor for full viewing and editing capabilities.</p>
        </div>
      </div>
    </body>
    </html>
  `);
  newWindow.document.close();
  
  showDocxSuccess('Document information opened in new window!');
}

function updateDocxStatus(message) {
  const statusElement = document.getElementById('docx-status');
  if (statusElement) {
    statusElement.textContent = message;
  }
  console.log('📄 DOCX Status:', message);
}

function showDocxSuccess(message) {
  hideDocxMessages();
  const successDiv = document.getElementById('docx-success');
  const messageSpan = document.getElementById('docx-success-method');
  if (successDiv && messageSpan) {
    messageSpan.textContent = message;
    successDiv.style.display = 'block';
    
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 5000);
  }
}

function showDocxError(message) {
  hideDocxMessages();
  const errorDiv = document.getElementById('docx-error');
  const messageSpan = document.getElementById('docx-error-method');
  if (errorDiv && messageSpan) {
    messageSpan.textContent = message;
    errorDiv.style.display = 'block';
    
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 7000);
  }
}

function hideDocxMessages() {
  const successDiv = document.getElementById('docx-success');
  const errorDiv = document.getElementById('docx-error');
  if (successDiv) successDiv.style.display = 'none';
  if (errorDiv) errorDiv.style.display = 'none';
}

// DOCX ZOOM FUNCTIONALITY - LIKE PDF VIEWER
let docxZoomLevel = 100;

function zoomDocxIn() {
  docxZoomLevel = Math.min(docxZoomLevel + 25, 300);
  applyDocxZoom();
  console.log('🔍 DOCX Zoom In:', docxZoomLevel + '%');
}

function zoomDocxOut() {
  docxZoomLevel = Math.max(docxZoomLevel - 25, 50);
  applyDocxZoom();
  console.log('🔍 DOCX Zoom Out:', docxZoomLevel + '%');
}

function resetDocxZoom() {
  docxZoomLevel = 100;
  applyDocxZoom();
  console.log('🔍 DOCX Zoom Reset:', docxZoomLevel + '%');
}

function applyDocxZoom() {
  const docxContentDiv = document.querySelector('#docx-content > div');
  const zoomLevelSpan = document.getElementById('docx-zoom-level');
  
  if (docxContentDiv) {
    docxContentDiv.style.transform = `scale(${docxZoomLevel / 100})`;
    docxContentDiv.style.transformOrigin = 'top left';
    docxContentDiv.style.width = `${10000 / docxZoomLevel}%`;
  }
  
  if (zoomLevelSpan) {
    zoomLevelSpan.textContent = docxZoomLevel + '%';
  }
  
  // Update container height to accommodate scaled content
  const container = document.getElementById('docx-content');
  if (container && docxContentDiv) {
    const scaledHeight = docxContentDiv.scrollHeight * (docxZoomLevel / 100);
    container.style.minHeight = Math.max(scaledHeight, 600) + 'px';
  }
}

// IMAGE VIEWER FUNCTIONS - LIKE PDF AND DOCX VIEWERS
let imageZoomLevel = 100;
let imageRotation = 0;

document.addEventListener('DOMContentLoaded', function() {
  // Check if we have an image file
  const imageContainer = document.getElementById('image-viewer-container');
  if (imageContainer) {
    initializeImageViewer();
  }
});

function initializeImageViewer() {
  console.log('🖼️ Image Viewer: Starting initialization...');
  updateImageStatus('Loading image...');
  
  const mainImage = document.getElementById('main-image');
  if (mainImage) {
    mainImage.onload = function() {
      console.log('✅ Image loaded successfully!');
      const dimensions = `${this.naturalWidth} × ${this.naturalHeight}`;
      document.getElementById('image-dimensions').textContent = dimensions;
      document.getElementById('image-size-display').textContent = dimensions;
      updateImageStatus('Image loaded and ready for viewing');
      showImageSuccess('Image loaded successfully!');
      
      // Set up click to zoom
      mainImage.onclick = function() {
        if (imageZoomLevel === 100) {
          zoomImageIn();
        } else {
          resetImageZoom();
        }
      };
    };
    
    mainImage.onerror = function() {
      console.error('❌ Image failed to load');
      updateImageStatus('Image failed to load');
      showImageError('Failed to load image');
    };
  }
}

function zoomImageIn() {
  imageZoomLevel = Math.min(imageZoomLevel + 25, 500);
  applyImageZoom();
  console.log('🔍 Image Zoom In:', imageZoomLevel + '%');
}

function zoomImageOut() {
  imageZoomLevel = Math.max(imageZoomLevel - 25, 25);
  applyImageZoom();
  console.log('🔍 Image Zoom Out:', imageZoomLevel + '%');
}

function resetImageZoom() {
  imageZoomLevel = 100;
  applyImageZoom();
  console.log('🔍 Image Zoom Reset:', imageZoomLevel + '%');
}

function applyImageZoom() {
  const mainImage = document.getElementById('main-image');
  const zoomIndicator = document.getElementById('image-zoom-level');
  const zoomDisplay = document.getElementById('image-zoom-display');
  
  if (mainImage) {
    mainImage.style.transform = `scale(${imageZoomLevel / 100}) rotate(${imageRotation}deg)`;
    mainImage.style.cursor = imageZoomLevel === 100 ? 'zoom-in' : 'zoom-out';
  }
  
  if (zoomIndicator) {
    zoomIndicator.textContent = imageZoomLevel + '%';
  }
  
  if (zoomDisplay) {
    zoomDisplay.textContent = imageZoomLevel + '%';
  }
}

function rotateImage() {
  imageRotation = (imageRotation + 90) % 360;
  applyImageZoom(); // This applies both zoom and rotation
  console.log('🔄 Image Rotated:', imageRotation + '°');
  updateImageStatus(`Image rotated to ${imageRotation}°`);
}

function toggleImageFullscreen() {
  const imageContainer = document.getElementById('image-viewer-container');
  
  if (!document.fullscreenElement) {
    // Enter fullscreen
    if (imageContainer.requestFullscreen) {
      imageContainer.requestFullscreen();
    } else if (imageContainer.webkitRequestFullscreen) {
      imageContainer.webkitRequestFullscreen();
    } else if (imageContainer.msRequestFullscreen) {
      imageContainer.msRequestFullscreen();
    }
    console.log('🖼️ Entering fullscreen mode');
    updateImageStatus('Fullscreen mode activated');
  } else {
    // Exit fullscreen
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    console.log('🖼️ Exiting fullscreen mode');
    updateImageStatus('Fullscreen mode deactivated');
  }
}

function openImageNewWindow() {
  console.log('🪟 Opening image in new window...');
  const mainImage = document.getElementById('main-image');
  const filename = '{{ attachment.filename }}';
  
  if (mainImage) {
    const newWindow = window.open('', '_blank', 'width=1000,height=800');
    newWindow.document.write(`
      <html>
      <head>
        <title>Image Viewer - ${filename}</title>
        <style>
          body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
          }
          .container {
            text-align: center;
            max-width: 100%;
            max-height: 100%;
          }
          img { 
            max-width: 100%; 
            max-height: 90vh; 
            object-fit: contain;
            border: 2px solid #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(255,255,255,0.3);
          }
          .info {
            color: white;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            backdrop-filter: blur(10px);
          }
          .controls {
            margin-top: 15px;
          }
          .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
          }
          .btn:hover { background: #0056b3; }
        </style>
      </head>
      <body>
        <div class="container">
          <img src="${mainImage.src}" alt="${filename}">
          <div class="info">
            <h3 style="margin: 0 0 10px 0; color: #fff;">📸 ${filename}</h3>
            <p style="margin: 0;">{{ "%.1f"|format(file_size / 1024 / 1024) }} MB</p>
          </div>
          <div class="controls">
            <a href="${mainImage.src}" download="${filename}" class="btn">📥 Download</a>
            <button onclick="window.close()" class="btn">❌ Close</button>
          </div>
        </div>
      </body>
      </html>
    `);
    newWindow.document.close();
  }
  
  showImageSuccess('Image opened in new window!');
}

function updateImageStatus(message) {
  const statusElement = document.getElementById('image-status');
  if (statusElement) {
    statusElement.textContent = message;
  }
  console.log('🖼️ Image Status:', message);
}

function showImageSuccess(message) {
  const successDiv = document.getElementById('image-success');
  const messageSpan = document.getElementById('image-success-method');
  if (successDiv && messageSpan) {
    messageSpan.textContent = message;
    successDiv.style.display = 'block';
    
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }
}

function showImageError(message) {
  const statusElement = document.getElementById('image-status');
  if (statusElement) {
    statusElement.textContent = message;
    statusElement.style.color = '#dc3545';
  }
  console.error('🖼️ Image Error:', message);
}

// VIDEO PLAYER FUNCTIONS - PROFESSIONAL MEDIA PLAYER
let isVideoPlaying = false;
let isVideoMuted = false;

document.addEventListener('DOMContentLoaded', function() {
  // Check if we have a video file
  const videoContainer = document.getElementById('video-viewer-container');
  if (videoContainer) {
    console.log('🎬 Video Player: Container detected, waiting for video load...');
    updateVideoStatus('Initializing video player...');
  }
});

function initializeVideoPlayer() {
  console.log('🎬 Video Player: Starting initialization...');
  updateVideoStatus('Video loaded, ready to play');
  
  const video = document.getElementById('main-video');
  if (video) {
    // Update video info
    const dimensions = `${video.videoWidth} × ${video.videoHeight}`;
    const duration = formatTime(video.duration);
    
    document.getElementById('video-dimensions').textContent = dimensions;
    document.getElementById('video-duration').textContent = duration;
    document.getElementById('total-duration').textContent = formatTime(video.duration);
    
    // Set up progress tracking
    video.addEventListener('timeupdate', updateVideoProgress);
    video.addEventListener('loadedmetadata', function() {
      console.log('✅ Video metadata loaded successfully!');
      showVideoSuccess('Video loaded and ready to play!');
    });
    
    console.log('✅ Video player initialized successfully!');
  }
}

function playPauseVideo() {
  const video = document.getElementById('main-video');
  const playBtn = document.getElementById('play-pause-btn');
  const playIcon = document.getElementById('play-pause-icon');
  const playText = document.getElementById('play-pause-text');
  
  if (video) {
    if (video.paused) {
      video.play();
      isVideoPlaying = true;
      playIcon.className = 'bi bi-pause-fill';
      playText.textContent = 'Pause';
      updateVideoStatus('Playing video...');
      console.log('▶️ Video started playing');
    } else {
      video.pause();
      isVideoPlaying = false;
      playIcon.className = 'bi bi-play-fill';
      playText.textContent = 'Play';
      updateVideoStatus('Video paused');
      console.log('⏸️ Video paused');
    }
  }
}

function stopVideo() {
  const video = document.getElementById('main-video');
  const playIcon = document.getElementById('play-pause-icon');
  const playText = document.getElementById('play-pause-text');
  
  if (video) {
    video.pause();
    video.currentTime = 0;
    isVideoPlaying = false;
    playIcon.className = 'bi bi-play-fill';
    playText.textContent = 'Play';
    updateVideoStatus('Video stopped');
    updateVideoProgress();
    console.log('⏹️ Video stopped');
  }
}

function muteUnmuteVideo() {
  const video = document.getElementById('main-video');
  const muteBtn = document.getElementById('mute-btn');
  const muteIcon = document.getElementById('mute-icon');
  const muteText = document.getElementById('mute-text');
  const volumeSlider = document.getElementById('volume-slider');
  
  if (video) {
    if (video.muted) {
      video.muted = false;
      isVideoMuted = false;
      muteIcon.className = 'bi bi-volume-up-fill';
      muteText.textContent = 'Mute';
      volumeSlider.value = video.volume * 100;
      updateVideoStatus('Video unmuted');
      console.log('🔊 Video unmuted');
    } else {
      video.muted = true;
      isVideoMuted = true;
      muteIcon.className = 'bi bi-volume-mute-fill';
      muteText.textContent = 'Unmute';
      updateVideoStatus('Video muted');
      console.log('🔇 Video muted');
    }
    updateVolumeDisplay();
  }
}

function changeVolume(value) {
  const video = document.getElementById('main-video');
  const volumePercentage = document.getElementById('volume-percentage');
  
  if (video) {
    video.volume = value / 100;
    volumePercentage.textContent = value + '%';
    
    // Unmute if volume is changed while muted
    if (video.muted && value > 0) {
      video.muted = false;
      isVideoMuted = false;
      document.getElementById('mute-icon').className = 'bi bi-volume-up-fill';
      document.getElementById('mute-text').textContent = 'Mute';
    }
    
    updateVolumeDisplay();
    console.log('🔊 Volume changed to:', value + '%');
  }
}

function updateVolumeDisplay() {
  const video = document.getElementById('main-video');
  const volumeDisplay = document.getElementById('video-volume-display');
  
  if (video && volumeDisplay) {
    const volumeText = video.muted ? 'Muted' : Math.round(video.volume * 100) + '%';
    volumeDisplay.textContent = volumeText;
  }
}

function updatePlayButton(playing) {
  const playIcon = document.getElementById('play-pause-icon');
  const playText = document.getElementById('play-pause-text');
  const statusDisplay = document.getElementById('video-status-display');
  
  if (playing) {
    playIcon.className = 'bi bi-pause-fill';
    playText.textContent = 'Pause';
    statusDisplay.textContent = 'Playing';
    isVideoPlaying = true;
  } else {
    playIcon.className = 'bi bi-play-fill';
    playText.textContent = 'Play';
    statusDisplay.textContent = 'Paused';
    isVideoPlaying = false;
  }
}

function updateVideoProgress() {
  const video = document.getElementById('main-video');
  const progressBar = document.getElementById('video-progress-bar');
  const currentTimeSpan = document.getElementById('current-time');
  const timeDisplay = document.getElementById('video-time-display');
  
  if (video && progressBar) {
    const progress = (video.currentTime / video.duration) * 100;
    progressBar.style.width = progress + '%';
    
    const currentFormatted = formatTime(video.currentTime);
    const totalFormatted = formatTime(video.duration);
    
    if (currentTimeSpan) {
      currentTimeSpan.textContent = currentFormatted;
    }
    
    if (timeDisplay) {
      timeDisplay.textContent = `${currentFormatted} / ${totalFormatted}`;
    }
  }
}

function seekVideo(event) {
  const video = document.getElementById('main-video');
  const progressContainer = event.currentTarget;
  
  if (video && progressContainer) {
    const rect = progressContainer.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    const newTime = percentage * video.duration;
    
    video.currentTime = newTime;
    updateVideoProgress();
    
    console.log('⏭️ Video seeked to:', formatTime(newTime));
  }
}

function toggleVideoFullscreen() {
  const videoContainer = document.getElementById('video-viewer-container');
  
  if (!document.fullscreenElement) {
    // Enter fullscreen
    if (videoContainer.requestFullscreen) {
      videoContainer.requestFullscreen();
    } else if (videoContainer.webkitRequestFullscreen) {
      videoContainer.webkitRequestFullscreen();
    } else if (videoContainer.msRequestFullscreen) {
      videoContainer.msRequestFullscreen();
    }
    console.log('🎬 Entering video fullscreen mode');
    updateVideoStatus('Fullscreen mode activated');
  } else {
    // Exit fullscreen
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    console.log('🎬 Exiting video fullscreen mode');
    updateVideoStatus('Fullscreen mode deactivated');
  }
}

function openVideoNewWindow() {
  console.log('🪟 Opening video in new window...');
  const video = document.getElementById('main-video');
  const filename = '{{ attachment.filename }}';
  
  if (video) {
    const newWindow = window.open('', '_blank', 'width=1200,height=800');
    newWindow.document.write(`
      <html>
      <head>
        <title>Video Player - ${filename}</title>
        <style>
          body { 
            margin: 0; 
            padding: 20px; 
            background: #000; 
            display: flex; 
            flex-direction: column;
            align-items: center; 
            justify-content: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
          }
          .container {
            text-align: center;
            max-width: 100%;
            max-height: 100%;
          }
          video { 
            max-width: 100%; 
            max-height: 70vh; 
            border: 2px solid #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(255,255,255,0.3);
          }
          .info {
            color: white;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
          }
          .controls {
            margin-top: 15px;
          }
          .btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-weight: bold;
          }
          .btn:hover { background: #c82333; }
        </style>
      </head>
      <body>
        <div class="container">
          <video controls preload="metadata" src="${video.src}">
            Your browser does not support the video tag.
          </video>
          <div class="info">
            <h3 style="margin: 0 0 10px 0; color: #fff;">🎬 ${filename}</h3>
            <p style="margin: 0;">{{ "%.1f"|format(file_size / 1024 / 1024) }} MB</p>
          </div>
          <div class="controls">
            <a href="${video.src}" download="${filename}" class="btn">📥 Download</a>
            <button onclick="window.close()" class="btn">❌ Close</button>
          </div>
        </div>
      </body>
      </html>
    `);
    newWindow.document.close();
  }
  
  showVideoSuccess('Video opened in new window!');
}

function updateVideoStatus(message) {
  const statusElement = document.getElementById('video-status');
  if (statusElement) {
    statusElement.textContent = message;
  }
  console.log('🎬 Video Status:', message);
}

function showVideoSuccess(message) {
  const successDiv = document.getElementById('video-success');
  const messageSpan = document.getElementById('video-success-method');
  if (successDiv && messageSpan) {
    messageSpan.textContent = message;
    successDiv.style.display = 'block';
    
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }
}

function formatTime(seconds) {
  if (isNaN(seconds)) return '00:00';
  
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  
  if (hours > 0) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  } else {
    return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
}

// MSG EMAIL VIEWER FUNCTIONS - PROFESSIONAL EMAIL READER
let msgZoomLevel = 100;
let currentEmailView = 'auto';

document.addEventListener('DOMContentLoaded', function() {
  // Check if we have an MSG file
  const msgContainer = document.getElementById('msg-viewer-container');
  if (msgContainer) {
    console.log('📧 MSG Viewer: Container detected, starting email extraction...');
    initializeMsgViewer();
  }
});

function initializeMsgViewer() {
  console.log('📧 MSG Viewer: Starting initialization...');
  updateMsgStatus('Processing MSG file...');
  
  // MSG files are complex - provide best user experience
  displayMsgEmailInterface();
}

function displayMsgEmailInterface() {
  console.log('📧 MSG Viewer: Creating professional email interface...');
  
  // Hide loading
  document.getElementById('msg-loading').style.display = 'none';
  
  // Show email interface
  document.getElementById('email-header').style.display = 'block';
  document.getElementById('email-body').style.display = 'block';
  
  // Get file information
  const filename = '{{ attachment.filename }}';
  const fileSize = '{{ "%.1f"|format(file_size / 1024 / 1024) }}';
  
  // Create professional email display
  document.getElementById('email-subject').textContent = '📧 ' + (filename.replace('.msg', '') || 'Outlook Email Message');
  document.getElementById('email-from').innerHTML = '<span style="color: #007bff;">Microsoft Outlook Email</span>';
  document.getElementById('email-to').innerHTML = '<span style="color: #6c757d;">View in Outlook for full content</span>';
  document.getElementById('email-date').innerHTML = '<span style="color: #6c757d;">' + new Date().toLocaleDateString() + '</span>';
  
  // Create beautiful email body content
  const emailBodyContent = document.getElementById('email-text-content');
  emailBodyContent.style.display = 'block';
  emailBodyContent.innerHTML = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; line-height: 1.6; color: #333;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px 12px 0 0; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 15px;">📧</div>
        <h2 style="margin: 0; font-weight: 300;">Microsoft Outlook Email Message</h2>
        <p style="margin: 10px 0 0 0; opacity: 0.9;">Professional email file (.msg format)</p>
      </div>
      
      <div style="background: white; padding: 30px; border: 1px solid #e9ecef; border-top: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;">
            <div style="font-weight: 600; color: #495057; margin-bottom: 5px;">📁 File Name</div>
            <div style="color: #6c757d; font-family: monospace;">${filename}</div>
          </div>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; color: #495057; margin-bottom: 5px;">💾 File Size</div>
            <div style="color: #6c757d; font-family: monospace;">${fileSize} MB</div>
          </div>
        </div>
        
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
          <h4 style="color: #856404; margin: 0 0 15px 0; display: flex; align-items: center;">
            <span style="margin-right: 10px;">💡</span> About This Email File
          </h4>
          <p style="color: #856404; margin: 0; line-height: 1.7;">
            This is a Microsoft Outlook email message saved in .msg format. It contains the complete email 
            with headers, body content, formatting, and any attachments. To view the email exactly as it 
            was sent and received, you'll need to open it in Microsoft Outlook.
          </p>
        </div>
        
        <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 20px; margin-bottom: 25px;">
          <h4 style="color: #0c5460; margin: 0 0 15px 0; display: flex; align-items: center;">
            <span style="margin-right: 10px;">🔍</span> How to View This Email
          </h4>
          <div style="color: #0c5460;">
            <div style="margin-bottom: 12px; display: flex; align-items: flex-start;">
              <span style="background: #007bff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold; flex-shrink: 0;">1</span>
              <div>
                <strong>Download the MSG file</strong><br>
                <small>Click the "Download Original" button below</small>
              </div>
            </div>
            <div style="margin-bottom: 12px; display: flex; align-items: flex-start;">
              <span style="background: #007bff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold; flex-shrink: 0;">2</span>
              <div>
                <strong>Open Microsoft Outlook</strong><br>
                <small>Launch Outlook on your computer</small>
              </div>
            </div>
            <div style="display: flex; align-items: flex-start;">
              <span style="background: #007bff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; font-weight: bold; flex-shrink: 0;">3</span>
              <div>
                <strong>Double-click the .msg file</strong><br>
                <small>The email will open with full formatting and attachments</small>
              </div>
            </div>
          </div>
        </div>
        
        <div style="background: #e2e3e5; border-radius: 8px; padding: 20px; text-align: center;">
          <div style="margin-bottom: 15px;">
            <span style="font-size: 24px; margin-right: 10px;">⚡</span>
            <strong style="color: #495057;">Quick Actions</strong>
          </div>
          <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
               style="background: linear-gradient(45deg, #007bff, #0056b3); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; box-shadow: 0 4px 15px rgba(0,123,255,0.3); transition: transform 0.2s;"
               onmouseover="this.style.transform='translateY(-2px)'" 
               onmouseout="this.style.transform='translateY(0)'">
              <span style="margin-right: 8px;">📥</span> Download Original
            </a>
            <button onclick="openMsgNewWindow()" 
                    style="background: linear-gradient(45deg, #6c757d, #5a6268); color: white; padding: 12px 24px; border-radius: 25px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; box-shadow: 0 4px 15px rgba(108,117,125,0.3); transition: transform 0.2s;"
                    onmouseover="this.style.transform='translateY(-2px)'" 
                    onmouseout="this.style.transform='translateY(0)'">
              <span style="margin-right: 8px;">🪟</span> New Window
            </button>
          </div>
        </div>
      </div>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 0 0 12px 12px; text-align: center; border: 1px solid #e9ecef; border-top: none;">
        <small style="color: #6c757d;">
          <strong>💡 Pro Tip:</strong> MSG files preserve all original email formatting, embedded images, and attachments when opened in Outlook.
        </small>
      </div>
    </div>
  `;
  
  // Update status displays
  document.getElementById('msg-status-display').textContent = 'Ready to Download';
  updateMsgStatus('MSG file ready for viewing in Outlook');
  showMsgSuccess('MSG file information displayed - download to view in Outlook!');
  
  // Set view mode
  currentEmailView = 'text';
  document.getElementById('msg-view-mode').textContent = 'Info View';
  
  console.log('✅ Professional MSG interface displayed');
}

function parseAndDisplayMsgContent() {
  console.log('📧 MSG Parser: Extracting actual email content...');
  updateMsgStatus('Analyzing MSG file structure...');
  
  const base64Data = '{{ file_base64 }}';
  if (!base64Data) {
    showProfessionalMsgMessage();
    return;
  }
  
  try {
    // Decode base64 to binary
    const binaryString = atob(base64Data);
    const emailData = extractMsgEmailData(binaryString);
    
    if (emailData.hasValidContent) {
      displayExtractedEmail(emailData);
    } else {
      showProfessionalMsgMessage();
    }
  } catch (error) {
    console.error('❌ MSG content extraction failed:', error);
    showProfessionalMsgMessage();
  }
}

function extractMsgEmailData(binaryString) {
  console.log('📧 MSG Extractor: Using advanced MSG parsing...');
  
  const emailData = {
    subject: '',
    from: '',
    to: '',
    cc: '',
    date: '',
    body: '',
    bodyHtml: '',
    hasValidContent: false
  };
  
  try {
    // MSG files have a complex structure - use smarter extraction
    console.log('📧 Processing MSG binary data...');
    
    // Convert binary to more manageable format
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    // Look for MAPI property markers and extract text
    const textContent = extractTextFromMsgBytes(bytes);
    
    if (textContent.length > 50) {
      // Parse the extracted text for email components
      emailData.subject = extractCleanSubject(textContent) || 'Email Message';
      emailData.from = extractCleanSender(textContent) || 'Unknown Sender';
      emailData.to = extractCleanRecipient(textContent) || 'Unknown Recipient';
      emailData.date = extractCleanDate(textContent) || new Date().toLocaleDateString();
      emailData.body = extractCleanBody(textContent) || 'This email message was extracted from an MSG file.';
      
      emailData.hasValidContent = true;
    } else {
      // Fallback to basic extraction
      console.log('📧 Using fallback extraction method...');
      emailData.subject = 'MSG Email Message';
      emailData.from = 'Outlook User';
      emailData.to = 'Recipients';
      emailData.date = new Date().toLocaleDateString();
      emailData.body = 'This is an Outlook email message file (.msg). The email content is stored in Microsoft\'s proprietary format.\n\nTo view the complete email with all formatting and attachments:\n\n1. Download the MSG file\n2. Open it in Microsoft Outlook\n3. View the original email with full formatting';
      emailData.hasValidContent = true;
    }
    
    console.log('📧 MSG extraction completed:', {
      subject: emailData.subject.substring(0, 30),
      bodyLength: emailData.body.length,
      hasContent: emailData.hasValidContent
    });
    
    return emailData;
    
  } catch (error) {
    console.error('❌ MSG extraction error:', error);
    // Return basic email info even if extraction fails
    return {
      subject: 'Outlook Email Message',
      from: 'MSG File Sender',
      to: 'MSG File Recipients',
      date: new Date().toLocaleDateString(),
      body: 'This email is stored in Microsoft Outlook MSG format. Please download the file and open it in Outlook to view the complete message with all formatting and attachments.',
      hasValidContent: true
    };
  }
}

function extractTextFromMsgBytes(bytes) {
  console.log('📧 Extracting readable text from MSG bytes...');
  
  let textContent = '';
  let currentString = '';
  let validTextBlocks = [];
  
  // Scan through bytes looking for readable text sequences
  for (let i = 0; i < Math.min(bytes.length, 50000); i++) {
    const byte = bytes[i];
    
    if (byte >= 32 && byte <= 126) {
      // Printable ASCII character
      currentString += String.fromCharCode(byte);
    } else if (byte === 0 && currentString.length > 3) {
      // Null terminator - end of string
      if (isValidEmailText(currentString)) {
        validTextBlocks.push(currentString);
      }
      currentString = '';
    } else if (byte === 10 || byte === 13) {
      // Line break
      if (currentString.length > 3 && isValidEmailText(currentString)) {
        validTextBlocks.push(currentString);
      }
      currentString = '';
    } else {
      // Non-printable character
      if (currentString.length > 3 && isValidEmailText(currentString)) {
        validTextBlocks.push(currentString);
      }
      currentString = '';
    }
  }
  
  // Add final string if valid
  if (currentString.length > 3 && isValidEmailText(currentString)) {
    validTextBlocks.push(currentString);
  }
  
  // Join valid text blocks
  textContent = validTextBlocks.join('\n');
  
  console.log('📧 Extracted', validTextBlocks.length, 'text blocks, total length:', textContent.length);
  return textContent;
}

function isValidEmailText(text) {
  // Check if text looks like valid email content
  if (text.length < 3 || text.length > 1000) return false;
  
  // Skip obvious system/binary strings
  const invalidPatterns = [
    /^[A-F0-9]{16,}$/,  // Long hex strings
    /^[\x00-\x1F\x7F-\xFF]+$/,  // Control/binary characters
    /^\d{10,}$/,  // Long number strings
    /^[^\w\s]{3,}$/,  // Only special characters
    /Microsoft.*Outlook.*MAPI/i,  // System strings
    /^(PidTag|PidLid|PidName)/i,  // MAPI property names
    /^[A-Z]{1}[a-z]{1}[A-Z]{1}[a-z]{1}[A-Z]/  // Alternating case (often system)
  ];
  
  for (const pattern of invalidPatterns) {
    if (pattern.test(text)) return false;
  }
  
  // Prefer text with letters and common punctuation
  return /[a-zA-Z]/.test(text) && text.split('').filter(c => /[a-zA-Z\s]/.test(c)).length > text.length * 0.7;
}

function extractCleanSubject(content) {
  const lines = content.split('\n');
  
  // Look for subject-like content
  for (const line of lines) {
    if (line.length > 5 && line.length < 200) {
      // Skip obvious non-subject lines
      if (line.includes('@') && line.includes('.')) continue; // Likely email address
      if (/^\d+$/.test(line)) continue; // Just numbers
      if (line.toLowerCase().includes('microsoft')) continue; // System text
      if (line.toLowerCase().includes('outlook')) continue; // System text
      
      // Look for meaningful subject-like text
      if (/^[A-Z]/.test(line) && line.split(' ').length >= 2 && line.split(' ').length <= 15) {
        return line.trim();
      }
    }
  }
  
  // Fallback - look for any reasonable title-like text
  for (const line of lines) {
    if (line.length > 10 && line.length < 100 && /[a-zA-Z].*[a-zA-Z]/.test(line)) {
      const words = line.split(/\s+/).filter(w => w.length > 1);
      if (words.length >= 2 && words.length <= 10) {
        return line.trim();
      }
    }
  }
  
  return '';
}

function extractCleanSender(content) {
  const lines = content.split('\n');
  
  // Look for email addresses first
  for (const line of lines) {
    const emailMatch = line.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
    if (emailMatch) {
      return emailMatch[1];
    }
  }
  
  // Look for name-like text
  for (const line of lines) {
    if (line.length > 3 && line.length < 50) {
      const words = line.trim().split(/\s+/);
      if (words.length >= 1 && words.length <= 4) {
        if (words.every(word => /^[A-Za-z][a-z]*$/.test(word))) {
          return line.trim();
        }
      }
    }
  }
  
  return '';
}

function extractCleanRecipient(content) {
  return extractCleanSender(content); // Same logic for now
}

function extractCleanDate(content) {
  const lines = content.split('\n');
  
  const datePatterns = [
    /\b\d{1,2}\/\d{1,2}\/\d{4}\b/,
    /\b\d{4}-\d{2}-\d{2}\b/,
    /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},?\s+\d{4}\b/i,
    /\b\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}\b/i
  ];
  
  for (const line of lines) {
    for (const pattern of datePatterns) {
      const match = line.match(pattern);
      if (match) return match[0];
    }
  }
  
  return '';
}

function extractCleanBody(content) {
  const lines = content.split('\n');
  const bodyLines = [];
  
  // Look for meaningful text blocks that could be email body
  for (const line of lines) {
    const trimmed = line.trim();
    
    // Skip short lines and obvious non-body content
    if (trimmed.length < 10) continue;
    if (trimmed.includes('@') && trimmed.includes('.') && trimmed.length < 50) continue; // Likely email
    if (/^\d+$/.test(trimmed)) continue; // Just numbers
    if (trimmed.toLowerCase().includes('microsoft')) continue;
    if (trimmed.toLowerCase().includes('outlook')) continue;
    if (trimmed.toLowerCase().includes('mapi')) continue;
    
    // Look for sentence-like content
    if (/[.!?]$/.test(trimmed) || trimmed.split(' ').length >= 5) {
      bodyLines.push(trimmed);
    }
  }
  
  // Join the best body content
  if (bodyLines.length > 0) {
    return bodyLines.slice(0, 10).join('\n\n');
  }
  
  // Fallback - get any reasonable text
  const fallbackLines = lines.filter(line => 
    line.trim().length > 15 && 
    line.trim().length < 500 &&
    /[a-zA-Z].*[a-zA-Z]/.test(line.trim())
  );
  
  return fallbackLines.slice(0, 5).join('\n\n') || '';
}

function extractMsgField(content, fieldNames) {
  for (const fieldName of fieldNames) {
    // Try multiple regex patterns
    const patterns = [
      new RegExp(fieldName + '\\s*([^\\n\\|\\x00]{1,300})', 'i'),
      new RegExp(fieldName + '([^\\n\\|\\x00]{1,300})', 'i'),
      new RegExp(fieldName.replace(/:/g, '') + '\\s*[:\\s]+([^\\n\\|\\x00]{1,300})', 'i')
    ];
    
    for (const pattern of patterns) {
      const match = content.match(pattern);
      if (match && match[1] && match[1].trim().length > 1) {
        return match[1].trim();
      }
    }
  }
  return '';
}

function extractEmailPattern(content) {
  // Look for email addresses
  const emailRegex = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g;
  const matches = content.match(emailRegex);
  return matches ? matches[0] : '';
}

function extractDateFromContent(content) {
  // Look for date patterns
  const datePatterns = [
    /\b\d{1,2}\/\d{1,2}\/\d{4}\b/,
    /\b\d{4}-\d{2}-\d{2}\b/,
    /\b(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},?\s+\d{4}\b/i,
    /\b\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}\b/i
  ];
  
  for (const pattern of datePatterns) {
    const match = content.match(pattern);
    if (match) return match[0];
  }
  return '';
}

function extractMsgBody(searchableContent, unicodeContent) {
  console.log('📧 Extracting email body content...');
  
  // Try multiple body extraction strategies
  let body = '';
  
  // Strategy 1: Look for content after headers
  const headerEndPatterns = [
    /(?:Subject:|From:|To:|Date:)[\s\S]*?\n\s*\n([\s\S]{20,2000})/i,
    /Content-Type:[\s\S]*?\n\s*\n([\s\S]{20,2000})/i,
    /Message-ID:[\s\S]*?\n\s*\n([\s\S]{20,2000})/i
  ];
  
  for (const pattern of headerEndPatterns) {
    const match = searchableContent.match(pattern);
    if (match && match[1]) {
      body = match[1];
      break;
    }
  }
  
  // Strategy 2: Look for meaningful text blocks
  if (!body || body.length < 20) {
    const textBlocks = searchableContent
      .split(/\n+/)
      .filter(line => 
        line.length > 15 && 
        line.length < 500 &&
        line.match(/[a-zA-Z].*[a-zA-Z]/) &&
        !line.match(/^(Subject|From|To|Date|Content-Type|Message-ID):/i) &&
        !line.includes('Microsoft') &&
        !line.includes('Outlook')
      )
      .slice(0, 10);
    
    if (textBlocks.length > 0) {
      body = textBlocks.join('\n\n');
    }
  }
  
  // Strategy 3: Extract from unicode content
  if (!body || body.length < 20) {
    const unicodeLines = unicodeContent
      .split(/\n+/)
      .filter(line => 
        line.length > 10 && 
        line.length < 300 &&
        line.match(/[a-zA-Z]/) &&
        !line.toLowerCase().includes('microsoft')
      )
      .slice(0, 8);
    
    if (unicodeLines.length > 0) {
      body = unicodeLines.join('\n\n');
    }
  }
  
  return body || 'Email content could not be extracted from this MSG file.';
}

function extractMsgHtmlBody(content) {
  // Look for HTML content
  const htmlPattern = /<html[\s\S]*?<\/html>/i;
  const match = content.match(htmlPattern);
  return match ? match[0] : '';
}

function cleanMsgField(text) {
  if (!text) return '';
  
  return text
    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g, '') // Remove control chars
    .replace(/\|+/g, ' ') // Replace separators
    .replace(/\s+/g, ' ') // Normalize whitespace
    .replace(/^[^a-zA-Z0-9@]*/, '') // Remove leading junk
    .replace(/[^a-zA-Z0-9@]*$/, '') // Remove trailing junk
    .trim()
    .substring(0, 200);
}

function cleanMsgBody(text) {
  if (!text) return '';
  
  return text
    .replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g, '') // Remove control chars
    .replace(/\|+/g, ' ') // Replace separators
    .replace(/(.)\1{8,}/g, '$1') // Remove long repeated chars
    .replace(/^\s*[\|\.\-_=\s]*\s*/, '') // Remove leading junk
    .replace(/\s*[\|\.\-_=\s]*\s*$/, '') // Remove trailing junk
    .replace(/\n\s*\n\s*\n/g, '\n\n') // Normalize line breaks
    .trim()
    .substring(0, 3000);
}

function displayExtractedEmail(emailData) {
  console.log('📧 Displaying extracted email content...');
  updateMsgStatus('Email content extracted successfully');
  
  // Hide loading and show content
  document.getElementById('msg-loading').style.display = 'none';
  document.getElementById('email-header').style.display = 'block';
  document.getElementById('email-body').style.display = 'block';
  
  // Populate email headers
  document.getElementById('email-subject').textContent = emailData.subject;
  document.getElementById('email-from').textContent = emailData.from;
  document.getElementById('email-to').textContent = emailData.to;
  document.getElementById('email-date').textContent = emailData.date;
  
  // Handle CC if available
  if (emailData.cc) {
    document.getElementById('email-cc').textContent = emailData.cc;
    document.getElementById('email-cc-row').style.display = 'block';
  }
  
  // Display body content
  if (emailData.bodyHtml && emailData.bodyHtml.length > 50) {
    // Show HTML content
    document.getElementById('email-html-content').innerHTML = emailData.bodyHtml;
    document.getElementById('email-html-content').style.display = 'block';
    currentEmailView = 'html';
    document.getElementById('msg-view-mode').textContent = 'HTML View';
  } else {
    // Show text content
    document.getElementById('email-text-content').textContent = emailData.body;
    document.getElementById('email-text-content').style.display = 'block';
    currentEmailView = 'text';
    document.getElementById('msg-view-mode').textContent = 'Text View';
  }
  
  // Update status displays
  document.getElementById('msg-status-display').textContent = 'Email Content Loaded';
  updateMsgStatus('MSG email content displayed successfully');
  showMsgSuccess('Email content extracted and displayed!');
  
  console.log('✅ Email content displayed successfully');
}

function showProfessionalMsgMessage() {
  console.log('📧 MSG Viewer: Displaying professional message for MSG file...');
  
  // Hide loading
  document.getElementById('msg-loading').style.display = 'none';
  
  // Show professional email header with proper info
  document.getElementById('email-header').style.display = 'block';
  document.getElementById('email-body').style.display = 'block';
  
  // Set professional email information
  document.getElementById('email-subject').textContent = '📧 Outlook Email Message (.msg)';
  document.getElementById('email-from').innerHTML = '<em>MSG file requires specialized viewer</em>';
  document.getElementById('email-to').innerHTML = '<em>Download to view in Outlook</em>';
  document.getElementById('email-date').innerHTML = '<em>{{ attachment.filename }}</em>';
  
  // Show professional message in body
  const emailBody = document.getElementById('email-html-content');
  emailBody.style.display = 'block';
  emailBody.innerHTML = `
    <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border: 2px solid #dee2e6;">
      <div style="font-size: 64px; margin-bottom: 20px;">📧</div>
      <h3 style="color: #495057; margin-bottom: 20px; font-weight: 600;">Microsoft Outlook Email Message</h3>
      
      <div style="background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <strong style="color: #007bff;">📁 File Information:</strong>
          <span style="color: #6c757d;">{{ attachment.filename }}</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <strong style="color: #007bff;">💾 File Size:</strong>
          <span style="color: #6c757d;">{{ "%.1f"|format(file_size / 1024 / 1024) }} MB</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <strong style="color: #007bff;">🗂️ File Type:</strong>
          <span style="color: #6c757d;">Microsoft Outlook Message (.msg)</span>
        </div>
      </div>
      
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
        <h5 style="color: #856404; margin-bottom: 15px;">
          <i class="bi bi-info-circle"></i> About MSG Files
        </h5>
        <p style="color: #856404; margin: 0; line-height: 1.6;">
          MSG files are Microsoft Outlook email messages that contain the complete email with headers, 
          body content, attachments, and formatting. These files require specialized parsing to display properly.
        </p>
      </div>
      
      <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 20px; margin: 20px 0;">
        <h5 style="color: #0c5460; margin-bottom: 15px;">
          <i class="bi bi-eye"></i> How to View This Email
        </h5>
        <div style="color: #0c5460; text-align: left;">
          <p><strong>Option 1:</strong> Download the MSG file and open it in Microsoft Outlook</p>
          <p><strong>Option 2:</strong> Use the "New Window" button to view in a separate window</p>
          <p><strong>Option 3:</strong> Convert the MSG file to a more universal format like PDF</p>
        </div>
      </div>
      
      <div style="margin-top: 30px;">
        <a href="{{ url_for('int_source_download_email_attachment', att_id=attachment.id) }}" 
           class="btn btn-primary btn-lg" style="margin: 0 10px; text-decoration: none; display: inline-block;">
          <i class="bi bi-download"></i> Download MSG File
        </a>
        <button onclick="openMsgNewWindow()" class="btn btn-outline-secondary btn-lg" style="margin: 0 10px;">
          <i class="bi bi-window"></i> Open in New Window
        </button>
      </div>
    </div>
  `;
  
  // Update status displays
  document.getElementById('msg-status-display').textContent = 'MSG Info Displayed';
  updateMsgStatus('MSG file information displayed');
  showMsgSuccess('MSG file detected - download to view in Outlook!');
  
  console.log('✅ Professional MSG message displayed');
}

function parseMsgFile() {
  console.log('📧 MSG Parser: Attempting to extract email content...');
  updateMsgStatus('Processing MSG file structure...');
  
  // For now, we'll implement a basic text extraction
  // In a full implementation, you'd use a proper MSG parser library
  const base64Data = '{{ file_base64 }}';
  
  if (base64Data) {
    try {
      // Decode base64 and try to extract readable content
      const binaryString = atob(base64Data);
      const emailContent = extractEmailFromBinary(binaryString);
      
      if (emailContent.subject || emailContent.body) {
        displayEmailContent(emailContent);
      } else {
        showMsgFallback();
      }
    } catch (error) {
      console.error('❌ MSG binary parsing failed:', error);
      showMsgFallback();
    }
  } else {
    showMsgFallback();
  }
}

function extractEmailFromBinary(binaryString) {
  console.log('📧 MSG Extractor: Analyzing binary content...');
  
  // Simple extraction - look for common email patterns in binary data
  const emailContent = {
    subject: '',
    from: '',
    to: '',
    cc: '',
    date: '',
    body: '',
    attachments: []
  };
  
  try {
    // Convert binary to searchable text with better filtering
    let searchText = '';
    let cleanText = '';
    
    // First pass: extract all printable characters and common patterns
    for (let i = 0; i < Math.min(binaryString.length, 50000); i++) {
      const char = binaryString.charCodeAt(i);
      if (char >= 32 && char <= 126) { // Printable ASCII
        const charStr = binaryString.charAt(i);
        searchText += charStr;
        cleanText += charStr;
      } else if (char === 10 || char === 13) { // Line breaks
        searchText += '\n';
        cleanText += ' ';
      } else if (char === 0) { // Null terminator - often separates fields
        searchText += '|';
        cleanText += ' ';
      }
    }
    
    // Look for email patterns in the clean text
    console.log('📧 Searching for email patterns in extracted text...');
    
    // Try multiple extraction methods
    emailContent.subject = extractEmailField(searchText, [
      'Subject:', 'SUBJECT:', 'subject:', 
      'Subject\x00', 'SUBJECT\x00'
    ]) || extractFromPattern(cleanText, 'subject', 100) || 'Email Message';
    
    emailContent.from = extractEmailField(searchText, [
      'From:', 'FROM:', 'from:', 
      'From\x00', 'FROM\x00',
      'Sender:', 'SENDER:'
    ]) || extractFromPattern(cleanText, 'from', 150) || 'Unknown Sender';
    
    emailContent.to = extractEmailField(searchText, [
      'To:', 'TO:', 'to:', 
      'To\x00', 'TO\x00',
      'Recipient:', 'RECIPIENT:'
    ]) || extractFromPattern(cleanText, 'to', 150) || 'Unknown Recipient';
    
    emailContent.date = extractEmailField(searchText, [
      'Date:', 'DATE:', 'date:', 
      'Date\x00', 'DATE\x00',
      'Sent:', 'SENT:'
    ]) || extractDatePattern(cleanText) || 'Unknown Date';
    
    // Extract body content with better filtering
    emailContent.body = extractEmailBody(searchText, cleanText);
    
    // Clean up all extracted content
    emailContent.subject = cleanMsgText(emailContent.subject);
    emailContent.from = cleanMsgText(emailContent.from);
    emailContent.to = cleanMsgText(emailContent.to);
    emailContent.date = cleanMsgText(emailContent.date);
    emailContent.body = cleanMsgBody(emailContent.body);
    
    console.log('✅ MSG content extracted with improved parsing');
    return emailContent;
    
  } catch (error) {
    console.error('❌ Email extraction failed:', error);
    return emailContent;
  }
}

function extractEmailField(text, fieldNames) {
  for (const fieldName of fieldNames) {
    const regex = new RegExp(fieldName + '\\s*([^\\n\\|]{1,200})', 'i');
    const match = text.match(regex);
    if (match && match[1] && match[1].trim().length > 0) {
      return match[1].trim();
    }
  }
  return '';
}

function extractFromPattern(text, fieldType, maxLength) {
  // Look for email-like patterns
  if (fieldType === 'from' || fieldType === 'to') {
    const emailPattern = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/;
    const match = text.match(emailPattern);
    if (match) return match[1];
  }
  
  if (fieldType === 'subject') {
    // Look for meaningful text that could be a subject
    const words = text.split(/\s+/).filter(word => 
      word.length > 2 && 
      /^[a-zA-Z0-9]/.test(word) && 
      !word.includes('@')
    );
    if (words.length >= 2) {
      return words.slice(0, 8).join(' ');
    }
  }
  
  return '';
}

function extractDatePattern(text) {
  // Look for date patterns
  const datePatterns = [
    /\d{1,2}\/\d{1,2}\/\d{4}/,  // MM/DD/YYYY
    /\d{4}-\d{2}-\d{2}/,        // YYYY-MM-DD
    /(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2},?\s+\d{4}/i,
    /\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4}/i
  ];
  
  for (const pattern of datePatterns) {
    const match = text.match(pattern);
    if (match) return match[0];
  }
  return '';
}

function extractEmailBody(searchText, cleanText) {
  console.log('📧 Extracting email body content...');
  
  // Try multiple body extraction methods
  let body = '';
  
  // Method 1: Look for content after common headers
  const headerEndPatterns = [
    /(?:Date:|TO:|FROM:|SUBJECT:).*?\n\n([\s\S]{50,})/i,
    /(?:Importance:|Priority:|X-Mailer:).*?\n\n([\s\S]{50,})/i,
    /Content-Type:.*?\n\n([\s\S]{50,})/i
  ];
  
  for (const pattern of headerEndPatterns) {
    const match = searchText.match(pattern);
    if (match && match[1]) {
      body = match[1];
      break;
    }
  }
  
  // Method 2: Look for meaningful text blocks in clean text
  if (!body || body.length < 20) {
    const sentences = cleanText.split(/[.!?]+/).filter(sentence => 
      sentence.trim().length > 20 && 
      sentence.split(' ').length > 3 &&
      !sentence.toLowerCase().includes('microsoft') &&
      !sentence.toLowerCase().includes('outlook')
    );
    
    if (sentences.length > 0) {
      body = sentences.slice(0, 5).join('. ').trim();
      if (body && !body.endsWith('.')) body += '.';
    }
  }
  
  // Method 3: Fallback to general content extraction
  if (!body || body.length < 10) {
    const words = cleanText.split(/\s+/).filter(word => 
      word.length > 2 && 
      /^[a-zA-Z]/.test(word) &&
      !word.includes('@') &&
      !word.includes('\\') &&
      !word.includes('Microsoft') &&
      !word.includes('Outlook')
    );
    
    if (words.length >= 10) {
      body = words.slice(0, 50).join(' ');
    } else {
      body = 'Email content could not be extracted from MSG file.';
    }
  }
  
  return body;
}

function cleanMsgText(text) {
  if (!text) return '';
  
  return text
    .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // Remove control characters
    .replace(/[^\x20-\x7E\s]/g, '') // Keep only printable ASCII and spaces
    .replace(/\s+/g, ' ') // Normalize whitespace
    .replace(/\|+/g, ' ') // Replace separator characters
    .trim()
    .substring(0, 200); // Reasonable length limit
}

function cleanMsgBody(text) {
  if (!text) return '';
  
  return text
    .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // Remove control characters
    .replace(/[^\x20-\x7E\s\n]/g, '') // Keep printable ASCII, spaces, and newlines
    .replace(/\s+/g, ' ') // Normalize whitespace but keep structure
    .replace(/\|+/g, ' ') // Replace separator characters
    .replace(/(.)\1{10,}/g, '$1') // Remove repeated characters
    .trim()
    .substring(0, 2000); // Reasonable length limit for body
}

function extractField(text, fieldName, delimiter) {
  const regex = new RegExp(fieldName + '\\s*([^' + delimiter + ']*)', 'i');
  const match = text.match(regex);
  return match ? match[1].trim() : '';
}

function cleanExtractedText(text) {
  if (!text) return '';
  
  return text
    .replace(/[\x00-\x1F\x7F-\x9F]/g, '') // Remove control characters
    .replace(/\s+/g, ' ') // Normalize whitespace
    .trim()
    .substring(0, 500); // Limit length
}

function displayEmailContent(emailContent) {
  console.log('📧 MSG Display: Rendering email content...');
  updateMsgStatus('Email content loaded successfully');
  
  // Hide loading and show content
  document.getElementById('msg-loading').style.display = 'none';
  document.getElementById('email-header').style.display = 'block';
  document.getElementById('email-body').style.display = 'block';
  
  // Populate header fields
  document.getElementById('email-subject').textContent = emailContent.subject || 'No Subject';
  document.getElementById('email-from').textContent = emailContent.from || 'Unknown Sender';
  document.getElementById('email-to').textContent = emailContent.to || 'Unknown Recipient';
  document.getElementById('email-date').textContent = emailContent.date || 'Unknown Date';
  
  // Handle CC field
  if (emailContent.cc) {
    document.getElementById('email-cc').textContent = emailContent.cc;
    document.getElementById('email-cc-row').style.display = 'block';
  }
  
  // Display body content
  if (emailContent.body) {
    // Try to detect if content is HTML or plain text
    if (emailContent.body.includes('<html>') || emailContent.body.includes('<body>')) {
      document.getElementById('email-html-content').innerHTML = emailContent.body;
      document.getElementById('email-html-content').style.display = 'block';
      currentEmailView = 'html';
      document.getElementById('msg-view-mode').textContent = 'HTML View';
    } else {
      document.getElementById('email-text-content').textContent = emailContent.body;
      document.getElementById('email-text-content').style.display = 'block';
      currentEmailView = 'text';
      document.getElementById('msg-view-mode').textContent = 'Text View';
    }
  }
  
  // Update status
  document.getElementById('msg-status-display').textContent = 'Email Loaded';
  showMsgSuccess('MSG email content extracted and displayed!');
  
  console.log('✅ Email content displayed successfully');
}

function showMsgFallback() {
  console.log('📧 MSG Fallback: Using improved text extraction...');
  updateMsgStatus('Using enhanced text extraction...');
  
  // Hide loading and email sections
  document.getElementById('msg-loading').style.display = 'none';
  document.getElementById('email-header').style.display = 'none';
  document.getElementById('email-body').style.display = 'none';
  
  // Show fallback section
  document.getElementById('msg-text-fallback').style.display = 'block';
  
  // Try to decode and show cleaned text
  try {
    const base64Data = '{{ file_base64 }}';
    if (base64Data) {
      const binaryString = atob(base64Data);
      let readableText = '';
      let cleanSentences = [];
      
      // Extract printable characters with better filtering
      let currentWord = '';
      let wordCount = 0;
      
      for (let i = 0; i < Math.min(binaryString.length, 20000); i++) {
        const char = binaryString.charCodeAt(i);
        
        if (char >= 32 && char <= 126) { // Printable ASCII
          const charStr = binaryString.charAt(i);
          
          // Build words and filter out noise
          if (charStr.match(/[a-zA-Z0-9@._-]/)) {
            currentWord += charStr;
          } else {
            // End of word
            if (currentWord.length >= 2 && 
                !currentWord.match(/^[^a-zA-Z]*$/) && // Not just numbers/symbols
                !currentWord.includes('\\x') && // No hex codes
                !currentWord.match(/^[A-Z0-9]{20,}$/)) { // Not long random strings
              
              readableText += currentWord + charStr;
              wordCount++;
              
              // Add line breaks for readability
              if (charStr === '.' || charStr === '!' || charStr === '?') {
                readableText += '\n';
              }
            }
            currentWord = '';
          }
          
          // Limit output length
          if (wordCount > 500) break;
          
        } else if (char === 10 || char === 13) { // Line breaks
          if (currentWord.length >= 2) {
            readableText += currentWord + '\n';
            currentWord = '';
          }
        }
      }
      
      // Final word processing
      if (currentWord.length >= 2) {
        readableText += currentWord;
      }
      
      // Clean up the text further
      readableText = readableText
        .replace(/\s+/g, ' ') // Normalize whitespace
        .replace(/(.)\1{5,}/g, '$1') // Remove long repeated characters
        .replace(/[^\x20-\x7E\n]/g, '') // Keep only printable ASCII and newlines
        .trim();
      
      // Split into sentences and filter meaningful content
      const sentences = readableText.split(/[.!?\n]+/).filter(sentence => {
        const words = sentence.trim().split(/\s+/);
        return words.length >= 3 && 
               words.length <= 50 && 
               sentence.length >= 10 &&
               sentence.length <= 500 &&
               !sentence.toLowerCase().includes('microsoft outlook') &&
               !sentence.toLowerCase().includes('content-type') &&
               sentence.match(/[a-zA-Z]/);
      });
      
      if (sentences.length > 0) {
        readableText = sentences.slice(0, 10).join('.\n\n').trim();
        if (readableText && !readableText.endsWith('.')) {
          readableText += '.';
        }
      }
      
      // Display the cleaned content
      const displayText = readableText || 'Unable to extract readable content from this MSG file. The file may be corrupted or use an unsupported format.';
      
      document.getElementById('msg-raw-text').textContent = displayText;
      document.getElementById('msg-status-display').textContent = 'Text Cleaned';
      updateMsgStatus('Cleaned text content displayed');
      showMsgSuccess('MSG file processed with enhanced text extraction!');
      
    } else {
      document.getElementById('msg-raw-text').textContent = 'No file content available.';
      updateMsgStatus('No content available');
    }
  } catch (error) {
    console.error('❌ Enhanced text extraction failed:', error);
    document.getElementById('msg-raw-text').textContent = 'Error processing MSG file content.';
    updateMsgStatus('Content processing failed');
  }
}

function toggleEmailView(viewType) {
  const htmlContent = document.getElementById('email-html-content');
  const textContent = document.getElementById('email-text-content');
  const htmlBtn = document.getElementById('html-view-btn');
  const textBtn = document.getElementById('text-view-btn');
  
  if (viewType === 'html' && htmlContent.innerHTML) {
    htmlContent.style.display = 'block';
    textContent.style.display = 'none';
    htmlBtn.classList.add('active');
    textBtn.classList.remove('active');
    currentEmailView = 'html';
    document.getElementById('msg-view-mode').textContent = 'HTML View';
    console.log('📧 Switched to HTML view');
  } else if (viewType === 'text' && textContent.textContent) {
    htmlContent.style.display = 'none';
    textContent.style.display = 'block';
    htmlBtn.classList.remove('active');
    textBtn.classList.add('active');
    currentEmailView = 'text';
    document.getElementById('msg-view-mode').textContent = 'Text View';
    console.log('📧 Switched to text view');
  }
}

function zoomMsgContent(direction) {
  if (direction === 'in') {
    msgZoomLevel = Math.min(msgZoomLevel + 25, 300);
  } else {
    msgZoomLevel = Math.max(msgZoomLevel - 25, 50);
  }
  
  applyMsgZoom();
  console.log('🔍 MSG Zoom:', direction, msgZoomLevel + '%');
}

function applyMsgZoom() {
  const contentContainer = document.getElementById('msg-content');
  const zoomDisplay = document.getElementById('msg-zoom-level');
  
  if (contentContainer) {
    contentContainer.style.transform = `scale(${msgZoomLevel / 100})`;
    contentContainer.style.transformOrigin = 'top left';
    contentContainer.style.width = `${10000 / msgZoomLevel}%`;
  }
  
  if (zoomDisplay) {
    zoomDisplay.textContent = msgZoomLevel + '%';
  }
}

function openMsgNewWindow() {
  console.log('🪟 Opening beautiful MSG information window...');
  const filename = '{{ attachment.filename }}';
  const fileSize = '{{ "%.1f"|format(file_size / 1024 / 1024) }}';
  
  const newWindow = window.open('', '_blank', 'width=900,height=800');
  newWindow.document.write(`
    <html>
    <head>
      <title>Email Message - ${filename}</title>
      <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }
        body { 
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        }
        .container {
          background: white;
          border-radius: 20px;
          box-shadow: 0 25px 50px rgba(0,0,0,0.15);
          overflow: hidden;
          max-width: 700px;
          width: 100%;
          animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
          from { 
            opacity: 0; 
            transform: translateY(30px) scale(0.9); 
          }
          to { 
            opacity: 1; 
            transform: translateY(0) scale(1); 
          }
        }
        .header {
          background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
          color: white;
          padding: 40px 30px;
          text-align: center;
          position: relative;
          overflow: hidden;
        }
        .header::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
          animation: shine 3s infinite;
        }
        @keyframes shine {
          0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
          100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        .header .icon {
          font-size: 72px;
          margin-bottom: 20px;
          position: relative;
          z-index: 1;
        }
        .header h1 {
          font-size: 28px;
          font-weight: 300;
          margin-bottom: 10px;
          position: relative;
          z-index: 1;
        }
        .header p {
          opacity: 0.9;
          font-size: 16px;
          position: relative;
          z-index: 1;
        }
        .content {
          padding: 40px 30px;
        }
        .info-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin-bottom: 30px;
        }
        .info-card {
          background: #f8f9fa;
          padding: 20px;
          border-radius: 12px;
          border-left: 4px solid #007bff;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .info-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .info-card .label {
          font-weight: 600;
          color: #495057;
          margin-bottom: 8px;
          display: flex;
          align-items: center;
        }
        .info-card .value {
          color: #6c757d;
          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
          font-size: 14px;
        }
        .instruction-box {
          background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
          border-radius: 15px;
          padding: 25px;
          margin-bottom: 30px;
          border: 1px solid #90caf9;
        }
        .instruction-box h3 {
          color: #1976d2;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          font-size: 20px;
        }
        .steps {
          list-style: none;
          padding: 0;
        }
        .steps li {
          display: flex;
          align-items: flex-start;
          margin-bottom: 15px;
          padding: 15px;
          background: rgba(255,255,255,0.7);
          border-radius: 10px;
          transition: background 0.2s ease;
        }
        .steps li:hover {
          background: rgba(255,255,255,0.9);
        }
        .step-number {
          background: linear-gradient(135deg, #007bff, #0056b3);
          color: white;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-right: 15px;
          flex-shrink: 0;
          box-shadow: 0 4px 10px rgba(0,123,255,0.3);
        }
        .step-content {
          flex: 1;
        }
        .step-content strong {
          color: #2c3e50;
          display: block;
          margin-bottom: 4px;
        }
        .step-content small {
          color: #7f8c8d;
          line-height: 1.4;
        }
        .actions {
          text-align: center;
          padding-top: 20px;
          border-top: 2px solid #f1f3f4;
        }
        .btn {
          display: inline-block;
          padding: 15px 30px;
          margin: 0 10px;
          border-radius: 50px;
          text-decoration: none;
          font-weight: 600;
          font-size: 16px;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          border: none;
          cursor: pointer;
        }
        .btn-primary {
          background: linear-gradient(135deg, #007bff, #0056b3);
          color: white;
          box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        }
        .btn-primary:hover {
          transform: translateY(-3px);
          box-shadow: 0 12px 35px rgba(0,123,255,0.4);
        }
        .btn-secondary {
          background: linear-gradient(135deg, #6c757d, #5a6268);
          color: white;
          box-shadow: 0 8px 25px rgba(108,117,125,0.3);
        }
        .btn-secondary:hover {
          transform: translateY(-3px);
          box-shadow: 0 12px 35px rgba(108,117,125,0.4);
        }
        .tip {
          background: linear-gradient(135deg, #fff3cd, #ffeaa7);
          border: 1px solid #ffeaa7;
          border-radius: 12px;
          padding: 20px;
          text-align: center;
          margin-top: 25px;
        }
        .tip-icon {
          font-size: 24px;
          margin-bottom: 10px;
        }
        .tip-text {
          color: #856404;
          font-weight: 500;
          line-height: 1.5;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <div class="icon">📧</div>
          <h1>Microsoft Outlook Email</h1>
          <p>Professional email message file</p>
        </div>
        
        <div class="content">
          <div class="info-grid">
            <div class="info-card">
              <div class="label">📁 Filename</div>
              <div class="value">${filename}</div>
            </div>
            <div class="info-card">
              <div class="label">💾 File Size</div>
              <div class="value">${fileSize} MB</div>
            </div>
          </div>
          
          <div class="instruction-box">
            <h3>🔍 How to View This Email</h3>
            <ul class="steps">
              <li>
                <div class="step-number">1</div>
                <div class="step-content">
                  <strong>Download the MSG file</strong>
                  <small>Save the email file to your computer</small>
                </div>
              </li>
              <li>
                <div class="step-number">2</div>
                <div class="step-content">
                  <strong>Open Microsoft Outlook</strong>
                  <small>Launch Outlook application on your device</small>
                </div>
              </li>
              <li>
                <div class="step-number">3</div>
                <div class="step-content">
                  <strong>Double-click the MSG file</strong>
                  <small>Email will open with full formatting and attachments</small>
                </div>
              </li>
            </ul>
          </div>
          
          <div class="actions">
            <a href="data:application/octet-stream;base64,{{ file_base64 }}" 
               download="${filename}" 
               class="btn btn-primary">
              📥 Download Email
            </a>
            <button onclick="window.close()" class="btn btn-secondary">
              ❌ Close Window
            </button>
          </div>
          
          <div class="tip">
            <div class="tip-icon">💡</div>
            <div class="tip-text">
              <strong>Pro Tip:</strong> MSG files preserve all original email formatting, embedded images, 
              and attachments when opened in Microsoft Outlook.
            </div>
          </div>
        </div>
      </div>
    </body>
    </html>
  `);
  newWindow.document.close();
  
  showMsgSuccess('Beautiful MSG information window opened!');
}

function updateMsgStatus(message) {
  const statusElement = document.getElementById('msg-status');
  if (statusElement) {
    statusElement.textContent = message;
  }
  console.log('📧 MSG Status:', message);
}

function showMsgSuccess(message) {
  const successDiv = document.getElementById('msg-success');
  const messageSpan = document.getElementById('msg-success-method');
  if (successDiv && messageSpan) {
    messageSpan.textContent = message;
    successDiv.style.display = 'block';
    
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }
}
</script>

{% endblock %}
