{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: #1669d2; color: #fff;">
      <div>
        <h5 class="mb-0">{{ email.subject or "(No Subject)" }}</h5>
        <small>From: {{ email.sender }} | Received: {% if email.received %}{{ email.received if email.received is string else email.received.strftime('%d %B %Y, %I:%M %p') }}{% else %}N/A{% endif %}</small>
      </div>
      <div class="btn-group">
        <!-- AI Analysis Button (comprehensive only) -->
        <button class="btn btn-outline-warning btn-sm ai-comprehensive-detail-btn" 
                data-email-id="{{ email.id }}" 
                title="Comprehensive AI analysis with attachments">
          <i class="bi bi-gear"></i> AI Analysis
        </button>
        <a href="{{ url_for('int_source') }}#inbox" class="btn btn-outline-light btn-sm">
          <i class="bi bi-arrow-left"></i> Back to Inbox
        </a>
      </div>
    </div>
    <div class="card-body">
      <!-- AI Details Section (always visible) -->
      {% if email.ai_analysis_summary or (email.preparer and 'AI' in email.preparer) %}
        <div class="card border-primary mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-robot"></i> AI Details</h5>
          </div>
          <div class="card-body">
            {% if email.ai_analysis_summary %}
              <div class="mb-3">
                <label class="form-label text-primary"><strong>ü§ñ AI Comprehensive Analysis Report</strong></label>
                <div class="form-control-plaintext bg-light p-3 rounded border">
                  <div style="max-height: 300px; overflow-y: auto;">
                    {{ email.ai_analysis_summary | replace(' | ', '<br><br>') | safe }}
                  </div>
                </div>
              </div>
            {% elif email.preparer and 'AI' in email.preparer %}
              <div class="mb-3">
                <label class="form-label text-warning"><strong>ü§ñ Legacy AI Analysis (Preparer Field)</strong></label>
                <div class="form-control-plaintext bg-warning-subtle p-3 rounded">
                  {% set ai_summary = email.preparer.replace('AI Analysis: ', '').replace('COMPREHENSIVE AI: ', '') %}
                  {{ ai_summary }}
                </div>
              </div>
            {% endif %}
            <small class="text-muted">
              <i class="bi bi-info-circle"></i> This section shows the latest AI-generated analysis report. Each new AI run will overwrite the previous report.
            </small>
          </div>
        </div>
      {% endif %}

      <!-- Case Management Section - Two-tier Reference System -->
      <div class="card border-primary mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-hashtag"></i> Reference Information
          </h5>
        </div>
        <div class="card-body">
          <!-- Source ID (Read-only) -->
          <div class="mb-3">
            <label class="form-label"><strong>Source ID:</strong></label>
            <div class="input-group">
              <span class="input-group-text bg-info text-white">
                <i class="fas fa-envelope"></i>
              </span>
              <input type="text" 
                     class="form-control form-control-lg" 
                     value="EMAIL-{{ email.id }}"
                     readonly
                     style="font-weight: bold; font-family: monospace; font-size: 1.25rem; background-color: #f8f9fa;">
            </div>
            <small class="text-muted mt-1 d-block">
              <i class="bi bi-info-circle"></i> 
              This is the unique identifier for this email (cannot be changed).
            </small>
          </div>

          <!-- Case INT Assignment (Editable) -->
          <form method="POST" action="{{ url_for('update_int_reference', email_id=email.id) }}">
            <div class="row align-items-end">
              <div class="col-md-8">
                <label class="form-label"><strong>Case INT Reference:</strong></label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="fas fa-hashtag"></i>
                  </span>
                  <input type="text" 
                         class="form-control form-control-lg" 
                         id="int_reference_input"
                         name="int_reference_number" 
                         value="{{ get_case_int_reference(email) or '' }}"
                         placeholder="INT-001, INT-123, etc."
                         pattern="INT-\d{1,4}"
                         title="Format: INT-001, INT-123"
                         style="font-weight: bold; font-family: monospace; font-size: 1.25rem;"
                         list="int_reference_suggestions"
                         autocomplete="off">
                  <button type="button" class="btn btn-info" id="btn_next_int" title="Get Next Available INT">
                    <i class="fas fa-plus-circle"></i> Next
                  </button>
                  <button type="button" class="btn btn-secondary" id="btn_search_int" title="Search Existing INT References">
                    <i class="fas fa-search"></i> Search
                  </button>
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save"></i> Assign Case
                  </button>
                </div>
                <!-- Datalist for autocomplete suggestions -->
                <datalist id="int_reference_suggestions"></datalist>
                
                <!-- Search results dropdown -->
                <div id="int_search_results" class="list-group mt-2" style="display: none; max-height: 300px; overflow-y: auto;"></div>
                
                <small class="text-muted mt-2 d-block">
                  <i class="bi bi-info-circle"></i> 
                  Assign this email to a case (Format: INT-001, INT-123). Leave empty if not part of a case.
                </small>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Email Content -->
      {% for block in thread_blocks %}
        <details class="mb-3" {% if loop.first %}open{% endif %}>
          <summary class="fw-bold text-primary mb-2" style="cursor: pointer;">
            {% if block.meta.type == 'current' %}
              üìß Current Email
            {% elif block.meta.type == 'thread' %}
              üìú Previous Email Thread
            {% elif loop.length == 1 %}
              üìß Email Content
            {% else %}
              üìß Email Content {{ loop.index }}
            {% endif %}
          </summary>
          <div class="email-body-enhanced" style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #1669d2; margin: 10px 0;">
            {% if block.content %}
              {{ block.content | safe }}
            {% else %}
              <em class="text-muted">No content available</em>
            {% endif %}
          </div>
        </details>
      {% endfor %}

      <!-- Attachments -->
      {% if attachments %}
        <div class="mb-3">
          <b>Attachments:</b>
          <div class="mt-2">
            {% for att in attachments %}
              <div class="d-flex align-items-center mb-2 p-2 border rounded bg-light">
                <div class="flex-grow-1">
                  <i class="bi bi-paperclip me-2"></i>
                  <strong>{{ att.filename }}</strong>
                </div>
                <div class="btn-group" role="group">
                  <a href="{{ url_for('int_source_embedded_attachment_viewer', att_id=att.id) }}" 
                     class="btn btn-sm btn-outline-primary" 
                     title="View attachment">
                    <i class="bi bi-eye"></i> View
                  </a>
                  <a href="{{ url_for('int_source_download_email_attachment', att_id=att.id) }}" 
                     class="btn btn-sm btn-outline-secondary" 
                     download
                     title="Download attachment">
                    <i class="bi bi-download"></i> Download
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- AI Analysis Results Section -->
      {% if email.alleged_subject and (email.preparer and 'AI' in email.preparer) %}
        <div class="mt-4 mb-4">
          <div class="card border-success">
            <div class="card-header bg-success text-white">
              <h6 class="mb-0"><i class="bi bi-robot"></i> AI Analysis Results</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label text-primary"><strong>üéØ Alleged Subject(s)</strong></label>
                    <div class="form-control-plaintext bg-light p-2 rounded">
                      {{ email.alleged_subject or 'Not identified' }}
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label text-primary"><strong>‚öñÔ∏è Allegation Type(s)</strong></label>
                    <div class="form-control-plaintext bg-light p-2 rounded">
                      {% if email.alleged_nature %}
                        {% set nature_list = email.alleged_nature | from_json %}
                        {% if nature_list and nature_list is iterable and nature_list is not string %}
                          {% for nature in nature_list %}
                            <span class="badge bg-secondary me-1 mb-1">{{ nature }}</span>
                          {% endfor %}
                          <small class="text-muted d-block mt-1">({{ nature_list | length }} categories selected)</small>
                        {% else %}
                          {{ email.alleged_nature }}
                        {% endif %}
                      {% else %}
                        Not classified
                      {% endif %}
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label text-primary"><strong>üìä Source Reliability</strong></label>
                    <div class="form-control-plaintext bg-light p-2 rounded">
                      {% if email.source_reliability %}
                        {{ email.source_reliability }}/5
                        {% if email.source_reliability >= 4 %}
                          <span class="badge bg-success">High</span>
                        {% elif email.source_reliability >= 3 %}
                          <span class="badge bg-warning">Medium</span>
                        {% else %}
                          <span class="badge bg-danger">Low</span>
                        {% endif %}
                      {% else %}
                        Not assessed
                      {% endif %}
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label class="form-label text-primary"><strong>‚úÖ Content Validity</strong></label>
                    <div class="form-control-plaintext bg-light p-2 rounded">
                      {% if email.content_validity %}
                        {{ email.content_validity }}/5
                        {% if email.content_validity >= 4 %}
                          <span class="badge bg-success">High</span>
                        {% elif email.content_validity >= 3 %}
                          <span class="badge bg-warning">Medium</span>
                        {% else %}
                          <span class="badge bg-danger">Low</span>
                        {% endif %}
                      {% else %}
                        Not assessed
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
              
              {% if email.ai_analysis_summary %}
                <div class="mt-3">
                  <label class="form-label text-primary"><strong>ü§ñ AI Comprehensive Analysis Results</strong></label>
                  <div class="form-control-plaintext bg-light p-3 rounded border">
                    <div style="max-height: 200px; overflow-y: auto;">
                      {{ email.ai_analysis_summary | replace(' | ', '<br><br>') | safe }}
                    </div>
                  </div>
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    This comprehensive analysis was generated automatically by AI. Please review and verify all information.
                  </small>
                </div>
              {% elif email.preparer and 'AI' in email.preparer %}
                <div class="mt-3">
                  <label class="form-label text-warning"><strong>ü§ñ Legacy AI Analysis (Preparer Field)</strong></label>
                  <div class="form-control-plaintext bg-warning-subtle p-3 rounded">
                    {% set ai_summary = email.preparer.replace('AI Analysis: ', '').replace('COMPREHENSIVE AI: ', '') %}
                    {{ ai_summary }}
                  </div>
                  <small class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    This is legacy AI data stored in preparer field. Run new AI analysis for comprehensive results.
                  </small>
                </div>
              {% endif %}
              
              <div class="mt-3 text-center">
                <small class="text-muted">
                  <i class="bi bi-lightbulb"></i> 
                  Run AI Comprehensive Analysis above to get detailed reasoning, confidence scores, and risk assessment.
                </small>
              </div>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Assessment Form -->
      <form method="POST" action="{{ url_for('int_source_update_assessment', email_id=email.id) }}" class="mt-4" novalidate>
        <h6 class="text-primary mb-3">Assessment Details</h6>
        <table class="table table-bordered align-middle" style="max-width:800px;margin:auto;">
          <tr>
            <td><b>Date:</b></td>
            <td>{{ (email.assessment_updated_at or "")|strftime("%Y-%m-%d %H:%M:%S") }}</td>
          </tr>
          <tr>
            <td><b>Preparer:</b></td>
            <td>
              {% if email.preparer and ('AI' in email.preparer or 'COMPREHENSIVE' in email.preparer) %}
                <div class="alert alert-info mb-2">
                  <i class="bi bi-robot"></i> 
                  <strong>AI Generated:</strong> This assessment was automatically generated by AI. 
                  Please review and assign a human preparer if needed.
                </div>
              {% endif %}
              
              <select name="preparer" class="form-select">
                <option value="">Select Preparer...</option>
                <option value="Nicola" {% if email.preparer == 'Nicola' %}selected{% endif %}>Nicola</option>
                <option value="Erney" {% if email.preparer == 'Erney' %}selected{% endif %}>Erney</option>
                <option value="Alex" {% if email.preparer == 'Alex' %}selected{% endif %}>Alex</option>
                <option value="Queenie" {% if email.preparer == 'Queenie' %}selected{% endif %}>Queenie</option>
                <option value="Charlie" {% if email.preparer == 'Charlie' %}selected{% endif %}>Charlie</option>
                <option value="Eunice" {% if email.preparer == 'Eunice' %}selected{% endif %}>Eunice</option>
                <option value="Marcus" {% if email.preparer == 'Marcus' %}selected{% endif %}>Marcus</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><b>Alleged Subject(s)</b></td>
            <td>
              <div id="alleged-subjects">
                {# NEW: Use email_alleged_subjects table (correct pairing guaranteed) #}
                {% if alleged_subjects %}
                  {% for subject in alleged_subjects %}
                    <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">üìã Alleged Subject {{ loop.index }}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                          üóëÔ∏è Remove
                        </button>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">üìù English Name</label>
                          <input type="text" name="alleged_subjects_en[]" class="form-control" 
                                 value="{{ subject.english_name or '' }}" 
                                 placeholder="Enter English name">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                          <input type="text" name="alleged_subjects_cn[]" class="form-control" 
                                 value="{{ subject.chinese_name or '' }}"
                                 placeholder="Enter Chinese name">
                        </div>
                      </div>
                      
                      {# License info from new table #}
                      {% set has_license = subject.license_number %}
                      {% set license_type = subject.license_type or '' %}
                      {% set license_num = subject.license_number or '' %}
                      
                      <div class="mb-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)" {% if has_license %}checked{% endif %}>
                          <label class="form-check-label">Is this an insurance intermediary?</label>
                        </div>
                      </div>
                      
                      <div class="insurance-fields" style="display: {% if has_license %}block{% else %}none{% endif %}; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div class="row">
                          <div class="col-6">
                            <label class="form-label">License Type:</label>
                            <select name="intermediary_type[]" class="form-select">
                              <option value="">Select Type</option>
                              <option value="Agent" {% if license_type == 'Agent' %}selected{% endif %}>Agent</option>
                              <option value="Broker" {% if license_type == 'Broker' %}selected{% endif %}>Broker</option>
                              <option value="Other" {% if license_type == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                          </div>
                          <div class="col-6">
                            <label class="form-label">License Number:</label>
                            <input type="text" name="license_numbers[]" class="form-control" value="{{ license_num }}" placeholder="Enter license number">
                          </div>
                        </div>
                      </div>
                      
                      <p class="text-muted mt-2 mb-0">
                        <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                      </p>
                    </div>
                  {% endfor %}
                
                {# FALLBACK: Use old comma-separated columns if new table is empty #}
                {% elif email.alleged_subject_english or email.alleged_subject_chinese %}
                  <div class="alert alert-warning mb-3">
                    ‚ö†Ô∏è <strong>Old Data Format Detected:</strong> This email uses the old storage method. 
                    Please save the assessment to migrate to the new format with correct name pairing.
                  </div>
                  
                  {% set english_names = email.alleged_subject_english.split(',') if email.alleged_subject_english else [] %}
                  {% set chinese_names = email.alleged_subject_chinese.split(',') if email.alleged_subject_chinese else [] %}
                  {% set max_len = [english_names|length, chinese_names|length] | max %}
                  
                  {# Parse saved license info from JSON #}
                  {% set license_numbers = [] %}
                  {% set intermediary_types = [] %}
                  {% if email.license_numbers_json %}
                    {% set license_numbers = email.license_numbers_json | from_json %}
                  {% endif %}
                  {% if email.intermediary_types_json %}
                    {% set intermediary_types = email.intermediary_types_json | from_json %}
                  {% endif %}
                  
                  {% for i in range(max_len) %}
                    <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #fff3cd;">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-warning mb-0">üìã Alleged Subject {{ loop.index }} (Old Format)</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                          üóëÔ∏è Remove
                        </button>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">üìù English Name</label>
                          <input type="text" name="alleged_subjects_en[]" class="form-control" 
                                 value="{{ english_names[i].strip() if i < english_names|length else '' }}" 
                                 placeholder="Enter English name">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                          <input type="text" name="alleged_subjects_cn[]" class="form-control" 
                                 value="{{ chinese_names[i].strip() if i < chinese_names|length else '' }}"
                                 placeholder="Enter Chinese name">
                        </div>
                      </div>
                      
                      {# Get saved license info for this person #}
                      {% set has_license = i < license_numbers|length and license_numbers[i] %}
                      {% set license_type = intermediary_types[i] if i < intermediary_types|length else '' %}
                      {% set license_num = license_numbers[i] if i < license_numbers|length else '' %}
                      
                      <div class="mb-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)" {% if has_license %}checked{% endif %}>
                          <label class="form-check-label">Is this an insurance intermediary?</label>
                        </div>
                      </div>
                      
                      <div class="insurance-fields" style="display: {% if has_license %}block{% else %}none{% endif %}; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div class="row">
                          <div class="col-6">
                            <label class="form-label">License Type:</label>
                            <select name="intermediary_type[]" class="form-select">
                              <option value="">Select Type</option>
                              <option value="Agent" {% if license_type == 'Agent' %}selected{% endif %}>Agent</option>
                              <option value="Broker" {% if license_type == 'Broker' %}selected{% endif %}>Broker</option>
                              <option value="Other" {% if license_type == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                          </div>
                          <div class="col-6">
                            <label class="form-label">License Number:</label>
                            <input type="text" name="license_numbers[]" class="form-control" value="{{ license_num }}" placeholder="Enter license number">
                          </div>
                        </div>
                      </div>
                      
                      <p class="text-muted mt-2 mb-0">
                        <i class="bi bi-exclamation-triangle"></i> Save to migrate to new format with guaranteed correct pairing
                      </p>
                    </div>
                  {% endfor %}
                  
                {% elif email.alleged_subject %}
                  {% set subjects = email.alleged_subject.split(',') %}
                  {% for subject in subjects %}
                    <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">üìã Alleged Subject {{ loop.index }}</h6>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
                          üóëÔ∏è Remove
                        </button>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label class="form-label">üìù English Name</label>
                          <input type="text" name="alleged_subjects_en[]" class="form-control" value="{{ subject.strip() }}" placeholder="Enter English name">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                          <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
                        </div>
                      </div>
                      
                      <div class="mb-3">
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                          <label class="form-check-label">Is this an insurance intermediary?</label>
                        </div>
                      </div>
                      
                      <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <div class="row">
                          <div class="col-6">
                            <label class="form-label">License Type:</label>
                            <select name="intermediary_type[]" class="form-select">
                              <option value="">Select Type</option>
                              <option value="Agent">Agent</option>
                              <option value="Broker">Broker</option>
                              <option value="Other">Other</option>
                            </select>
                          </div>
                          <div class="col-6">
                            <label class="form-label">License Number:</label>
                            <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                          </div>
                        </div>
                      </div>
                      
                      <p class="text-muted mt-2 mb-0">
                        <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                      </p>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="alleged-subject-row mb-3 p-3 border rounded" style="background-color: #f8f9fa;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <h6 class="text-primary mb-0">üìã Alleged Subject Details</h6>
                      <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)" style="display: none;">
                        üóëÔ∏è Remove
                      </button>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label class="form-label">üìù English Name</label>
                        <input type="text" name="alleged_subjects_en[]" class="form-control" placeholder="Enter English name">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
                        <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
                      </div>
                    </div>
                    
                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
                        <label class="form-check-label">Is this an insurance intermediary?</label>
                      </div>
                    </div>
                    
                    <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                      <div class="row">
                        <div class="col-6">
                          <label class="form-label">License Type:</label>
                          <select name="intermediary_type[]" class="form-select">
                            <option value="">Select Type</option>
                            <option value="Agent">Agent</option>
                            <option value="Broker">Broker</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div class="col-6">
                          <label class="form-label">License Number:</label>
                          <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
                        </div>
                      </div>
                    </div>
                    
                    <p class="text-muted mt-2 mb-0">
                      <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
                    </p>
                  </div>
                {% endif %}
              </div>
              <div class="text-center mt-3">
                <button class="btn btn-success" type="button" onclick="addAllegedSubject()">
                  ‚ûï Add Another Subject (English/Chinese)
                </button>
              </div>
              <div class="alert alert-info mt-3">
                <i class="bi bi-lightbulb"></i> 
                <strong>Tip:</strong> You can add multiple alleged subjects, each with English and Chinese names
              </div>
            </td>
          </tr>
          <tr>
            <td><b>Alleged Nature</b><br><small class="text-muted">Select multiple categories (searchable)</small></td>
            <td>
              <!-- Hidden input to store JSON array -->
              <input type="hidden" name="alleged_nature" id="alleged_nature_input" value="{{ email.alleged_nature or '[]' }}">
              
              <!-- Search Box -->
              <div class="mb-2">
                <input type="text" 
                       id="alleged_nature_search" 
                       class="form-control" 
                       placeholder="üîç Search categories... (e.g., MPF, Conduct, F&P)"
                       onkeyup="filterAllegedNature()">
              </div>
              
              <!-- Selected Items Display -->
              <div id="selected_natures" class="mb-2" style="min-height: 40px; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem; background-color: #f8f9fa;">
                <small class="text-muted">Selected: <span id="selected_count">0</span> categories</small>
                <div id="selected_badges" class="mt-2"></div>
              </div>
              
              <!-- Dropdown with Categories -->
              <div class="accordion" id="allegedNatureAccordion" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                
                <!-- Part 1 - AMLO -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#amlo">
                      Part 1 - AMLO
                    </button>
                  </h2>
                  <div id="amlo" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check">
                        <input class="form-check-input alleged-nature-checkbox" type="checkbox" value="1.1 AMLO relates Breaches and Offences on Insurer, Broker company or Insurance agency" id="amlo_1_1">
                        <label class="form-check-label" for="amlo_1_1">1.1 AMLO relates Breaches and Offences on Insurer, Broker company or Insurance agency</label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Part 2 - MPF -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mpf">
                      Part 2 - MPF
                    </button>
                  </h2>
                  <div id="mpf" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.1 MPF - Unauthorised Transfer" id="mpf_2_1"><label class="form-check-label" for="mpf_2_1">2.1 MPF - Unauthorised Transfer</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.2 MPF - Forgery, Forged signature, Use of Forged Documents" id="mpf_2_2"><label class="form-check-label" for="mpf_2_2">2.2 MPF - Forgery, Forged signature, Use of Forged Documents</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.3 MPF - Impersonation / Other Fraudulent Acts" id="mpf_2_3"><label class="form-check-label" for="mpf_2_3">2.3 MPF - Impersonation / Other Fraudulent Acts</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.4 MPF - Misrepresentation / Make False Declaration / Misleading statement (S.43E)" id="mpf_2_4"><label class="form-check-label" for="mpf_2_4">2.4 MPF - Misrepresentation / Make False Declaration / Misleading statement (S.43E)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.5 MPF cases - Prohibition (s.34L) / Unregistered Selling or Advising" id="mpf_2_5"><label class="form-check-label" for="mpf_2_5">2.5 MPF cases - Prohibition (s.34L) / Unregistered Selling or Advising</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.6 MPF - Other Misconduct / Breach on Selling / Advising / Applications / After Service" id="mpf_2_6"><label class="form-check-label" for="mpf_2_6">2.6 MPF - Other Misconduct / Breach on Selling / Advising / Applications / After Service</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.7 MPF - Principal Intermediary's Duties, Control and Monitoring, etc." id="mpf_2_7"><label class="form-check-label" for="mpf_2_7">2.7 MPF - Principal Intermediary's Duties, Control and Monitoring, etc.</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="2.8 MPF - Others" id="mpf_2_8"><label class="form-check-label" for="mpf_2_8">2.8 MPF - Others</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 3 - CPD -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cpd">
                      Part 3 - CPD
                    </button>
                  </h2>
                  <div id="cpd" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="3.1 CPD Non-Compliance(Failing to fulfill CPD hour requirements)" id="cpd_3_1"><label class="form-check-label" for="cpd_3_1">3.1 CPD Non-Compliance(Failing to fulfill CPD hour requirements)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="3.2 CPD Non-Compliance (Principal's Duty /Obligations)" id="cpd_3_2"><label class="form-check-label" for="cpd_3_2">3.2 CPD Non-Compliance (Principal's Duty /Obligations)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="3.3 CPD Non-Compliance (Others)" id="cpd_3_3"><label class="form-check-label" for="cpd_3_3">3.3 CPD Non-Compliance (Others)</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 4 - Miscellaneous -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#misc">
                      Part 4 - Miscellaneous
                    </button>
                  </h2>
                  <div id="misc" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="4.1 Others" id="misc_4_1"><label class="form-check-label" for="misc_4_1">4.1 Others</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="4.2 SRO Cases (Misconduct)" id="misc_4_2"><label class="form-check-label" for="misc_4_2">4.2 SRO Cases (Misconduct)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="4.3 SRO Cases (Contravention of SRO Rules and Requirement)" id="misc_4_3"><label class="form-check-label" for="misc_4_3">4.3 SRO Cases (Contravention of SRO Rules and Requirement)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="4.4 SRO Cases (F&P)" id="misc_4_4"><label class="form-check-label" for="misc_4_4">4.4 SRO Cases (F&P)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="4.5 SRO Cases (Appeal)" id="misc_4_5"><label class="form-check-label" for="misc_4_5">4.5 SRO Cases (Appeal)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="4.6 Request Information / Assistance from Stakeholders" id="misc_4_6"><label class="form-check-label" for="misc_4_6">4.6 Request Information / Assistance from Stakeholders</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 5 - Conduct -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#conduct">
                      Part 5 - Conduct
                    </button>
                  </h2>
                  <div id="conduct" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.1 Conduct - Misappropriation / Fraud" id="conduct_5_1"><label class="form-check-label" for="conduct_5_1">5.1 Conduct - Misappropriation / Fraud</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.2 Conduct - Handling of Clients Premium or Money" id="conduct_5_2"><label class="form-check-label" for="conduct_5_2">5.2 Conduct - Handling of Clients Premium or Money</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.3 Conduct - Misrepresentation / Mis-selling (e.g. policy terms and condition, premium features, payment terms, returns on investment/ dividend / bonus, etc.)" id="conduct_5_3"><label class="form-check-label" for="conduct_5_3">5.3 Conduct - Misrepresentation / Mis-selling</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.4 Conduct - Forgery, Forged signature, Use of Forged Documents (insurance related documents)" id="conduct_5_4"><label class="form-check-label" for="conduct_5_4">5.4 Conduct - Forgery, Forged signature, Use of Forged Documents</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.5 Conduct - Impersonation / other Fraudulent Acts" id="conduct_5_5"><label class="form-check-label" for="conduct_5_5">5.5 Conduct - Impersonation / other Fraudulent Acts</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.6 Conduct - Concealment of Policyholders Information (e.g. on policy application form)" id="conduct_5_6"><label class="form-check-label" for="conduct_5_6">5.6 Conduct - Concealment of Policyholders Information</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.7 Conduct - Unauthorized Policy Application / Change" id="conduct_5_7"><label class="form-check-label" for="conduct_5_7">5.7 Conduct - Unauthorized Policy Application / Change</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.8 Conduct - Twisting/ Policy Replacement" id="conduct_5_8"><label class="form-check-label" for="conduct_5_8">5.8 Conduct - Twisting/ Policy Replacement</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.9 Conduct - Cross-border Selling" id="conduct_5_9"><label class="form-check-label" for="conduct_5_9">5.9 Conduct - Cross-border Selling</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.10 Conduct - Inappropriate Advice" id="conduct_5_10"><label class="form-check-label" for="conduct_5_10">5.10 Conduct - Inappropriate Advice</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.11 Conduct - Suitability (e.g. FNA) / Affordability" id="conduct_5_11"><label class="form-check-label" for="conduct_5_11">5.11 Conduct - Suitability (e.g. FNA) / Affordability</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.12 Conduct - Due Care, Skill & Diligence" id="conduct_5_12"><label class="form-check-label" for="conduct_5_12">5.12 Conduct - Due Care, Skill & Diligence</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.13 Conduct - Prompt Execution" id="conduct_5_13"><label class="form-check-label" for="conduct_5_13">5.13 Conduct - Prompt Execution</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.14 Conduct - Use of Unauthorized Marketing Materials" id="conduct_5_14"><label class="form-check-label" for="conduct_5_14">5.14 Conduct - Use of Unauthorized Marketing Materials</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.15 Conduct - Commission Rebate" id="conduct_5_15"><label class="form-check-label" for="conduct_5_15">5.15 Conduct - Commission Rebate</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.16 Conduct - Request Client to Sign on Blank / Incomplete Form(s)" id="conduct_5_16"><label class="form-check-label" for="conduct_5_16">5.16 Conduct - Request Client to Sign on Blank / Incomplete Form(s)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.17 Conduct - Delivery of Policy Contract Within Cooling-off Period" id="conduct_5_17"><label class="form-check-label" for="conduct_5_17">5.17 Conduct - Delivery of Policy Contract Within Cooling-off Period</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.18 Conduct - Handling of Customer Personal Data" id="conduct_5_18"><label class="form-check-label" for="conduct_5_18">5.18 Conduct - Handling of Customer Personal Data</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="5.19 Conduct - Others (e.g. failing to act honestly, fairly, in the best interests of the client, conflict of interest, etc.)" id="conduct_5_19"><label class="form-check-label" for="conduct_5_19">5.19 Conduct - Others</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 6 - Firm's control and deficiency -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#firm">
                      Part 6 - Firm's control and deficiency
                    </button>
                  </h2>
                  <div id="firm" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="6.1 Internal Control / Corporate Governance" id="firm_6_1"><label class="form-check-label" for="firm_6_1">6.1 Internal Control / Corporate Governance</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="6.2 Deficiency in Business, Operations and Claims" id="firm_6_2"><label class="form-check-label" for="firm_6_2">6.2 Deficiency in Business, Operations and Claims</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="6.3 Deficiency in Service (Individual and firm) / Complaint Handling" id="firm_6_3"><label class="form-check-label" for="firm_6_3">6.3 Deficiency in Service (Individual and firm) / Complaint Handling</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="6.4 Deficiency in Others Aspects" id="firm_6_4"><label class="form-check-label" for="firm_6_4">6.4 Deficiency in Others Aspects</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 7 - F&P -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fp">
                      Part 7 - F&P
                    </button>
                  </h2>
                  <div id="fp" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.1 F&P - False Academic Certificates" id="fp_7_1"><label class="form-check-label" for="fp_7_1">7.1 F&P - False Academic Certificates</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.2 F&P - False Declaration / Forgery / Use of Forged Documents (e.g. license application)" id="fp_7_2"><label class="form-check-label" for="fp_7_2">7.2 F&P - False Declaration / Forgery / Use of Forged Documents (e.g. license application)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.3 F&P - False Declaration / Forgery / Use of Forged Documents (e.g. unauthorised policy application)" id="fp_7_3"><label class="form-check-label" for="fp_7_3">7.3 F&P - False Declaration / Forgery / Use of Forged Documents (e.g. unauthorised policy application)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.4 F&P - Impersonation / Other Fraudulent Acts" id="fp_7_4"><label class="form-check-label" for="fp_7_4">7.4 F&P - Impersonation / Other Fraudulent Acts</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.5 F&P - Disciplinary imposed by Other Regulators / LEAs (e.g. MPFA, SFC, HKMA, etc.)" id="fp_7_5"><label class="form-check-label" for="fp_7_5">7.5 F&P - Disciplinary imposed by Other Regulators / LEAs</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.6 F&P - Criminal Conviction" id="fp_7_6"><label class="form-check-label" for="fp_7_6">7.6 F&P - Criminal Conviction</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.7 F&P - Bankruptcy" id="fp_7_7"><label class="form-check-label" for="fp_7_7">7.7 F&P - Bankruptcy</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.8 F&P - Non-Compliance with Guidelines and Rules issued by IA / SROs" id="fp_7_8"><label class="form-check-label" for="fp_7_8">7.8 F&P - Non-Compliance with Guidelines and Rules issued by IA / SROs</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.9 F&P - Failure to Comply with Internal Guidelines of insurer" id="fp_7_9"><label class="form-check-label" for="fp_7_9">7.9 F&P - Failure to Comply with Internal Guidelines of insurer</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.10 F&P - Failure to Comply with Internal Guidelines of Insurance Agency / Broker Company" id="fp_7_10"><label class="form-check-label" for="fp_7_10">7.10 F&P - Failure to Comply with Internal Guidelines of Insurance Agency / Broker Company</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.11 F&P - Failure / Late Submission of Non Statutory Returns / Report" id="fp_7_11"><label class="form-check-label" for="fp_7_11">7.11 F&P - Failure / Late Submission of Non Statutory Returns / Report</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.12 F&P - Others (e.g. due to the misconduct / breach under the IO)" id="fp_7_12"><label class="form-check-label" for="fp_7_12">7.12 F&P - Others (e.g. due to the misconduct / breach under the IO)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.13 F&P - Others (e.g. due to the misconduct / breach under subsidiary legislation (e.g. 41LA-41S))" id="fp_7_13"><label class="form-check-label" for="fp_7_13">7.13 F&P - Others (e.g. due to the misconduct / breach under subsidiary legislation)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="7.14 F&P - Others (e.g. due to the misconduct / breach under the AMLO)" id="fp_7_14"><label class="form-check-label" for="fp_7_14">7.14 F&P - Others (e.g. due to the misconduct / breach under the AMLO)</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 8 - F&P (MPF) -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fp_mpf">
                      Part 8 - F&P (investigate under IO on MPF cases)
                    </button>
                  </h2>
                  <div id="fp_mpf" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.1 F&P - (MPF without RA) Unauthorized Transfer" id="fp_mpf_8_1"><label class="form-check-label" for="fp_mpf_8_1">8.1 F&P - (MPF without RA) Unauthorized Transfer</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.2 F&P - (MPF without RA) Forgery, Forged signature, Use of Forged Documents" id="fp_mpf_8_2"><label class="form-check-label" for="fp_mpf_8_2">8.2 F&P - (MPF without RA) Forgery, Forged signature, Use of Forged Documents</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.3 F&P - (MPF without RA) Impersonation / Other Fraudulent Acts" id="fp_mpf_8_3"><label class="form-check-label" for="fp_mpf_8_3">8.3 F&P - (MPF without RA) Impersonation / Other Fraudulent Acts</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.4 F&P - (MPF without RA) Misrepresentation / Make False Declaration / Misleading Statement (s.43E)" id="fp_mpf_8_4"><label class="form-check-label" for="fp_mpf_8_4">8.4 F&P - (MPF without RA) Misrepresentation / Make False Declaration / Misleading Statement (s.43E)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.5 F&P (MPF) Prohibition (s.34L) / Unregistered Selling or Advising" id="fp_mpf_8_5"><label class="form-check-label" for="fp_mpf_8_5">8.5 F&P (MPF) Prohibition (s.34L) / Unregistered Selling or Advising</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.6 F&P (MPF without RA) Other MPF breach and Misconduct Issues" id="fp_mpf_8_6"><label class="form-check-label" for="fp_mpf_8_6">8.6 F&P (MPF without RA) Other MPF breach and Misconduct Issues</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.7 F&P (MPF without RA) Principal Intermediary's Duties, Control and Monitoring, etc." id="fp_mpf_8_7"><label class="form-check-label" for="fp_mpf_8_7">8.7 F&P (MPF without RA) Principal Intermediary's Duties, Control and Monitoring, etc.</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="8.8 F&P (MPF without RA)- Others" id="fp_mpf_8_8"><label class="form-check-label" for="fp_mpf_8_8">8.8 F&P (MPF without RA)- Others</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 9 - Contravention under IO (Cap. 41) -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cap41">
                      Part 9 - Contravention under IO (Cap. 41)
                    </button>
                  </h2>
                  <div id="cap41" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.1 (Cap. 41) Contravention of Capital Requirements and Related Reporting Requirements (s13AA)" id="cap41_9_1"><label class="form-check-label" for="cap41_9_1">9.1 (Cap. 41) Contravention of Capital Requirements</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.2 (Cap. 41) Contravention on Approval of Controllers of Authorized Insurers (s13A) / Persons Proposing to Become Shareholder Controllers (s.13B)" id="cap41_9_2"><label class="form-check-label" for="cap41_9_2">9.2 (Cap. 41) Contravention on Approval of Controllers</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.3 (Cap.41) Provide False information in Connection with Application for Approval (s.13AH)" id="cap41_9_3"><label class="form-check-label" for="cap41_9_3">9.3 (Cap.41) Provide False information in Connection with Application</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.4 (Cap. 41) Notification of Change of Particulars of Insurer / Directors, Controllers or KPIC (s.14(1)&(2))" id="cap41_9_4"><label class="form-check-label" for="cap41_9_4">9.4 (Cap. 41) Notification of Change of Particulars</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.5 (Cap. 41) Notification for Appointment / Cessation of Appointment of Director, Controller, KPIC (s.14(3))" id="cap41_9_5"><label class="form-check-label" for="cap41_9_5">9.5 (Cap. 41) Notification for Appointment / Cessation</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.6 (Cap. 41) Non-compliance on Submission of Statements, Reports as Required by Rule made under s.129 (s.17) / Rule 88 (Cap. 41R)" id="cap41_9_6"><label class="form-check-label" for="cap41_9_6">9.6 (Cap. 41) Non-compliance on Submission of Statements, Reports</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.7 (Cap. 41) Non-compliance with requirements imposed by IA under s.27-32, 32A, 33, 34, 35(1) or 35AA (e.g. fail to comply with Intervention Notice) (s.41)" id="cap41_9_7"><label class="form-check-label" for="cap41_9_7">9.7 (Cap. 41) Non-compliance with requirements imposed by IA</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.8 (Cap. 41) Restriction on Carrying on Regulated Activities (s64G), e.g. holding out as insurance agent" id="cap41_9_8"><label class="form-check-label" for="cap41_9_8">9.8 (Cap. 41) Restriction on Carrying on Regulated Activities</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.9 (Cap. 41) Contravention of the Restrictions in relation to Personnel of Licensed Insurance Agencies (s. 64J(2)(b), (c) and (d))" id="cap41_9_9"><label class="form-check-label" for="cap41_9_9">9.9 (Cap. 41) Contravention of the Restrictions in relation to Personnel of Licensed Insurance Agencies</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.10 (Cap. 41) Contravention of the Restrictions in relation to Personnel of Licensed Insurance Broker Companies (s. 64K(2))" id="cap41_9_10"><label class="form-check-label" for="cap41_9_10">9.10 (Cap. 41) Contravention of the Restrictions in relation to Personnel of Licensed Insurance Broker Companies</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.11 (Cap. 41) Failure to Notify IA for Changes of Personal Particulars of a Licensed Insurance intermediary within Specified Time (s.64P)" id="cap41_9_11"><label class="form-check-label" for="cap41_9_11">9.11 (Cap. 41) Failure to Notify IA for Changes of Personal Particulars</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.12 (Cap. 41) Failure to Notify IA of Termination of Appointment of a Licensed Insurance Intermediary (s. 64R(2) to (4))" id="cap41_9_12"><label class="form-check-label" for="cap41_9_12">9.12 (Cap. 41) Failure to Notify IA of Termination of Appointment</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.13 (Cap. 41) Failure to notify IA of Appointment of a Licensed Insurance Intermediary (s. 64Q(3) to (4))" id="cap41_9_13"><label class="form-check-label" for="cap41_9_13">9.13 (Cap. 41) Failure to notify IA of Appointment</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.14 (Cap. 41) Failure to notify IA of Cessation of Carrying on of Regulated Activities by a Licensed Insurance Broker Company (s. 64T)" id="cap41_9_14"><label class="form-check-label" for="cap41_9_14">9.14 (Cap. 41) Failure to notify IA of Cessation of Carrying on of Regulated Activities</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.15 (Cap. 41) Failure to Notify IA of Change in a Partner, Director or Controller of a Licensed Insurance Agency (s. 64ZZD(1))" id="cap41_9_15"><label class="form-check-label" for="cap41_9_15">9.15 (Cap. 41) Failure to Notify IA of Change in a Partner, Director or Controller</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.16 (Cap. 41) Failure to Notify IA of Change in a director or controller of a licensed insurance broker company (s. 64ZZD(2))" id="cap41_9_16"><label class="form-check-label" for="cap41_9_16">9.16 (Cap. 41) Failure to Notify IA of Change in a director or controller</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.17 (Cap. 41) Provision of False and Misleading Information in relation to License/Approval Application (s64ZZE)" id="cap41_9_17"><label class="form-check-label" for="cap41_9_17">9.17 (Cap. 41) Provision of False and Misleading Information</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.18 (Cap. 41) Failure to Comply with Requirement (e.g. PN / IN) in relation to Investigation (s64ZZL)" id="cap41_9_18"><label class="form-check-label" for="cap41_9_18">9.18 (Cap. 41) Failure to Comply with Requirement in relation to Investigation</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.19 (Cap. 41) Destroy, Falsify, Conceal, Dispose of Records and Documents (s.64ZZN)" id="cap41_9_19"><label class="form-check-label" for="cap41_9_19">9.19 (Cap. 41) Destroy, Falsify, Conceal, Dispose of Records and Documents</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.20 (Cap. 41) Contravention of the Requirement to Appoint Auditor by an Insurance Broker Company (s. 72(1), (3) and (4))" id="cap41_9_20"><label class="form-check-label" for="cap41_9_20">9.20 (Cap. 41) Contravention of the Requirement to Appoint Auditor</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.21 (Cap. 41) Broker's failure to submit audited Financial Statements to IA without 6 months after the end of financial year (s. 73)" id="cap41_9_21"><label class="form-check-label" for="cap41_9_21">9.21 (Cap. 41) Broker's failure to submit audited Financial Statements</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.22 (Cap. 41) Induce or Attempt to Induce Another Person to Enter into a Contract of Insurance by Misleading Statement / False Information (s. 119)" id="cap41_9_22"><label class="form-check-label" for="cap41_9_22">9.22 (Cap. 41) Induce by Misleading Statement / False Information</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="9.23 (Cap. 41) Restriction on Use of Certain Terms and Representations Associated with Insurance Business (s.120)" id="cap41_9_23"><label class="form-check-label" for="cap41_9_23">9.23 (Cap. 41) Restriction on Use of Certain Terms and Representations</label></div>
                    </div>
                  </div>
                </div>

                <!-- Part 10 - Contravention under Broker Rules (Cap. 41L) -->
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cap41l">
                      Part 10 - Contravention under Broker Rules (Cap. 41L)
                    </button>
                  </h2>
                  <div id="cap41l" class="accordion-collapse collapse" data-bs-parent="#allegedNatureAccordion">
                    <div class="accordion-body">
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.1 (Cap. 41L) Failure to Maintain Minimum Net Assets (Rule 4)" id="cap41l_10_1"><label class="form-check-label" for="cap41l_10_1">10.1 (Cap. 41L) Failure to Maintain Minimum Net Assets</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.2 (Cap. 41L) Failure to Maintain Professional Indemnity Insurance (PII) (Rule 5(1), (2) and (3))" id="cap41l_10_2"><label class="form-check-label" for="cap41l_10_2">10.2 (Cap. 41L) Failure to Maintain Professional Indemnity Insurance (PII)</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.3 (Cap. 41L) Failure to Include a Provision for at least One Automatic Reinstatement (Rule 5(4))" id="cap41l_10_3"><label class="form-check-label" for="cap41l_10_3">10.3 (Cap. 41L) Failure to Include a Provision for at least One Automatic Reinstatement</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.4 (Cap. 41L) Deductible Amount under the PII is more than 50% of the Company's Net Assets (Rule 5(5) and (6))" id="cap41l_10_4"><label class="form-check-label" for="cap41l_10_4">10.4 (Cap. 41L) Deductible Amount under the PII is more than 50%</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.5 (Cap. 41L) Failure to Keep Separate Client Account (Rule 6(1), (2), (3) or (4))" id="cap41l_10_5"><label class="form-check-label" for="cap41l_10_5">10.5 (Cap. 41L) Failure to Keep Separate Client Account</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.6 (Cap. 41L) Failure to pay monies into client account (Rule 6(5))" id="cap41l_10_6"><label class="form-check-label" for="cap41l_10_6">10.6 (Cap. 41L) Failure to pay monies into client account</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.7 (Cap. 41L) Monies other than those Described under Rule 6(5) and (6) Paid into Client Account (Rule 6(7))" id="cap41l_10_7"><label class="form-check-label" for="cap41l_10_7">10.7 (Cap. 41L) Monies other than those Described Paid into Client Account</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.8 (Cap. 41L) Improper Withdrawal of Funds from Client Account (Rule 6(8))" id="cap41l_10_8"><label class="form-check-label" for="cap41l_10_8">10.8 (Cap. 41L) Improper Withdrawal of Funds from Client Account</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.9 (Cap. 41L) Failure to Compare Total Ledger Balances and Prepare Reconciliation Statement (Rule 6(11))" id="cap41l_10_9"><label class="form-check-label" for="cap41l_10_9">10.9 (Cap. 41L) Failure to Compare Total Ledger Balances</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.10 (Cap. 41L) Failure to Keep Proper Books and Accounts (Rule 7)" id="cap41l_10_10"><label class="form-check-label" for="cap41l_10_10">10.10 (Cap. 41L) Failure to Keep Proper Books and Accounts</label></div>
                      <div class="form-check"><input class="form-check-input alleged-nature-checkbox" type="checkbox" value="10.11 (Cap. 41L) Failure to Submit Audited Financial Statements and/or Auditor's Compliance Report (Rules 8 and 9)" id="cap41l_10_11"><label class="form-check-label" for="cap41l_10_11">10.11 (Cap. 41L) Failure to Submit Audited Financial Statements</label></div>
                    </div>
                  </div>
                </div>

              </div>
            </td>
          </tr>
          <tr>
            <td><b>Allegation Summary</b><br><small class="text-muted">Detailed description of the allegation</small></td>
            <td>
              <textarea name="allegation_summary" class="form-control" rows="4" placeholder="Enter detailed description of the allegation/complaint...">{{ email.allegation_summary or '' }}</textarea>
            </td>
          </tr>
          <tr>
            <td><b>Source Reliability</b></td>
            <td>
              <select name="source_reliability" class="form-select">
                <option value="">Select...</option>
                <option value="5" {% if email.source_reliability == 5 %}selected{% endif %}>5 - Completely Reliable</option>
                <option value="4" {% if email.source_reliability == 4 %}selected{% endif %}>4 - Usually Reliable</option>
                <option value="3" {% if email.source_reliability == 3 %}selected{% endif %}>3 - Fairly Reliable</option>
                <option value="2" {% if email.source_reliability == 2 %}selected{% endif %}>2 - Not Usually Reliable</option>
                <option value="1" {% if email.source_reliability == 1 %}selected{% endif %}>1 - Unreliable</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><b>Content Validity</b></td>
            <td>
              <select name="content_validity" class="form-select">
                <option value="">Select...</option>
                <option value="5" {% if email.content_validity == 5 %}selected{% endif %}>5 - Confirmed True</option>
                <option value="4" {% if email.content_validity == 4 %}selected{% endif %}>4 - Probably True</option>
                <option value="3" {% if email.content_validity == 3 %}selected{% endif %}>3 - Doubtfully True</option>
                <option value="2" {% if email.content_validity == 2 %}selected{% endif %}>2 - Probably False</option>
                <option value="1" {% if email.content_validity == 1 %}selected{% endif %}>1 - Confirmed False</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><b>Combined Score</b></td>
            <td>
              {% set reviewer_name = (email.reviewer_name or '').strip() %}
              {% set reviewer_comment = (email.reviewer_comment or '').strip() %}
              {% set combined_score = (email.source_reliability or 0) + (email.content_validity or 0) %}
              {% set has_assessment = email.source_reliability is not none or email.content_validity is not none or email.alleged_nature or email.allegation_summary or email.preparer %}
              
              <span class="fw-bold">{{ combined_score }}</span>
              
              {% if email.source_reliability is none or email.content_validity is none or not reviewer_name or not reviewer_comment %}
                {% if has_assessment %}
                  <span class="badge bg-info ms-2">
                    <i class="fas fa-edit"></i> Assessment Inputted
                  </span>
                {% else %}
                  <span class="badge bg-light text-muted ms-2">
                    <i class="fas fa-clock"></i> Pending
                  </span>
                {% endif %}
              {% elif combined_score >= 8 and email.reviewer_decision == 'agree' %}
                <span class="badge bg-success ms-2">
                  <i class="fas fa-check-circle"></i> Case Opened
                </span>
              {% elif email.reviewer_decision == 'disagree' %}
                <span class="badge bg-danger ms-2">
                  <i class="fas fa-times-circle"></i> Disagreed
                </span>
              {% else %}
                <span class="badge bg-secondary ms-2">
                  <i class="fas fa-info-circle"></i> Unsubstantial
                </span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td><b>Reviewer</b></td>
            <td>
              <input type="text" name="reviewer_name" value="{{ email.reviewer_name or '' }}" class="form-control" placeholder="Enter reviewer name">
            </td>
          </tr>
          <tr>
            <td><b>Reviewer Comment</b></td>
            <td>
              <textarea name="reviewer_comment" class="form-control" rows="2" placeholder="e.g. Agree with the score, or provide reasoning">{{ email.reviewer_comment or '' }}</textarea>
            </td>
          </tr>
          <tr>
            <td><b>Reviewer Decision</b></td>
            <td>
              <select name="reviewer_decision" class="form-select">
                <option value="">Select Decision...</option>
                <option value="agree" {% if email.reviewer_decision == 'agree' %}selected{% endif %}>[AGREE] Agree</option>
                <option value="disagree" {% if email.reviewer_decision == 'disagree' %}selected{% endif %}>[DISAGREE] Disagree</option>
              </select>
              <small class="text-muted">
                This decision affects whether an intelligence case will be opened based on the combined score.
              </small>
            </td>
          </tr>
          <tr>
            <td colspan="2" class="text-end">
              <button type="submit" class="btn btn-primary" id="saveAssessmentBtn">Save Assessment</button>
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>
</div>

<style>
.email-body-enhanced {
  margin-bottom: 8px;
  padding: 14px 18px;
  background: #fcfcfd;
  border-radius: 5px;
  border: 1px solid #e5e7eb;
  word-break: break-word;
  font-family: 'Segoe UI', Arial, sans-serif;
  font-size: 1.08em;
  line-height: 1.7;
}
.email-body-enhanced blockquote, .email-body-enhanced .quoted {
  margin: 8px 0 8px 12px;
  padding-left: 12px;
  border-left: 3px solid #b3c6e0;
  color: #555;
  background: #f4f7fa;
}
</style>

<script>
// Force form submission without validation
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form[action*="update_assessment"]');
  const saveBtn = document.getElementById('saveAssessmentBtn');
  
  if (form && saveBtn) {
    // Remove any HTML5 validation
    form.setAttribute('novalidate', 'true');
    
    // Override form submission to bypass validation
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Remove validation from all form elements
      const allInputs = form.querySelectorAll('input, select, textarea');
      allInputs.forEach(function(input) {
        input.removeAttribute('required');
        input.setCustomValidity('');
      });
      
      // Force form submission
      form.submit();
    });
    
    // Also handle button click directly
    saveBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Remove validation from all form elements
      const allInputs = form.querySelectorAll('input, select, textarea');
      allInputs.forEach(function(input) {
        input.removeAttribute('required');
        input.setCustomValidity('');
      });
      
      // Force form submission
      form.submit();
    });
  }
});

// ===== ALLEGED NATURE MULTI-SELECT FUNCTIONALITY =====
let selectedAllegedNatures = [];

// Initialize alleged nature on page load
document.addEventListener('DOMContentLoaded', function() {
  initializeAllegedNature();
  updateSelectedDisplay();
  
  // Add change listeners to all checkboxes
  document.querySelectorAll('.alleged-nature-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        if (!selectedAllegedNatures.includes(this.value)) {
          selectedAllegedNatures.push(this.value);
        }
      } else {
        selectedAllegedNatures = selectedAllegedNatures.filter(item => item !== this.value);
      }
      updateSelectedDisplay();
      updateHiddenInput();
    });
  });
});

function initializeAllegedNature() {
  // Load existing values from hidden input
  const hiddenInput = document.getElementById('alleged_nature_input');
  if (hiddenInput && hiddenInput.value) {
    try {
      const existing = JSON.parse(hiddenInput.value);
      if (Array.isArray(existing)) {
        selectedAllegedNatures = existing;
        
        // Check the corresponding checkboxes
        selectedAllegedNatures.forEach(value => {
          const checkbox = document.querySelector(`.alleged-nature-checkbox[value="${value}"]`);
          if (checkbox) {
            checkbox.checked = true;
            
            // Expand the parent accordion section
            const accordionItem = checkbox.closest('.accordion-item');
            if (accordionItem) {
              const collapseDiv = accordionItem.querySelector('.accordion-collapse');
              const button = accordionItem.querySelector('.accordion-button');
              if (collapseDiv && button) {
                collapseDiv.classList.add('show');
                button.classList.remove('collapsed');
                button.setAttribute('aria-expanded', 'true');
              }
            }
          }
        });
      }
    } catch (e) {
      // If it's not JSON, try to treat as single string (backward compatibility)
      if (hiddenInput.value !== '[]' && hiddenInput.value.trim()) {
        selectedAllegedNatures = [hiddenInput.value];
        const checkbox = document.querySelector(`.alleged-nature-checkbox[value="${hiddenInput.value}"]`);
        if (checkbox) {
          checkbox.checked = true;
        }
      }
    }
  }
}

function updateSelectedDisplay() {
  const selectedBadges = document.getElementById('selected_badges');
  const selectedCount = document.getElementById('selected_count');
  
  selectedCount.textContent = selectedAllegedNatures.length;
  
  if (selectedAllegedNatures.length === 0) {
    selectedBadges.innerHTML = '<small class="text-muted">No categories selected</small>';
  } else {
    selectedBadges.innerHTML = selectedAllegedNatures.map(nature => {
      // Truncate long texts for display
      const displayText = nature.length > 60 ? nature.substring(0, 57) + '...' : nature;
      return `
        <span class="badge bg-primary me-2 mb-1" style="font-size: 0.8em;">
          ${displayText}
          <button type="button" class="btn-close btn-close-white ms-1" 
                  onclick="removeAllegedNature('${nature.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                  style="font-size: 0.6em; padding: 0; margin: 0; width: 12px; height: 12px;">
          </button>
        </span>
      `;
    }).join('');
  }
}

function updateHiddenInput() {
  const hiddenInput = document.getElementById('alleged_nature_input');
  hiddenInput.value = JSON.stringify(selectedAllegedNatures);
}

function removeAllegedNature(nature) {
  selectedAllegedNatures = selectedAllegedNatures.filter(item => item !== nature);
  
  // Uncheck the corresponding checkbox
  const checkbox = document.querySelector(`.alleged-nature-checkbox[value="${nature}"]`);
  if (checkbox) {
    checkbox.checked = false;
  }
  
  updateSelectedDisplay();
  updateHiddenInput();
}

function filterAllegedNature() {
  const searchTerm = document.getElementById('alleged_nature_search').value.toLowerCase();
  const accordionItems = document.querySelectorAll('#allegedNatureAccordion .accordion-item');
  
  accordionItems.forEach(item => {
    const header = item.querySelector('.accordion-header button').textContent.toLowerCase();
    const checkboxes = item.querySelectorAll('.form-check');
    let hasVisibleCheckboxes = false;
    
    // Filter checkboxes within this accordion item
    checkboxes.forEach(checkDiv => {
      const label = checkDiv.querySelector('label').textContent.toLowerCase();
      const isMatch = header.includes(searchTerm) || label.includes(searchTerm);
      
      if (isMatch) {
        checkDiv.style.display = 'block';
        hasVisibleCheckboxes = true;
      } else {
        checkDiv.style.display = 'none';
      }
    });
    
    // Show/hide accordion item based on matches
    if (hasVisibleCheckboxes || header.includes(searchTerm)) {
      item.style.display = 'block';
      
      // Auto-expand if searching
      if (searchTerm) {
        const collapseDiv = item.querySelector('.accordion-collapse');
        const button = item.querySelector('.accordion-button');
        if (collapseDiv && button && !collapseDiv.classList.contains('show')) {
          collapseDiv.classList.add('show');
          button.classList.remove('collapsed');
          button.setAttribute('aria-expanded', 'true');
        }
      }
    } else {
      item.style.display = 'none';
    }
  });
  
  // If search is cleared, show all and collapse all
  if (!searchTerm) {
    accordionItems.forEach(item => {
      item.style.display = 'block';
      const checkboxes = item.querySelectorAll('.form-check');
      checkboxes.forEach(checkDiv => {
        checkDiv.style.display = 'block';
      });
      
      // Collapse all sections when clearing search
      const collapseDiv = item.querySelector('.accordion-collapse');
      const button = item.querySelector('.accordion-button');
      if (collapseDiv && button && collapseDiv.classList.contains('show')) {
        collapseDiv.classList.remove('show');
        button.classList.add('collapsed');
        button.setAttribute('aria-expanded', 'false');
      }
    });
  }
}

// Quick filter buttons (could be added to UI if needed)
function quickFilterAllegedNature(category) {
  document.getElementById('alleged_nature_search').value = category;
  filterAllegedNature();
}

function toggleInsuranceFields(checkbox) {
  const subjectRow = checkbox.closest('.alleged-subject-row');
  const insuranceFields = subjectRow.querySelector('.insurance-fields');
  
  if (checkbox.checked) {
    insuranceFields.style.display = 'block';
  } else {
    insuranceFields.style.display = 'none';
    // Clear the fields when unchecked
    const typeSelect = insuranceFields.querySelector('select[name="intermediary_type[]"]');
    const licenseInput = insuranceFields.querySelector('input[name="license_numbers[]"]');
    if (typeSelect) typeSelect.value = '';
    if (licenseInput) licenseInput.value = '';
  }
}

function addAllegedSubject() {
  const container = document.getElementById('alleged-subjects');
  const newRow = document.createElement('div');
  newRow.className = 'alleged-subject-row mb-3 p-3 border rounded';
  newRow.style.backgroundColor = '#f8f9fa';
  newRow.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="text-primary mb-0">üìã Alleged Subject Details</h6>
      <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
        üóëÔ∏è Remove
      </button>
    </div>
    
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">üìù English Name</label>
        <input type="text" name="alleged_subjects_en[]" class="form-control" placeholder="Enter English name">
      </div>
      <div class="col-md-6">
        <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
        <input type="text" name="alleged_subjects_cn[]" class="form-control" placeholder="Enter Chinese name">
      </div>
    </div>
    
    <div class="mb-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)">
        <label class="form-check-label">Is this an insurance intermediary?</label>
      </div>
    </div>
    
    <div class="insurance-fields" style="display: none; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
      <div class="row">
        <div class="col-6">
          <label class="form-label">License Type:</label>
          <select name="intermediary_type[]" class="form-select">
            <option value="">Select Type</option>
            <option value="Agent">Agent</option>
            <option value="Broker">Broker</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">License Number:</label>
          <input type="text" name="license_numbers[]" class="form-control" placeholder="Enter license number">
        </div>
      </div>
    </div>
    
    <p class="text-muted mt-2 mb-0">
      <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
    </p>
  `;
  container.appendChild(newRow);
  
  // Update remove button visibility
  updateRemoveButtons();
}

function removeAllegedSubject(button) {
  const container = document.getElementById('alleged-subjects');
  const rows = container.querySelectorAll('.alleged-subject-row');
  
  // Don't allow removing the last row
  if (rows.length > 1) {
    button.closest('.alleged-subject-row').remove();
    updateRemoveButtons();
  } else {
    // Clear all fields instead of removing the row
    const subjectRow = button.closest('.alleged-subject-row');
    const englishInput = subjectRow.querySelector('input[name="alleged_subjects_en[]"]');
    const chineseInput = subjectRow.querySelector('input[name="alleged_subjects_cn[]"]');
    const checkbox = subjectRow.querySelector('input[name="is_insurance_intermediary[]"]');
    const typeSelect = subjectRow.querySelector('select[name="intermediary_type[]"]');
    const licenseInput = subjectRow.querySelector('input[name="license_numbers[]"]');
    
    if (englishInput) englishInput.value = '';
    if (chineseInput) chineseInput.value = '';
    if (checkbox) {
      checkbox.checked = false;
      toggleInsuranceFields(checkbox);
    }
    if (typeSelect) typeSelect.value = '';
    if (licenseInput) licenseInput.value = '';
  }
}

function updateRemoveButtons() {
  const container = document.getElementById('alleged-subjects');
  const rows = container.querySelectorAll('.alleged-subject-row');
  
  rows.forEach((row, index) => {
    const removeBtn = row.querySelector('.remove-subject-btn');
    if (index === 0 && rows.length === 1) {
      removeBtn.style.display = 'none';
    } else {
      removeBtn.style.display = 'block';
    }
  });
}

// Function to handle attachment downloads in desktop environment
function downloadAttachment(attachmentId) {
  // Build download URL without using Flask url_for in JavaScript
  const downloadUrl = `/int_source/download_email_attachment/${attachmentId}`;
  
  // For desktop compatibility, try multiple approaches in sequence
  console.log('Attempting to download attachment:', attachmentId);
  
  // Method 1: Try fetch API with blob download (best for desktop)
  fetch(downloadUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      
      // Get filename from response headers or use default
      const contentDisposition = response.headers.get('content-disposition');
      let filename = 'attachment';
      if (contentDisposition) {
        const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
        if (filenameMatch) {
          filename = filenameMatch[1];
        }
      }
      
      return { blob: response.blob(), filename: filename };
    })
    .then(data => {
      return data.blob.then(blob => ({ blob, filename: data.filename }));
    })
    .then(({ blob, filename }) => {
      
      // Create blob URL and download
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
      console.log('Download initiated successfully');
    })
    .catch(error => {
      console.log('Fetch method failed, trying fallback:', error);
      
      // Method 2: Create temporary link (fallback)
      try {
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = '';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('Link click method attempted');
      } catch (e) {
        console.log('Link click failed, trying window.open:', e);
        
        // Method 3: Open in new window (last resort)
        try {
          window.open(downloadUrl, '_blank');
          console.log('Window.open method attempted');
        } catch (e2) {
          console.log('All download methods failed:', e2);
          alert('Download failed. Please try refreshing the page and try again.');
        }
      }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateRemoveButtons();
  
  // COMPREHENSIVE VALIDATION BYPASS - FORCE FORM SUBMISSION
  const form = document.getElementById('assessmentForm');
  const saveButton = document.getElementById('saveAssessmentBtn');
  
  if (form && saveButton) {
    console.log('Adding comprehensive validation bypass...');
    
    // Method 1: Override form submit event
    form.addEventListener('submit', function(e) {
      console.log('Form submit intercepted - bypassing all validation');
      e.preventDefault();
      e.stopPropagation();
      
      // Remove all validation attributes
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        input.removeAttribute('required');
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
      });
      
      // Force submit without validation
      form.noValidate = true;
      form.submit();
      return false;
    });
    
    // Method 2: Override button click event
    saveButton.addEventListener('click', function(e) {
      console.log('Save button clicked - forcing submission');
      e.preventDefault();
      e.stopPropagation();
      
      // Remove all validation constraints
      const allInputs = form.querySelectorAll('input, select, textarea');
      allInputs.forEach(input => {
        input.removeAttribute('required');
        input.removeAttribute('pattern');
        input.setCustomValidity('');
        input.classList.remove('is-invalid');
        
        // Clear any validation states
        if (input.checkValidity) {
          try {
            input.setCustomValidity('');
          } catch (err) {
            console.log('Validation clearing error:', err);
          }
        }
      });
      
      // Disable HTML5 validation completely
      form.noValidate = true;
      form.setAttribute('novalidate', 'novalidate');
      
      // Force form submission
      console.log('Forcing form submission...');
      form.submit();
      
      return false;
    });
    
    // Method 3: Remove validation on page load
    setTimeout(function() {
      const allElements = form.querySelectorAll('*');
      allElements.forEach(element => {
        element.removeAttribute('required');
        element.removeAttribute('pattern');
        if (element.setCustomValidity) {
          element.setCustomValidity('');
        }
      });
      form.noValidate = true;
      form.setAttribute('novalidate', 'novalidate');
      console.log('All validation attributes removed');
    }, 100);
    
    console.log('Validation bypass setup complete');
  } else {
    console.log('Form or button not found for validation bypass');
  }
  
  // AI Analysis Handler for Email Detail Page (comprehensive only)
  
  document.addEventListener('click', function(e) {
    // Comprehensive AI Analysis
    if (e.target.closest('.ai-comprehensive-detail-btn')) {
      var button = e.target.closest('.ai-comprehensive-detail-btn');
      var emailId = button.getAttribute('data-email-id');
      
      if (confirm('Run comprehensive AI analysis with attachments and detailed reasoning? This may take longer.')) {
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        
        fetch('/ai/comprehensive-analyze/' + emailId, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show comprehensive analysis results in modal
            showComprehensiveAnalysisModal(data.analysis);
            
            // ‚úÖ NEW: Update form with alleged persons data
            if (data.alleged_persons && data.alleged_persons.length > 0) {
              updateAllegedSubjectsForm(data.alleged_persons);
            }
            
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-gear"></i> AI Analysis Complete';
            button.classList.remove('btn-outline-warning');
            button.classList.add('btn-success');
            
            // Show success message
            alert('‚úÖ AI analysis complete! Found ' + (data.alleged_persons_count || 0) + ' alleged person(s).');
            
            // Also refresh to show updated basic fields
            setTimeout(function() {
              location.reload();
            }, 2000);
          } else {
            alert('Comprehensive AI analysis failed: ' + (data.message || 'Unknown error'));
          }
          button.disabled = false;
          button.innerHTML = '<i class="bi bi-gear"></i> AI Analysis';
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Network error: ' + error.message);
          button.disabled = false;
          button.innerHTML = '<i class="bi bi-gear"></i> AI Analysis';
        });
      }
    }
  });
});

// Helper function to show comprehensive analysis in modal
function showComprehensiveAnalysisModal(analysis) {
  const modalId = 'comprehensiveAnalysisModal';
  
  // Create modal if it doesn't exist
  if (!document.getElementById(modalId)) {
    const modalHTML = `
      <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="${modalId}Label">
                <i class="bi bi-robot"></i> Comprehensive AI Analysis Results
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="${modalId}Body">
              <!-- Content will be inserted here -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }
  
  // Build modal content
  let modalContent = '<div class="container-fluid">';
  
  // Summary section
  if (analysis.alleged_subject || analysis.alleged_nature || analysis.allegation_summary) {
    modalContent += `
      <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-info-circle"></i> Analysis Summary</h6>
        </div>
        <div class="card-body">
          ${analysis.alleged_subject ? `<p><strong>Alleged Subject(s):</strong> ${analysis.alleged_subject}</p>` : ''}
          ${analysis.alleged_nature ? `<p><strong>Allegation Type:</strong> ${analysis.alleged_nature}</p>` : ''}
          ${analysis.allegation_summary ? `<p><strong>Summary:</strong> ${analysis.allegation_summary}</p>` : ''}
        </div>
      </div>
    `;
  }
  
  // Reasoning section
  if (analysis.reasoning) {
    modalContent += `
      <div class="card border-info mb-3">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0"><i class="bi bi-lightbulb"></i> AI Reasoning</h6>
        </div>
        <div class="card-body">
          <p class="mb-0">${analysis.reasoning}</p>
        </div>
      </div>
    `;
  }
  
  // Scores section
  if (analysis.source_reliability || analysis.content_validity || analysis.confidence_score) {
    modalContent += `
      <div class="card border-success mb-3">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0"><i class="bi bi-graph-up"></i> Assessment Scores</h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <strong>Source Reliability:</strong> ${analysis.source_reliability || 'N/A'}/5
            </div>
            <div class="col-md-4">
              <strong>Content Validity:</strong> ${analysis.content_validity || 'N/A'}/5
            </div>
            <div class="col-md-4">
              <strong>Confidence Score:</strong> ${analysis.confidence_score ? Math.round(analysis.confidence_score * 100) + '%' : 'N/A'}
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Regulatory Impact
  if (analysis.regulatory_impact) {
    modalContent += `
      <div class="card border-danger mb-3">
        <div class="card-header bg-danger text-white">
          <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Regulatory Impact</h6>
        </div>
        <div class="card-body">
          <p class="mb-0">${analysis.regulatory_impact}</p>
        </div>
      </div>
    `;
  }
  
  // Recommended Actions
  if (analysis.recommended_actions && analysis.recommended_actions.length > 0) {
    modalContent += `
      <div class="card border-secondary mb-3">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0"><i class="bi bi-list-check"></i> Recommended Actions</h6>
        </div>
        <div class="card-body">
          <ul class="mb-0">
            ${analysis.recommended_actions.map(action => `<li>${action}</li>`).join('')}
          </ul>
        </div>
      </div>
    `;
  }
  
  // Attachment Analysis
  if (analysis.attachment_analysis) {
    modalContent += `
      <div class="card border-primary mb-3">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0"><i class="bi bi-paperclip"></i> Attachment Analysis</h6>
        </div>
        <div class="card-body">
          <p class="mb-0">${analysis.attachment_analysis}</p>
        </div>
      </div>
    `;
  }
  
  modalContent += '</div>';
  
  // Insert content and show modal
  document.getElementById(modalId + 'Body').innerHTML = modalContent;
  const modal = new bootstrap.Modal(document.getElementById(modalId));
  modal.show();
}

// Function to update alleged subjects form with AI-detected persons
function updateAllegedSubjectsForm(allegedPersons) {
  const container = document.getElementById('alleged-subjects');
  if (!container || !allegedPersons || allegedPersons.length === 0) {
    return;
  }
  
  // Clear existing rows
  container.innerHTML = '';
  
  // Add a row for each detected person
  allegedPersons.forEach((person, index) => {
    addAllegedSubjectWithData(
      person.english_name || '',
      person.chinese_name || '',
      person.is_intermediary || false,
      person.license_type || '',
      person.license_number || ''
    );
  });
  
  updateRemoveButtons();
}

// Function to add alleged subject row with pre-filled data
function addAllegedSubjectWithData(englishName, chineseName, isIntermediary, licenseType, licenseNumber) {
  const container = document.getElementById('alleged-subjects');
  const newRow = document.createElement('div');
  newRow.className = 'alleged-subject-row mb-3 p-3 border rounded';
  newRow.style.backgroundColor = '#f8f9fa';
  newRow.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="text-primary mb-0">üìã Alleged Subject Details</h6>
      <button type="button" class="btn btn-sm btn-outline-danger remove-subject-btn" onclick="removeAllegedSubject(this)">
        üóëÔ∏è Remove
      </button>
    </div>
    
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">üìù English Name</label>
        <input type="text" name="alleged_subjects_en[]" class="form-control" value="${englishName}" placeholder="Enter English name">
      </div>
      <div class="col-md-6">
        <label class="form-label">üàö Chinese Name (‰∏≠ÊñáÂßìÂêç)</label>
        <input type="text" name="alleged_subjects_cn[]" class="form-control" value="${chineseName}" placeholder="Enter Chinese name">
      </div>
    </div>
    
    <div class="mb-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="is_insurance_intermediary[]" onchange="toggleInsuranceFields(this)" ${isIntermediary ? 'checked' : ''}>
        <label class="form-check-label">Is this an insurance intermediary?</label>
      </div>
    </div>
    
    <div class="insurance-fields" style="display: ${isIntermediary ? 'block' : 'none'}; background-color: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
      <div class="row">
        <div class="col-6">
          <label class="form-label">License Type:</label>
          <select name="intermediary_type[]" class="form-select">
            <option value="">Select Type</option>
            <option value="Agent" ${licenseType === 'Agent' ? 'selected' : ''}>Agent</option>
            <option value="Broker" ${licenseType === 'Broker' ? 'selected' : ''}>Broker</option>
            <option value="Other" ${licenseType === 'Other' ? 'selected' : ''}>Other</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">License Number:</label>
          <input type="text" name="license_numbers[]" class="form-control" value="${licenseNumber}" placeholder="Enter license number">
        </div>
      </div>
    </div>
    
    <p class="text-muted mt-2 mb-0">
      <i class="bi bi-info-circle"></i> You can enter both English and Chinese names for the same person
    </p>
  `;
  container.appendChild(newRow);
}

// ========================================
// INT REFERENCE AUTO-SUGGESTION FEATURES
// ========================================

// Load all INT references on page load for autocomplete
document.addEventListener('DOMContentLoaded', function() {
  loadIntReferences();
});

// Load existing INT references for autocomplete
function loadIntReferences() {
  fetch('/api/int_references/list')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const datalist = document.getElementById('int_reference_suggestions');
        datalist.innerHTML = '';
        
        data.int_references.forEach(ref => {
          const option = document.createElement('option');
          option.value = ref.int_reference;
          option.text = `${ref.int_reference} - ${ref.description} (${ref.total_sources} sources)`;
          datalist.appendChild(option);
        });
      }
    })
    .catch(error => console.error('Error loading INT references:', error));
}

// Get next available INT number
document.getElementById('btn_next_int').addEventListener('click', function() {
  fetch('/api/int_references/next_available')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('int_reference_input').value = data.next_int_reference;
        alert(`Next available INT reference: ${data.next_int_reference}`);
      } else {
        alert('Error getting next INT reference');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error getting next INT reference');
    });
});

// Search existing INT references
document.getElementById('btn_search_int').addEventListener('click', function() {
  const query = prompt('Search INT references by person name, nature, or keyword:');
  if (!query) return;
  
  fetch(`/api/int_references/search?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const resultsDiv = document.getElementById('int_search_results');
        resultsDiv.innerHTML = '';
        
        if (data.results.length === 0) {
          resultsDiv.innerHTML = `
            <div class="list-group-item">
              <i class="fas fa-info-circle"></i> No matching INT references found for "${data.query}"
            </div>
          `;
        } else {
          data.results.forEach(result => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${result.int_reference}</h6>
                <small>${result.date_created}</small>
              </div>
              <p class="mb-1">${result.match_reason}</p>
              <small>Total sources: ${result.total_sources}</small>
            `;
            item.addEventListener('click', function(e) {
              e.preventDefault();
              document.getElementById('int_reference_input').value = result.int_reference;
              resultsDiv.style.display = 'none';
            });
            resultsDiv.appendChild(item);
          });
        }
        
        resultsDiv.style.display = 'block';
      } else {
        alert('Error searching INT references');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error searching INT references');
    });
});

// Hide search results when clicking outside
document.addEventListener('click', function(event) {
  const resultsDiv = document.getElementById('int_search_results');
  const searchBtn = document.getElementById('btn_search_int');
  const inputField = document.getElementById('int_reference_input');
  
  if (!resultsDiv.contains(event.target) && 
      event.target !== searchBtn && 
      event.target !== inputField) {
    resultsDiv.style.display = 'none';
  }
});

</script>

{% endblock %}
