{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="card shadow-sm rounded">
    <div class="card-header d-flex justify-content-between align-items-center" style="background: #1669d2; color: #fff;">
      <div>
        <h5 class="mb-0">{{ email.subject or "(No Subject)" }}</h5>
        <small>From: {{ email.sender }} | Received: {% if email.received %}{{ email.received if email.received is string else email.received.strftime('%d %B %Y, %I:%M %p') }}{% else %}N/A{% endif %}</small>
      </div>
      <div>
        <a href="{{ url_for('int_source') }}" class="btn btn-light btn-sm">
          <i class="fas fa-arrow-left"></i> Back to INT Source
        </a>
      </div>
    </div>
    <div class="card-body">

      <!-- Email Content -->
      {% if thread_blocks %}
        {% for block in thread_blocks %}
          <details class="mb-3" {% if loop.first %}open{% endif %}>
            <summary class="fw-bold text-primary mb-2" style="cursor: pointer;">
              {% if block.meta.type == 'current' %}
                üìß Current Email
              {% elif block.meta.type == 'thread' %}
                üìú Previous Email Thread
              {% else %}
                üìß Email Content
              {% endif %}
            </summary>
            <div class="email-body-enhanced" style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #1669d2; margin: 10px 0;">
              {% if block.content %}
                {{ block.content | safe }}
              {% else %}
                <em class="text-muted">No content available</em>
              {% endif %}
            </div>
          </details>
        {% endfor %}
      {% else %}
        <div class="email-body-enhanced" style="padding: 15px; background-color: #f8f9fa; border-left: 4px solid #1669d2; margin: 10px 0;">
          {% if email.body %}
            {{ email.body | safe }}
          {% else %}
            <em class="text-muted">No content available</em>
          {% endif %}
        </div>
      {% endif %}

      <!-- Attachments -->
      {% if attachments %}
        <div class="mb-3">
          <b>Attachments:</b>
          <div class="mt-2">
            {% for att in attachments %}
              <div class="d-flex align-items-center mb-2 p-2 border rounded bg-light">
                <div class="flex-grow-1">
                  <i class="bi bi-paperclip me-2"></i>
                  <strong>{{ att.filename }}</strong>
                </div>
                <div class="btn-group" role="group">
                  <a href="{{ url_for('int_source_embedded_attachment_viewer', att_id=att.id) }}" 
                     class="btn btn-sm btn-outline-primary" 
                     title="View attachment">
                    <i class="bi bi-eye"></i> View
                  </a>
                  <a href="{{ url_for('int_source_download_email_attachment', att_id=att.id) }}" 
                     class="btn btn-sm btn-outline-secondary" 
                     download
                     title="Download attachment">
                    <i class="bi bi-download"></i> Download
                  </a>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      <!-- Assessment Form -->
      <form method="POST" action="{{ url_for('int_source_update_assessment', email_id=email.id) }}" class="mt-4">
        <h6 class="text-primary mb-3">Assessment Details</h6>
        <table class="table table-bordered align-middle" style="max-width:800px;margin:auto;">
          <tr>
            <td><b>Date:</b></td>
            <td>{{ (email.assessment_updated_at or "")|strftime("%Y-%m-%d %H:%M:%S") }}</td>
          </tr>
          <tr>
            <td><b>Preparer:</b></td>
            <td>
              <select name="preparer" class="form-select">
                <option value="">Select Preparer...</option>
                <option value="Nicola" {% if email.preparer == 'Nicola' %}selected{% endif %}>Nicola</option>
                <option value="Erney" {% if email.preparer == 'Erney' %}selected{% endif %}>Erney</option>
                <option value="Alex" {% if email.preparer == 'Alex' %}selected{% endif %}>Alex</option>
                <option value="Queenie" {% if email.preparer == 'Queenie' %}selected{% endif %}>Queenie</option>
                <option value="Charlie" {% if email.preparer == 'Charlie' %}selected{% endif %}>Charlie</option>
                <option value="Eunice" {% if email.preparer == 'Eunice' %}selected{% endif %}>Eunice</option>
                <option value="Marcus" {% if email.preparer == 'Marcus' %}selected{% endif %}>Marcus</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><b>Alleged Subject(s)</b></td>
            <td>
              <div class="mb-3">
                <label class="form-label">üìù English Names (separate with commas)</label>
                <input type="text" name="alleged_subjects_en" class="form-control" 
                       value="{{ email.alleged_subject_english or '' }}" 
                       placeholder="Enter English names separated by commas">
              </div>
              <div class="mb-3">
                <label class="form-label">üàö Chinese Names (separate with commas)</label>
                <input type="text" name="alleged_subjects_cn" class="form-control" 
                       value="{{ email.alleged_subject_chinese or '' }}"
                       placeholder="Enter Chinese names separated by commas">
              </div>
            </td>
          </tr>
          <tr>
            <td><b>Alleged Nature</b></td>
            <td>
              <textarea name="alleged_nature" class="form-control" rows="2" placeholder="Enter allegation type/nature...">{{ email.alleged_nature or '' }}</textarea>
            </td>
          </tr>
          <tr>
            <td><b>Allegation Summary</b></td>
            <td>
              <textarea name="allegation_summary" class="form-control" rows="4" placeholder="Enter detailed description of the allegation/complaint...">{{ email.allegation_summary or '' }}</textarea>
            </td>
          </tr>
          <tr>
            <td><b>Source Reliability</b></td>
            <td>
              <select name="source_reliability" class="form-select">
                <option value="">Select...</option>
                <option value="5" {% if email.source_reliability == 5 %}selected{% endif %}>5 - Completely Reliable</option>
                <option value="4" {% if email.source_reliability == 4 %}selected{% endif %}>4 - Usually Reliable</option>
                <option value="3" {% if email.source_reliability == 3 %}selected{% endif %}>3 - Fairly Reliable</option>
                <option value="2" {% if email.source_reliability == 2 %}selected{% endif %}>2 - Not Usually Reliable</option>
                <option value="1" {% if email.source_reliability == 1 %}selected{% endif %}>1 - Unreliable</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><b>Content Validity</b></td>
            <td>
              <select name="content_validity" class="form-select">
                <option value="">Select...</option>
                <option value="5" {% if email.content_validity == 5 %}selected{% endif %}>5 - Confirmed True</option>
                <option value="4" {% if email.content_validity == 4 %}selected{% endif %}>4 - Probably True</option>
                <option value="3" {% if email.content_validity == 3 %}selected{% endif %}>3 - Doubtfully True</option>
                <option value="2" {% if email.content_validity == 2 %}selected{% endif %}>2 - Probably False</option>
                <option value="1" {% if email.content_validity == 1 %}selected{% endif %}>1 - Confirmed False</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><b>Combined Score</b></td>
            <td>
              {% set combined_score = (email.source_reliability or 0) + (email.content_validity or 0) %}
              <span class="fw-bold">{{ combined_score }}</span>
              
              {% if combined_score >= 8 and email.reviewer_decision == 'agree' %}
                <span class="badge bg-success ms-2">
                  <i class="fas fa-check-circle"></i> Case Opened
                </span>
              {% elif email.reviewer_decision == 'disagree' %}
                <span class="badge bg-danger ms-2">
                  <i class="fas fa-times-circle"></i> Disagreed
                </span>
              {% else %}
                <span class="badge bg-secondary ms-2">
                  <i class="fas fa-info-circle"></i> Unsubstantial
                </span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td><b>Reviewer</b></td>
            <td>
              <input type="text" name="reviewer_name" value="{{ email.reviewer_name or '' }}" class="form-control" placeholder="Enter reviewer name">
            </td>
          </tr>
          <tr>
            <td><b>Reviewer Comment</b></td>
            <td>
              <textarea name="reviewer_comment" class="form-control" rows="2" placeholder="e.g. Agree with the score, or provide reasoning">{{ email.reviewer_comment or '' }}</textarea>
            </td>
          </tr>
          <tr>
            <td><b>Reviewer Decision</b></td>
            <td>
              <select name="reviewer_decision" class="form-select">
                <option value="">Select Decision...</option>
                <option value="agree" {% if email.reviewer_decision == 'agree' %}selected{% endif %}>[AGREE] Agree</option>
                <option value="disagree" {% if email.reviewer_decision == 'disagree' %}selected{% endif %}>[DISAGREE] Disagree</option>
              </select>
            </td>
          </tr>
          <tr>
            <td colspan="2" class="text-end">
              <button type="submit" class="btn btn-primary">Save Assessment</button>
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>
</div>

<style>
.email-body-enhanced {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}
</style>

{% endblock %}
